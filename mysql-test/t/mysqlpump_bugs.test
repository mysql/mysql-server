--echo #
--echo # Bug#23102944: MYSQLPUMP LEAKS MEMORY IN CASE OF ERRORS.
--echo #

--echo # testing a failed connection: must not crash
--replace_regex /\([0-9]*\) while connecting/(errno) while connecting/
--exec $MYSQL_PUMP --host=non_existent_ghost --add-locks 2>&1
--echo # testing an invalid option: must not crash
--replace_regex /\([0-9]*\) while connecting/(errno) while connecting/
--exec $MYSQL_PUMP --host=non_existent_ghost --parallelism=3 2>&1

--echo #
--echo # Bug#29389828: CRASH WHEN TILDE EXPANSION USED IN --RESULT-FILE PATH
--echo #

--echo # report error when tilde is used in file name
--error 2
--exec $MYSQL_PUMP --result-file=~/dump.sql


--echo #
--echo # Bug #29343073: MYSQLPUMP DUMPS GRANT TABLES THAT IT SHOULD NOT
--echo #

--exec $MYSQL_PUMP --skip-dump-rows --exclude-tables=ndb_binlog_index mysql > $MYSQLTEST_VARDIR/tmp/bug29343073.sql

--let $assert_text=Should not contain mysql.role_edges
--let $assert_file=$MYSQLTEST_VARDIR/tmp/bug29343073.sql
--let $assert_select=CREATE TABLE `mysql`.`role_edges`
--let $assert_count=0
--source include/assert_grep.inc

--let $assert_text=Should not contain mysql.global_grants
--let $assert_file=$MYSQLTEST_VARDIR/tmp/bug29343073.sql
--let $assert_select=CREATE TABLE `mysql`.`mysql_global_grants`
--let $assert_count=0
--source include/assert_grep.inc

--let $assert_text=Should not contain mysql.default_roles
--let $assert_file=$MYSQLTEST_VARDIR/tmp/bug29343073.sql
--let $assert_select=CREATE TABLE `mysql`.`default_roles`
--let $assert_count=0
--source include/assert_grep.inc

--let $assert_text=Should contain mysql.password_history
--let $assert_file=$MYSQLTEST_VARDIR/tmp/bug29343073.sql
--let $assert_select=CREATE TABLE `mysql`.`password_history`
--let $assert_count=1
--source include/assert_grep.inc

--echo Test: dump of mysql database should not contain unexpected tables
--let $grep_file=$MYSQLTEST_VARDIR/tmp/bug29343073.sql
--let $grep_pattern=CREATE TABLE
--source include/grep_pattern.inc

--remove_file $MYSQLTEST_VARDIR/tmp/bug29343073.sql

--echo #
--echo # Bug #83144: mysqlpump reads mysql_dump group, not mysqlpump in config-group
--echo #

--write_file $MYSQLTEST_VARDIR/tmp/bug83144.cnf
[mysqlpump]
exclude_databases=db1,mysql,mtr
EOF

CREATE DATABASE db1;
CREATE DATABASE db2;

--exec $MYSQLPUMP --defaults-extra-file=$MYSQLTEST_VARDIR/tmp/bug83144.cnf --host=127.0.0.1 -S $MASTER_MYSOCK -P $MASTER_MYPORT -uroot > $MYSQLTEST_VARDIR/tmp/bug83144.dump

DROP DATABASE db1;
DROP DATABASE db2;

--exec $MYSQL < $MYSQLTEST_VARDIR/tmp/bug83144.dump

SHOW DATABASES like 'db%';

#cleanup
DROP DATABASE db2;
--remove_file $MYSQLTEST_VARDIR/tmp/bug83144.cnf
--remove_file $MYSQLTEST_VARDIR/tmp/bug83144.dump


--echo #
--echo # Bug #32067013: MYSQLPUMP SEGMENTATION FAULT
--echo #

CREATE DATABASE B32067013;
CREATE TABLE B32067013.t1(v1 INT, v2 INT);
CREATE TABLE B32067013.t2(v1 INT, v2 INT);
CREATE VIEW B32067013.t123 AS SELECT * FROM B32067013.t1;
DROP TABLE B32067013.t1;

--echo # Test criteria: shouldn't crash
--error 76
--exec $MYSQL_PUMP --all-databases > $MYSQLTEST_VARDIR/tmp/bug32067013.dump 2>&1

#cleanup
DROP DATABASE B32067013;
--remove_file $MYSQLTEST_VARDIR/tmp/bug32067013.dump


--echo # End of 8.0 tests
