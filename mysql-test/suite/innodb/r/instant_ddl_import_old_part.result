# ------------------------------------------------------------
# Exported table t1 (in older version) having
#     c1 INT, c2 INT, c3 INT, c4 TEXT normal columns
#     c5 char(20) INSTANT ADD column with default def_c5.
#       +------+------+------+---------+--------+
#       | c1   | c2   | c3   | c4      | c5     |
#       +------+------+------+---------+--------+
#       |    1 |    2 |    3 | abcdefg | c5_def |
#       |  100 |  200 |  300 | qwerty  | c5_def |
#       |  200 |  300 |  400 | asdfg   | c5_def |
#       |  300 |  400 |  500 | xxxxxx  | r4c5   |
#       +------+------+------+---------+--------+
# ------------------------------------------------------------
# Copy and unzip the ibd/cfg files.
# listing MYSQL_TMP_DIR/old_instant_part_comp
t1#p#p0.cfg
t1#p#p0.ibd
t1#p#p1.cfg
t1#p#p1.ibd
t1#p#p2.cfg
t1#p#p2.ibd
t1#p#p3.cfg
t1#p#p3.ibd
# ------------------------------------------------------------
# Scenario 1 : No INSTANT ADD/DROP Columns in target table
# ------------------------------------------------------------
CREATE TABLE t1 (c1 INT, c2 INT, c3 INT, c4 TEXT, c5 char(20)) row_format=compact
PARTITION BY RANGE(c1 * 2)
(PARTITION p0 VALUES LESS THAN (128),
PARTITION p1 VALUES LESS THAN (256),
PARTITION p2 VALUES LESS THAN (384),
PARTITION p3 VALUES LESS THAN MAXVALUE);
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS
test/t1#p#p0	8	0	0
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT
c1	0	6	1027	0
c2	1	6	1027	0
c3	2	6	1027	0
c4	3	5	16711932	0
c5	4	13	16711934	0
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS
test/t1#p#p1	8	0	0
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT
c1	0	6	1027	0
c2	1	6	1027	0
c3	2	6	1027	0
c4	3	5	16711932	0
c5	4	13	16711934	0
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS
test/t1#p#p2	8	0	0
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT
c1	0	6	1027	0
c2	1	6	1027	0
c3	2	6	1027	0
c4	3	5	16711932	0
c5	4	13	16711934	0
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS
test/t1#p#p3	8	0	0
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT
c1	0	6	1027	0
c2	1	6	1027	0
c3	2	6	1027	0
c4	3	5	16711932	0
c5	4	13	16711934	0
# IMPORT
ALTER TABLE t1 discard tablespace;
ALTER TABLE t1 IMPORT TABLESPACE;
SELECT * FROM t1 ORDER BY c1;
c1	c2	c3	c4	c5
1	2	3	abcdefg	c5_def
100	200	300	qwerty	c5_def
200	300	400	asdfg	c5_def
300	400	500	xxxxxx	r4c5
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS
test/t1#p#p0	8	4	0
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT
c1	0	6	1027	0
c2	1	6	1027	0
c3	2	6	1027	0
c4	3	5	16711932	0
c5	4	13	16711934	1
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS
test/t1#p#p1	8	4	0
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT
c1	0	6	1027	0
c2	1	6	1027	0
c3	2	6	1027	0
c4	3	5	16711932	0
c5	4	13	16711934	1
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS
test/t1#p#p2	8	4	0
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT
c1	0	6	1027	0
c2	1	6	1027	0
c3	2	6	1027	0
c4	3	5	16711932	0
c5	4	13	16711934	1
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS
test/t1#p#p3	8	4	0
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT
c1	0	6	1027	0
c2	1	6	1027	0
c3	2	6	1027	0
c4	3	5	16711932	0
c5	4	13	16711934	1
# Cleanup
DROP TABLE t1;
# ------------------------------------------------------------
# Scenario 2 : No INSTANT ADD/DROP. Column mismatch
# ------------------------------------------------------------
CREATE TABLE t1 (c1 INT, c2 INT, c3 INT, c4 TEXT, c5 char(10)) row_format=compact
PARTITION BY RANGE(c1 * 2)
(PARTITION p0 VALUES LESS THAN (128),
PARTITION p1 VALUES LESS THAN (256),
PARTITION p2 VALUES LESS THAN (384),
PARTITION p3 VALUES LESS THAN MAXVALUE);
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS
test/t1#p#p0	8	0	0
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT
c1	0	6	1027	0
c2	1	6	1027	0
c3	2	6	1027	0
c4	3	5	16711932	0
c5	4	13	16711934	0
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS
test/t1#p#p1	8	0	0
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT
c1	0	6	1027	0
c2	1	6	1027	0
c3	2	6	1027	0
c4	3	5	16711932	0
c5	4	13	16711934	0
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS
test/t1#p#p2	8	0	0
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT
c1	0	6	1027	0
c2	1	6	1027	0
c3	2	6	1027	0
c4	3	5	16711932	0
c5	4	13	16711934	0
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS
test/t1#p#p3	8	0	0
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT
c1	0	6	1027	0
c2	1	6	1027	0
c3	2	6	1027	0
c4	3	5	16711932	0
c5	4	13	16711934	0
# IMPORT
ALTER TABLE t1 discard tablespace;
ALTER TABLE t1 IMPORT TABLESPACE;
ERROR HY000: Schema mismatch (Column c5 length mismatch.)
# Cleanup
DROP TABLE t1;
# ------------------------------------------------------------
# Scenario 3 : INSTANT ADD/DROP Columns in target table
# ------------------------------------------------------------
CREATE TABLE t1 (c1 INT, c2 INT, c3 INT, c4 TEXT) row_format=compact
PARTITION BY RANGE(c1 * 2)
(PARTITION p0 VALUES LESS THAN (128),
PARTITION p1 VALUES LESS THAN (256),
PARTITION p2 VALUES LESS THAN (384),
PARTITION p3 VALUES LESS THAN MAXVALUE);
ALTER TABLE t1 ADD COLUMN c5 char(20) DEFAULT "c5_def";
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS
test/t1#p#p0	8	0	1
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT
c1	0	6	1027	0
c2	1	6	1027	0
c3	2	6	1027	0
c4	3	5	16711932	0
c5	4	13	16711934	1
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS
test/t1#p#p1	8	0	1
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT
c1	0	6	1027	0
c2	1	6	1027	0
c3	2	6	1027	0
c4	3	5	16711932	0
c5	4	13	16711934	1
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS
test/t1#p#p2	8	0	1
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT
c1	0	6	1027	0
c2	1	6	1027	0
c3	2	6	1027	0
c4	3	5	16711932	0
c5	4	13	16711934	1
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS
test/t1#p#p3	8	0	1
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT
c1	0	6	1027	0
c2	1	6	1027	0
c3	2	6	1027	0
c4	3	5	16711932	0
c5	4	13	16711934	1
# IMPORT
ALTER TABLE t1 discard tablespace;
ALTER TABLE t1 IMPORT TABLESPACE;
ERROR HY000: Schema mismatch (Target table has INSTANT columns but the .cfg file is from earlier release with INSTANT column in the source table. Instant metadata can't match. Please create target table with no INSTANT column and try IMPORT.)
# Cleanup
DROP TABLE t1;
# ------------------------------------------------------------
# Scenario 4 : INSTANT ADD/DROP. Column mismatch
# ------------------------------------------------------------
CREATE TABLE t1 (c1 INT, c2 INT, c3 INT, c4 TEXT) row_format=compact
PARTITION BY RANGE(c1 * 2)
(PARTITION p0 VALUES LESS THAN (128),
PARTITION p1 VALUES LESS THAN (256),
PARTITION p2 VALUES LESS THAN (384),
PARTITION p3 VALUES LESS THAN MAXVALUE);
ALTER TABLE t1 ADD COLUMN c5 char(10) DEFAULT "c5_def";
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS
test/t1#p#p0	8	0	1
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT
c1	0	6	1027	0
c2	1	6	1027	0
c3	2	6	1027	0
c4	3	5	16711932	0
c5	4	13	16711934	1
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS
test/t1#p#p1	8	0	1
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT
c1	0	6	1027	0
c2	1	6	1027	0
c3	2	6	1027	0
c4	3	5	16711932	0
c5	4	13	16711934	1
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS
test/t1#p#p2	8	0	1
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT
c1	0	6	1027	0
c2	1	6	1027	0
c3	2	6	1027	0
c4	3	5	16711932	0
c5	4	13	16711934	1
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS
test/t1#p#p3	8	0	1
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT
c1	0	6	1027	0
c2	1	6	1027	0
c3	2	6	1027	0
c4	3	5	16711932	0
c5	4	13	16711934	1
# IMPORT
ALTER TABLE t1 discard tablespace;
ALTER TABLE t1 IMPORT TABLESPACE;
ERROR HY000: Schema mismatch (Column c5 length mismatch.)
# Cleanup
DROP TABLE t1;
# ------------------------------------------------------------
# Scenario 5 : INSTANT ADD/DROP. Default value mismatch
# ------------------------------------------------------------
CREATE TABLE t1 (c1 INT, c2 INT, c3 INT, c4 TEXT) row_format=compact
PARTITION BY RANGE(c1 * 2)
(PARTITION p0 VALUES LESS THAN (128),
PARTITION p1 VALUES LESS THAN (256),
PARTITION p2 VALUES LESS THAN (384),
PARTITION p3 VALUES LESS THAN MAXVALUE);
ALTER TABLE t1 ADD COLUMN c5 char(20) DEFAULT "def_c5";
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS
test/t1#p#p0	8	0	1
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT
c1	0	6	1027	0
c2	1	6	1027	0
c3	2	6	1027	0
c4	3	5	16711932	0
c5	4	13	16711934	1
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS
test/t1#p#p1	8	0	1
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT
c1	0	6	1027	0
c2	1	6	1027	0
c3	2	6	1027	0
c4	3	5	16711932	0
c5	4	13	16711934	1
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS
test/t1#p#p2	8	0	1
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT
c1	0	6	1027	0
c2	1	6	1027	0
c3	2	6	1027	0
c4	3	5	16711932	0
c5	4	13	16711934	1
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS
test/t1#p#p3	8	0	1
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT
c1	0	6	1027	0
c2	1	6	1027	0
c3	2	6	1027	0
c4	3	5	16711932	0
c5	4	13	16711934	1
# IMPORT
ALTER TABLE t1 discard tablespace;
ALTER TABLE t1 IMPORT TABLESPACE;
ERROR HY000: Schema mismatch (Target table has INSTANT columns but the .cfg file is from earlier release with INSTANT column in the source table. Instant metadata can't match. Please create target table with no INSTANT column and try IMPORT.)
# Cleanup
DROP TABLE t1;
# --------------------------------------------------------------
# Scenario 6 : Table with INSTANT ADD and reorganized partitions
# --------------------------------------------------------------
# Copy and unzip the ibd/cfg files.
# listing MYSQL_TMP_DIR/old_instant_reorg_part_comp
t1#p#p0.cfg
t1#p#p0.ibd
t1#p#p1_1.cfg
t1#p#p1_1.ibd
t1#p#p1_2.cfg
t1#p#p1_2.ibd
t1#p#p2.cfg
t1#p#p2.ibd
CREATE TABLE t1 (id INT NOT NULL AUTO_INCREMENT KEY, c1 char(10), c2 char(10), c3 char(10)) 
PARTITION BY RANGE(id) (
PARTITION p0 VALUES LESS THAN (100),
PARTITION p1_1 VALUES LESS THAN (150),
PARTITION p1_2 VALUES LESS THAN (200),
PARTITION p2 VALUES LESS THAN MAXVALUE);
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS
test/t1#p#p0	7	0	0
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT
id	0	6	1283	0
c1	1	13	16711934	0
c2	2	13	16711934	0
c3	3	13	16711934	0
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS
test/t1#p#p1_1	7	0	0
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT
id	0	6	1283	0
c1	1	13	16711934	0
c2	2	13	16711934	0
c3	3	13	16711934	0
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS
test/t1#p#p1_2	7	0	0
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT
id	0	6	1283	0
c1	1	13	16711934	0
c2	2	13	16711934	0
c3	3	13	16711934	0
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS
test/t1#p#p2	7	0	0
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT
id	0	6	1283	0
c1	1	13	16711934	0
c2	2	13	16711934	0
c3	3	13	16711934	0
# IMPORT
ALTER TABLE t1 discard tablespace;
ALTER TABLE t1 IMPORT TABLESPACE;
SELECT * FROM t1 ORDER BY c1;
id	c1	c2	c3
1	r1c1	r1c2	c3_def
2	r2c1	r2c2	r2c3
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS
test/t1#p#p0	7	3	0
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT
id	0	6	1283	0
c1	1	13	16711934	0
c2	2	13	16711934	0
c3	3	13	16711934	1
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS
test/t1#p#p1_1	7	0	0
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT
id	0	6	1283	0
c1	1	13	16711934	0
c2	2	13	16711934	0
c3	3	13	16711934	0
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS
test/t1#p#p1_2	7	0	0
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT
id	0	6	1283	0
c1	1	13	16711934	0
c2	2	13	16711934	0
c3	3	13	16711934	0
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS
test/t1#p#p2	7	3	0
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT
id	0	6	1283	0
c1	1	13	16711934	0
c2	2	13	16711934	0
c3	3	13	16711934	1
# Cleanup
DROP TABLE t1;
###########
# CLEANUP #
###########
