# ------------------------------------------------------------
# Exported table t1 (in older version) having
#     c1 INT, c2 INT, c3 INT, c4 TEXT normal columns
#     c5 char(20) INSTANT ADD column with default def_c5.
#       +------+------+------+---------+--------+
#       | c1   | c2   | c3   | c4      | c5     |
#       +------+------+------+---------+--------+
#       |    1 |    2 |    3 | abcdefg | c5_def |
#       |  100 |  200 |  300 | qwerty  | c5_def |
#       |  200 |  300 |  400 | asdfg   | c5_def |
#       |  300 |  400 |  500 | xxxxxx  | r4c5   |
#       +------+------+------+---------+--------+
# ------------------------------------------------------------
# Copy and unzip the ibd/cfg files.
# listing MYSQL_TMP_DIR/old_instant_part_comp
t1#p#p0.cfg
t1#p#p0.ibd
t1#p#p1.cfg
t1#p#p1.ibd
t1#p#p2.cfg
t1#p#p2.ibd
t1#p#p3.cfg
t1#p#p3.ibd
# ------------------------------------------------------------
# Scenario 1 : No INSTANT ADD/DROP Columns in target table
# ------------------------------------------------------------
CREATE TABLE t1 (c1 INT, c2 INT, c3 INT, c4 TEXT, c5 char(20)) row_format=compact
PARTITION BY RANGE(c1 * 2)
(PARTITION p0 VALUES LESS THAN (128),
PARTITION p1 VALUES LESS THAN (256),
PARTITION p2 VALUES LESS THAN (384),
PARTITION p3 VALUES LESS THAN MAXVALUE);
# DD Metadata of columns in table
NAME	ORDINAL_POSITION	TYPE	HAS_NO_DEFAULT	HIDDEN	SE_PRIVATE_DATA
c1	1	MYSQL_TYPE_LONG	0	Visible	table_id=TABLE_ID;
c2	2	MYSQL_TYPE_LONG	0	Visible	table_id=TABLE_ID;
c3	3	MYSQL_TYPE_LONG	0	Visible	table_id=TABLE_ID;
c4	4	MYSQL_TYPE_BLOB	0	Visible	table_id=TABLE_ID;
c5	5	MYSQL_TYPE_STRING	0	Visible	table_id=TABLE_ID;
DB_ROW_ID	6	MYSQL_TYPE_INT24	0	SE	table_id=TABLE_ID;
DB_TRX_ID	7	MYSQL_TYPE_INT24	0	SE	table_id=TABLE_ID;
DB_ROLL_PTR	8	MYSQL_TYPE_LONGLONG	0	SE	table_id=TABLE_ID;
# DD Metadata of partitions in table
NAME	DESCRIPTION_UTF8	SE_PRIVATE_DATA
p0	128	NULL
p1	256	NULL
p2	384	NULL
p3	MAXVALUE	NULL
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS	INITIAL_COLUMN_COUNTS	CURRENT_COLUMN_COUNTS	TOTAL_COLUMN_COUNTS
test/t1#p#p0	8	0	0	5	5	5
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT	VERSION_ADDED	VERSION_DROPPED
c1	0	6	1027	0	0	0
c2	1	6	1027	0	0	0
c3	2	6	1027	0	0	0
c4	3	5	16711932	0	0	0
c5	4	13	16711934	0	0	0
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS	INITIAL_COLUMN_COUNTS	CURRENT_COLUMN_COUNTS	TOTAL_COLUMN_COUNTS
test/t1#p#p1	8	0	0	5	5	5
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT	VERSION_ADDED	VERSION_DROPPED
c1	0	6	1027	0	0	0
c2	1	6	1027	0	0	0
c3	2	6	1027	0	0	0
c4	3	5	16711932	0	0	0
c5	4	13	16711934	0	0	0
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS	INITIAL_COLUMN_COUNTS	CURRENT_COLUMN_COUNTS	TOTAL_COLUMN_COUNTS
test/t1#p#p2	8	0	0	5	5	5
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT	VERSION_ADDED	VERSION_DROPPED
c1	0	6	1027	0	0	0
c2	1	6	1027	0	0	0
c3	2	6	1027	0	0	0
c4	3	5	16711932	0	0	0
c5	4	13	16711934	0	0	0
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS	INITIAL_COLUMN_COUNTS	CURRENT_COLUMN_COUNTS	TOTAL_COLUMN_COUNTS
test/t1#p#p3	8	0	0	5	5	5
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT	VERSION_ADDED	VERSION_DROPPED
c1	0	6	1027	0	0	0
c2	1	6	1027	0	0	0
c3	2	6	1027	0	0	0
c4	3	5	16711932	0	0	0
c5	4	13	16711934	0	0	0
# IMPORT
ALTER TABLE t1 discard tablespace;
ALTER TABLE t1 IMPORT TABLESPACE;
SELECT * FROM t1 ORDER BY c1;
c1	c2	c3	c4	c5
1	2	3	abcdefg	c5_def
100	200	300	qwerty	c5_def
200	300	400	asdfg	c5_def
300	400	500	xxxxxx	r4c5
# DD Metadata of columns in table
NAME	ORDINAL_POSITION	TYPE	HAS_NO_DEFAULT	HIDDEN	SE_PRIVATE_DATA
c1	1	MYSQL_TYPE_LONG	0	Visible	table_id=TABLE_ID;
c2	2	MYSQL_TYPE_LONG	0	Visible	table_id=TABLE_ID;
c3	3	MYSQL_TYPE_LONG	0	Visible	table_id=TABLE_ID;
c4	4	MYSQL_TYPE_BLOB	0	Visible	table_id=TABLE_ID;
c5	5	MYSQL_TYPE_STRING	0	Visible	default=63355f6465662020202020202020202020202020;table_id=TABLE_ID;
DB_ROW_ID	6	MYSQL_TYPE_INT24	0	SE	table_id=TABLE_ID;
DB_TRX_ID	7	MYSQL_TYPE_INT24	0	SE	table_id=TABLE_ID;
DB_ROLL_PTR	8	MYSQL_TYPE_LONGLONG	0	SE	table_id=TABLE_ID;
# DD Metadata of partitions in table
NAME	DESCRIPTION_UTF8	SE_PRIVATE_DATA
p0	128	discard=0;instant_col=4;
p1	256	discard=0;instant_col=4;
p2	384	discard=0;instant_col=4;
p3	MAXVALUE	discard=0;instant_col=4;
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS	INITIAL_COLUMN_COUNTS	CURRENT_COLUMN_COUNTS	TOTAL_COLUMN_COUNTS
test/t1#p#p0	8	4	0	5	5	5
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT	VERSION_ADDED	VERSION_DROPPED
c1	0	6	1027	0	0	0
c2	1	6	1027	0	0	0
c3	2	6	1027	0	0	0
c4	3	5	16711932	0	0	0
c5	4	13	16711934	1	0	0
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS	INITIAL_COLUMN_COUNTS	CURRENT_COLUMN_COUNTS	TOTAL_COLUMN_COUNTS
test/t1#p#p1	8	4	0	5	5	5
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT	VERSION_ADDED	VERSION_DROPPED
c1	0	6	1027	0	0	0
c2	1	6	1027	0	0	0
c3	2	6	1027	0	0	0
c4	3	5	16711932	0	0	0
c5	4	13	16711934	1	0	0
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS	INITIAL_COLUMN_COUNTS	CURRENT_COLUMN_COUNTS	TOTAL_COLUMN_COUNTS
test/t1#p#p2	8	4	0	5	5	5
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT	VERSION_ADDED	VERSION_DROPPED
c1	0	6	1027	0	0	0
c2	1	6	1027	0	0	0
c3	2	6	1027	0	0	0
c4	3	5	16711932	0	0	0
c5	4	13	16711934	1	0	0
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS	INITIAL_COLUMN_COUNTS	CURRENT_COLUMN_COUNTS	TOTAL_COLUMN_COUNTS
test/t1#p#p3	8	4	0	5	5	5
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT	VERSION_ADDED	VERSION_DROPPED
c1	0	6	1027	0	0	0
c2	1	6	1027	0	0	0
c3	2	6	1027	0	0	0
c4	3	5	16711932	0	0	0
c5	4	13	16711934	1	0	0
# Cleanup
DROP TABLE t1;
# ------------------------------------------------------------
# Scenario 2 : No INSTANT ADD/DROP. Column mismatch
# ------------------------------------------------------------
CREATE TABLE t1 (c1 INT, c2 INT, c3 INT, c4 TEXT, c5 char(10)) row_format=compact
PARTITION BY RANGE(c1 * 2)
(PARTITION p0 VALUES LESS THAN (128),
PARTITION p1 VALUES LESS THAN (256),
PARTITION p2 VALUES LESS THAN (384),
PARTITION p3 VALUES LESS THAN MAXVALUE);
# DD Metadata of columns in table
NAME	ORDINAL_POSITION	TYPE	HAS_NO_DEFAULT	HIDDEN	SE_PRIVATE_DATA
c1	1	MYSQL_TYPE_LONG	0	Visible	table_id=TABLE_ID;
c2	2	MYSQL_TYPE_LONG	0	Visible	table_id=TABLE_ID;
c3	3	MYSQL_TYPE_LONG	0	Visible	table_id=TABLE_ID;
c4	4	MYSQL_TYPE_BLOB	0	Visible	table_id=TABLE_ID;
c5	5	MYSQL_TYPE_STRING	0	Visible	table_id=TABLE_ID;
DB_ROW_ID	6	MYSQL_TYPE_INT24	0	SE	table_id=TABLE_ID;
DB_TRX_ID	7	MYSQL_TYPE_INT24	0	SE	table_id=TABLE_ID;
DB_ROLL_PTR	8	MYSQL_TYPE_LONGLONG	0	SE	table_id=TABLE_ID;
# DD Metadata of partitions in table
NAME	DESCRIPTION_UTF8	SE_PRIVATE_DATA
p0	128	NULL
p1	256	NULL
p2	384	NULL
p3	MAXVALUE	NULL
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS	INITIAL_COLUMN_COUNTS	CURRENT_COLUMN_COUNTS	TOTAL_COLUMN_COUNTS
test/t1#p#p0	8	0	0	5	5	5
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT	VERSION_ADDED	VERSION_DROPPED
c1	0	6	1027	0	0	0
c2	1	6	1027	0	0	0
c3	2	6	1027	0	0	0
c4	3	5	16711932	0	0	0
c5	4	13	16711934	0	0	0
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS	INITIAL_COLUMN_COUNTS	CURRENT_COLUMN_COUNTS	TOTAL_COLUMN_COUNTS
test/t1#p#p1	8	0	0	5	5	5
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT	VERSION_ADDED	VERSION_DROPPED
c1	0	6	1027	0	0	0
c2	1	6	1027	0	0	0
c3	2	6	1027	0	0	0
c4	3	5	16711932	0	0	0
c5	4	13	16711934	0	0	0
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS	INITIAL_COLUMN_COUNTS	CURRENT_COLUMN_COUNTS	TOTAL_COLUMN_COUNTS
test/t1#p#p2	8	0	0	5	5	5
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT	VERSION_ADDED	VERSION_DROPPED
c1	0	6	1027	0	0	0
c2	1	6	1027	0	0	0
c3	2	6	1027	0	0	0
c4	3	5	16711932	0	0	0
c5	4	13	16711934	0	0	0
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS	INITIAL_COLUMN_COUNTS	CURRENT_COLUMN_COUNTS	TOTAL_COLUMN_COUNTS
test/t1#p#p3	8	0	0	5	5	5
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT	VERSION_ADDED	VERSION_DROPPED
c1	0	6	1027	0	0	0
c2	1	6	1027	0	0	0
c3	2	6	1027	0	0	0
c4	3	5	16711932	0	0	0
c5	4	13	16711934	0	0	0
# IMPORT
ALTER TABLE t1 discard tablespace;
ALTER TABLE t1 IMPORT TABLESPACE;
ERROR HY000: Schema mismatch (Column c5 length mismatch.)
# Cleanup
DROP TABLE t1;
# ------------------------------------------------------------
# Scenario 3 : INSTANT ADD/DROP Columns in target table
# ------------------------------------------------------------
CREATE TABLE t1 (c1 INT, c2 INT, c3 INT, c4 TEXT) row_format=compact
PARTITION BY RANGE(c1 * 2)
(PARTITION p0 VALUES LESS THAN (128),
PARTITION p1 VALUES LESS THAN (256),
PARTITION p2 VALUES LESS THAN (384),
PARTITION p3 VALUES LESS THAN MAXVALUE);
ALTER TABLE t1 ADD COLUMN c5 char(20) DEFAULT "c5_def";
# DD Metadata of columns in table
NAME	ORDINAL_POSITION	TYPE	HAS_NO_DEFAULT	HIDDEN	SE_PRIVATE_DATA
c1	1	MYSQL_TYPE_LONG	0	Visible	physical_pos=3;table_id=TABLE_ID;
c2	2	MYSQL_TYPE_LONG	0	Visible	physical_pos=4;table_id=TABLE_ID;
c3	3	MYSQL_TYPE_LONG	0	Visible	physical_pos=5;table_id=TABLE_ID;
c4	4	MYSQL_TYPE_BLOB	0	Visible	physical_pos=6;table_id=TABLE_ID;
c5	5	MYSQL_TYPE_STRING	0	Visible	default=63355f6465662020202020202020202020202020;physical_pos=7;table_id=TABLE_ID;version_added=1;
DB_ROW_ID	6	MYSQL_TYPE_INT24	0	SE	physical_pos=0;table_id=TABLE_ID;
DB_TRX_ID	7	MYSQL_TYPE_INT24	0	SE	physical_pos=1;table_id=TABLE_ID;
DB_ROLL_PTR	8	MYSQL_TYPE_LONGLONG	0	SE	physical_pos=2;table_id=TABLE_ID;
# DD Metadata of partitions in table
NAME	DESCRIPTION_UTF8	SE_PRIVATE_DATA
p0	128	NULL
p1	256	NULL
p2	384	NULL
p3	MAXVALUE	NULL
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS	INITIAL_COLUMN_COUNTS	CURRENT_COLUMN_COUNTS	TOTAL_COLUMN_COUNTS
test/t1#p#p0	8	0	1	4	5	5
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT	VERSION_ADDED	VERSION_DROPPED
c1	0	6	1027	0	0	0
c2	1	6	1027	0	0	0
c3	2	6	1027	0	0	0
c4	3	5	16711932	0	0	0
c5	4	13	16711934	1	1	0
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS	INITIAL_COLUMN_COUNTS	CURRENT_COLUMN_COUNTS	TOTAL_COLUMN_COUNTS
test/t1#p#p1	8	0	1	4	5	5
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT	VERSION_ADDED	VERSION_DROPPED
c1	0	6	1027	0	0	0
c2	1	6	1027	0	0	0
c3	2	6	1027	0	0	0
c4	3	5	16711932	0	0	0
c5	4	13	16711934	1	1	0
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS	INITIAL_COLUMN_COUNTS	CURRENT_COLUMN_COUNTS	TOTAL_COLUMN_COUNTS
test/t1#p#p2	8	0	1	4	5	5
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT	VERSION_ADDED	VERSION_DROPPED
c1	0	6	1027	0	0	0
c2	1	6	1027	0	0	0
c3	2	6	1027	0	0	0
c4	3	5	16711932	0	0	0
c5	4	13	16711934	1	1	0
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS	INITIAL_COLUMN_COUNTS	CURRENT_COLUMN_COUNTS	TOTAL_COLUMN_COUNTS
test/t1#p#p3	8	0	1	4	5	5
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT	VERSION_ADDED	VERSION_DROPPED
c1	0	6	1027	0	0	0
c2	1	6	1027	0	0	0
c3	2	6	1027	0	0	0
c4	3	5	16711932	0	0	0
c5	4	13	16711934	1	1	0
# IMPORT
ALTER TABLE t1 discard tablespace;
ALTER TABLE t1 IMPORT TABLESPACE;
ERROR HY000: Schema mismatch (Target table has INSTANT columns but the .cfg file is from earlier release with INSTANT column in the source table. Instant metadata can't match. Please create target table with no INSTANT column and try IMPORT.)
# Cleanup
DROP TABLE t1;
# ------------------------------------------------------------
# Scenario 4 : INSTANT ADD/DROP. Column mismatch
# ------------------------------------------------------------
CREATE TABLE t1 (c1 INT, c2 INT, c3 INT, c4 TEXT) row_format=compact
PARTITION BY RANGE(c1 * 2)
(PARTITION p0 VALUES LESS THAN (128),
PARTITION p1 VALUES LESS THAN (256),
PARTITION p2 VALUES LESS THAN (384),
PARTITION p3 VALUES LESS THAN MAXVALUE);
ALTER TABLE t1 ADD COLUMN c5 char(10) DEFAULT "c5_def";
# DD Metadata of columns in table
NAME	ORDINAL_POSITION	TYPE	HAS_NO_DEFAULT	HIDDEN	SE_PRIVATE_DATA
c1	1	MYSQL_TYPE_LONG	0	Visible	physical_pos=3;table_id=TABLE_ID;
c2	2	MYSQL_TYPE_LONG	0	Visible	physical_pos=4;table_id=TABLE_ID;
c3	3	MYSQL_TYPE_LONG	0	Visible	physical_pos=5;table_id=TABLE_ID;
c4	4	MYSQL_TYPE_BLOB	0	Visible	physical_pos=6;table_id=TABLE_ID;
c5	5	MYSQL_TYPE_STRING	0	Visible	default=63355f64656620202020;physical_pos=7;table_id=TABLE_ID;version_added=1;
DB_ROW_ID	6	MYSQL_TYPE_INT24	0	SE	physical_pos=0;table_id=TABLE_ID;
DB_TRX_ID	7	MYSQL_TYPE_INT24	0	SE	physical_pos=1;table_id=TABLE_ID;
DB_ROLL_PTR	8	MYSQL_TYPE_LONGLONG	0	SE	physical_pos=2;table_id=TABLE_ID;
# DD Metadata of partitions in table
NAME	DESCRIPTION_UTF8	SE_PRIVATE_DATA
p0	128	NULL
p1	256	NULL
p2	384	NULL
p3	MAXVALUE	NULL
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS	INITIAL_COLUMN_COUNTS	CURRENT_COLUMN_COUNTS	TOTAL_COLUMN_COUNTS
test/t1#p#p0	8	0	1	4	5	5
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT	VERSION_ADDED	VERSION_DROPPED
c1	0	6	1027	0	0	0
c2	1	6	1027	0	0	0
c3	2	6	1027	0	0	0
c4	3	5	16711932	0	0	0
c5	4	13	16711934	1	1	0
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS	INITIAL_COLUMN_COUNTS	CURRENT_COLUMN_COUNTS	TOTAL_COLUMN_COUNTS
test/t1#p#p1	8	0	1	4	5	5
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT	VERSION_ADDED	VERSION_DROPPED
c1	0	6	1027	0	0	0
c2	1	6	1027	0	0	0
c3	2	6	1027	0	0	0
c4	3	5	16711932	0	0	0
c5	4	13	16711934	1	1	0
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS	INITIAL_COLUMN_COUNTS	CURRENT_COLUMN_COUNTS	TOTAL_COLUMN_COUNTS
test/t1#p#p2	8	0	1	4	5	5
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT	VERSION_ADDED	VERSION_DROPPED
c1	0	6	1027	0	0	0
c2	1	6	1027	0	0	0
c3	2	6	1027	0	0	0
c4	3	5	16711932	0	0	0
c5	4	13	16711934	1	1	0
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS	INITIAL_COLUMN_COUNTS	CURRENT_COLUMN_COUNTS	TOTAL_COLUMN_COUNTS
test/t1#p#p3	8	0	1	4	5	5
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT	VERSION_ADDED	VERSION_DROPPED
c1	0	6	1027	0	0	0
c2	1	6	1027	0	0	0
c3	2	6	1027	0	0	0
c4	3	5	16711932	0	0	0
c5	4	13	16711934	1	1	0
# IMPORT
ALTER TABLE t1 discard tablespace;
ALTER TABLE t1 IMPORT TABLESPACE;
ERROR HY000: Schema mismatch (Column c5 length mismatch.)
# Cleanup
DROP TABLE t1;
# ------------------------------------------------------------
# Scenario 5 : INSTANT ADD/DROP. Default value mismatch
# ------------------------------------------------------------
CREATE TABLE t1 (c1 INT, c2 INT, c3 INT, c4 TEXT) row_format=compact
PARTITION BY RANGE(c1 * 2)
(PARTITION p0 VALUES LESS THAN (128),
PARTITION p1 VALUES LESS THAN (256),
PARTITION p2 VALUES LESS THAN (384),
PARTITION p3 VALUES LESS THAN MAXVALUE);
ALTER TABLE t1 ADD COLUMN c5 char(20) DEFAULT "def_c5";
# DD Metadata of columns in table
NAME	ORDINAL_POSITION	TYPE	HAS_NO_DEFAULT	HIDDEN	SE_PRIVATE_DATA
c1	1	MYSQL_TYPE_LONG	0	Visible	physical_pos=3;table_id=TABLE_ID;
c2	2	MYSQL_TYPE_LONG	0	Visible	physical_pos=4;table_id=TABLE_ID;
c3	3	MYSQL_TYPE_LONG	0	Visible	physical_pos=5;table_id=TABLE_ID;
c4	4	MYSQL_TYPE_BLOB	0	Visible	physical_pos=6;table_id=TABLE_ID;
c5	5	MYSQL_TYPE_STRING	0	Visible	default=6465665f63352020202020202020202020202020;physical_pos=7;table_id=TABLE_ID;version_added=1;
DB_ROW_ID	6	MYSQL_TYPE_INT24	0	SE	physical_pos=0;table_id=TABLE_ID;
DB_TRX_ID	7	MYSQL_TYPE_INT24	0	SE	physical_pos=1;table_id=TABLE_ID;
DB_ROLL_PTR	8	MYSQL_TYPE_LONGLONG	0	SE	physical_pos=2;table_id=TABLE_ID;
# DD Metadata of partitions in table
NAME	DESCRIPTION_UTF8	SE_PRIVATE_DATA
p0	128	NULL
p1	256	NULL
p2	384	NULL
p3	MAXVALUE	NULL
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS	INITIAL_COLUMN_COUNTS	CURRENT_COLUMN_COUNTS	TOTAL_COLUMN_COUNTS
test/t1#p#p0	8	0	1	4	5	5
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT	VERSION_ADDED	VERSION_DROPPED
c1	0	6	1027	0	0	0
c2	1	6	1027	0	0	0
c3	2	6	1027	0	0	0
c4	3	5	16711932	0	0	0
c5	4	13	16711934	1	1	0
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS	INITIAL_COLUMN_COUNTS	CURRENT_COLUMN_COUNTS	TOTAL_COLUMN_COUNTS
test/t1#p#p1	8	0	1	4	5	5
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT	VERSION_ADDED	VERSION_DROPPED
c1	0	6	1027	0	0	0
c2	1	6	1027	0	0	0
c3	2	6	1027	0	0	0
c4	3	5	16711932	0	0	0
c5	4	13	16711934	1	1	0
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS	INITIAL_COLUMN_COUNTS	CURRENT_COLUMN_COUNTS	TOTAL_COLUMN_COUNTS
test/t1#p#p2	8	0	1	4	5	5
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT	VERSION_ADDED	VERSION_DROPPED
c1	0	6	1027	0	0	0
c2	1	6	1027	0	0	0
c3	2	6	1027	0	0	0
c4	3	5	16711932	0	0	0
c5	4	13	16711934	1	1	0
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS	INITIAL_COLUMN_COUNTS	CURRENT_COLUMN_COUNTS	TOTAL_COLUMN_COUNTS
test/t1#p#p3	8	0	1	4	5	5
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT	VERSION_ADDED	VERSION_DROPPED
c1	0	6	1027	0	0	0
c2	1	6	1027	0	0	0
c3	2	6	1027	0	0	0
c4	3	5	16711932	0	0	0
c5	4	13	16711934	1	1	0
# IMPORT
ALTER TABLE t1 discard tablespace;
ALTER TABLE t1 IMPORT TABLESPACE;
ERROR HY000: Schema mismatch (Target table has INSTANT columns but the .cfg file is from earlier release with INSTANT column in the source table. Instant metadata can't match. Please create target table with no INSTANT column and try IMPORT.)
# Cleanup
DROP TABLE t1;
# --------------------------------------------------------------
# Scenario 6 : Table with INSTANT ADD and reorganized partitions
# --------------------------------------------------------------
# Copy and unzip the ibd/cfg files.
# listing MYSQL_TMP_DIR/old_instant_reorg_part_comp
t1#p#p0.cfg
t1#p#p0.ibd
t1#p#p1_1.cfg
t1#p#p1_1.ibd
t1#p#p1_2.cfg
t1#p#p1_2.ibd
t1#p#p2.cfg
t1#p#p2.ibd
CREATE TABLE t1 (id INT NOT NULL AUTO_INCREMENT KEY, c1 char(10), c2 char(10), c3 char(10)) 
PARTITION BY RANGE(id) (
PARTITION p0 VALUES LESS THAN (100),
PARTITION p1_1 VALUES LESS THAN (150),
PARTITION p1_2 VALUES LESS THAN (200),
PARTITION p2 VALUES LESS THAN MAXVALUE);
# DD Metadata of columns in table
NAME	ORDINAL_POSITION	TYPE	HAS_NO_DEFAULT	HIDDEN	SE_PRIVATE_DATA
id	1	MYSQL_TYPE_LONG	0	Visible	table_id=TABLE_ID;
c1	2	MYSQL_TYPE_STRING	0	Visible	table_id=TABLE_ID;
c2	3	MYSQL_TYPE_STRING	0	Visible	table_id=TABLE_ID;
c3	4	MYSQL_TYPE_STRING	0	Visible	table_id=TABLE_ID;
DB_TRX_ID	5	MYSQL_TYPE_INT24	0	SE	table_id=TABLE_ID;
DB_ROLL_PTR	6	MYSQL_TYPE_LONGLONG	0	SE	table_id=TABLE_ID;
# DD Metadata of partitions in table
NAME	DESCRIPTION_UTF8	SE_PRIVATE_DATA
p0	100	autoinc=0;version=0;
p1_1	150	autoinc=0;version=0;
p1_2	200	autoinc=0;version=0;
p2	MAXVALUE	autoinc=0;version=0;
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS	INITIAL_COLUMN_COUNTS	CURRENT_COLUMN_COUNTS	TOTAL_COLUMN_COUNTS
test/t1#p#p0	7	0	0	4	4	4
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT	VERSION_ADDED	VERSION_DROPPED
id	0	6	1283	0	0	0
c1	1	13	16711934	0	0	0
c2	2	13	16711934	0	0	0
c3	3	13	16711934	0	0	0
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS	INITIAL_COLUMN_COUNTS	CURRENT_COLUMN_COUNTS	TOTAL_COLUMN_COUNTS
test/t1#p#p1_1	7	0	0	4	4	4
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT	VERSION_ADDED	VERSION_DROPPED
id	0	6	1283	0	0	0
c1	1	13	16711934	0	0	0
c2	2	13	16711934	0	0	0
c3	3	13	16711934	0	0	0
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS	INITIAL_COLUMN_COUNTS	CURRENT_COLUMN_COUNTS	TOTAL_COLUMN_COUNTS
test/t1#p#p1_2	7	0	0	4	4	4
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT	VERSION_ADDED	VERSION_DROPPED
id	0	6	1283	0	0	0
c1	1	13	16711934	0	0	0
c2	2	13	16711934	0	0	0
c3	3	13	16711934	0	0	0
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS	INITIAL_COLUMN_COUNTS	CURRENT_COLUMN_COUNTS	TOTAL_COLUMN_COUNTS
test/t1#p#p2	7	0	0	4	4	4
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT	VERSION_ADDED	VERSION_DROPPED
id	0	6	1283	0	0	0
c1	1	13	16711934	0	0	0
c2	2	13	16711934	0	0	0
c3	3	13	16711934	0	0	0
# IMPORT
ALTER TABLE t1 discard tablespace;
ALTER TABLE t1 IMPORT TABLESPACE;
SELECT * FROM t1 ORDER BY c1;
id	c1	c2	c3
1	r1c1	r1c2	c3_def
2	r2c1	r2c2	r2c3
# DD Metadata of columns in table
NAME	ORDINAL_POSITION	TYPE	HAS_NO_DEFAULT	HIDDEN	SE_PRIVATE_DATA
id	1	MYSQL_TYPE_LONG	0	Visible	table_id=TABLE_ID;
c1	2	MYSQL_TYPE_STRING	0	Visible	table_id=TABLE_ID;
c2	3	MYSQL_TYPE_STRING	0	Visible	table_id=TABLE_ID;
c3	4	MYSQL_TYPE_STRING	0	Visible	default=63335f64656620202020;table_id=TABLE_ID;
DB_TRX_ID	5	MYSQL_TYPE_INT24	0	SE	table_id=TABLE_ID;
DB_ROLL_PTR	6	MYSQL_TYPE_LONGLONG	0	SE	table_id=TABLE_ID;
# DD Metadata of partitions in table
NAME	DESCRIPTION_UTF8	SE_PRIVATE_DATA
p0	100	autoinc=0;discard=0;instant_col=3;version=0;
p1_1	150	autoinc=0;discard=0;version=0;
p1_2	200	autoinc=0;discard=0;version=0;
p2	MAXVALUE	autoinc=0;discard=0;instant_col=3;version=0;
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS	INITIAL_COLUMN_COUNTS	CURRENT_COLUMN_COUNTS	TOTAL_COLUMN_COUNTS
test/t1#p#p0	7	3	0	4	4	4
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT	VERSION_ADDED	VERSION_DROPPED
id	0	6	1283	0	0	0
c1	1	13	16711934	0	0	0
c2	2	13	16711934	0	0	0
c3	3	13	16711934	1	0	0
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS	INITIAL_COLUMN_COUNTS	CURRENT_COLUMN_COUNTS	TOTAL_COLUMN_COUNTS
test/t1#p#p1_1	7	0	0	4	4	4
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT	VERSION_ADDED	VERSION_DROPPED
id	0	6	1283	0	0	0
c1	1	13	16711934	0	0	0
c2	2	13	16711934	0	0	0
c3	3	13	16711934	0	0	0
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS	INITIAL_COLUMN_COUNTS	CURRENT_COLUMN_COUNTS	TOTAL_COLUMN_COUNTS
test/t1#p#p1_2	7	0	0	4	4	4
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT	VERSION_ADDED	VERSION_DROPPED
id	0	6	1283	0	0	0
c1	1	13	16711934	0	0	0
c2	2	13	16711934	0	0	0
c3	3	13	16711934	0	0	0
# Metadata from INFORMATION_SCHEMA.TABLES
NAME	N_COLS	INSTANT_COLS	TOTAL_ROW_VERSIONS	INITIAL_COLUMN_COUNTS	CURRENT_COLUMN_COUNTS	TOTAL_COLUMN_COUNTS
test/t1#p#p2	7	3	0	4	4	4
# Metadata from INFORMATION_SCHEMA.COLUMNS
NAME	POS	MTYPE	PRTYPE	HAS_DEFAULT	VERSION_ADDED	VERSION_DROPPED
id	0	6	1283	0	0	0
c1	1	13	16711934	0	0	0
c2	2	13	16711934	0	0	0
c3	3	13	16711934	1	0	0
# Cleanup
DROP TABLE t1;
###########
# CLEANUP #
###########
