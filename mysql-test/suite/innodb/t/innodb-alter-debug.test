--source include/have_debug.inc
--source include/have_debug_sync.inc

########################################
##### WL#7554 Force schema `test` to character set latin1
##### This test should be migrated to utf8mb4
--disable_query_log
let $testdbcs35=`select default_character_set_name from information_schema.schemata where schema_name='test'`;
alter schema test default character set latin1;
--enable_query_log
########################################

--source include/count_sessions.inc

SET NAMES utf8;

CREATE TABLE ① (
 c1 INT PRIMARY KEY, c2 INT DEFAULT 1, ct TEXT, INDEX(c2))
ENGINE = InnoDB;

CREATE TABLE t1ć (c1 INT PRIMARY KEY, c2 INT, INDEX(c2),
                  CONSTRAINT t1c2 FOREIGN KEY (c2) REFERENCES ①(c2))
ENGINE=InnoDB;

INSERT INTO ① SET c1 = 1;

SET DEBUG = '+d,ib_drop_foreign_error';
--error ER_RECORD_FILE_FULL
ALTER TABLE t1ć DROP FOREIGN KEY t1c2, RENAME TO ②;
SET DEBUG = '-d,ib_drop_foreign_error';

SET DEBUG = '+d,ib_rename_column_error';
--error ER_RECORD_FILE_FULL
ALTER TABLE ① CHANGE c2 š INT;
SET DEBUG = '-d,ib_rename_column_error';

SHOW CREATE TABLE t1ć;

DROP TABLE t1ć, ①;

--echo #
--echo # Bug #21364096	THE BOGUS DUPLICATE KEY ERROR IN ONLINE DDL
--echo #		WITH INCORRECT KEY NAME

create table t1 (id int auto_increment primary key,
		 a int,
		 unique key uk(a))engine=innodb;
insert into t1 select 1, 1;
insert into t1 select 2, 2;
SET DEBUG_SYNC = 'row_log_table_apply1_before SIGNAL s1 WAIT_FOR s2';
--send alter table t1 add b int, ALGORITHM=inplace

--echo /* connection con1 */
connect (con1,localhost,root,,);
SET DEBUG_SYNC = 'now WAIT_FOR s1';
--error ER_DUP_ENTRY
insert into t1 select NULL, 1;
SET DEBUG_SYNC = 'now SIGNAL s2';

--echo /* connection default */
connection default;
--echo /* reap */ alter table t1 add b int, ALGORITHM=inplace;
--error ER_DUP_ENTRY
--reap

SET DEBUG_SYNC = 'row_log_table_apply1_before SIGNAL s1 WAIT_FOR s2';
--send alter table t1 add b int, ALGORITHM=inplace;

--echo /* connection con1 */
connection con1;
set DEBUG_SYNC = 'now WAIT_FOR s1';
--error ER_DUP_ENTRY
update t1 set a=1 where id=2;
SET DEBUG_SYNC = 'now SIGNAL s2';
disconnect con1;

--echo /* connection default */
connection default;
--echo /* reap */ alter table t1 add b int, ALGORITHM=inplace;
--error ER_DUP_ENTRY
--reap

drop table t1;

# Wait till all disconnects are completed
--source include/wait_until_count_sessions.inc

########################################
##### WL#7554 set schema `test` back to what it was
--disable_query_log
--eval alter schema test default character set $testdbcs35;
--enable_query_log
########################################
