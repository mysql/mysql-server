# *******************************************************
# wl#8619 : Testing the functionality of portability
# The  *.ibd files can be moved into any of the following 
# listed known directories
# 1) --datadir  (mysql home)
# 2) --innodb-directories= dir1;dir2;etc...
# 3) --innodb-undo-dirrectory
# 4) --innodb-data-home-dir (ibdata1 and ibtemp1 are bootstrapped here.)
# Note : --datadir as whole unit should be moved and its
# folder hierarchy should be preserved
# The *.ibd files created with DB directory (absolute paths)
# User has to follow the MySQL rules while moving the 
# files.
# Test full path and relative path of --datadir and
# absolute path
# ******************************************************
--source include/have_innodb_max_16k.inc

let $MYSQLD_OLD_DATADIR = `select @@datadir`;

# Create new datadir folders like data
--mkdir $MYSQL_TMP_DIR/data_directory2
--mkdir $MYSQL_TMP_DIR/data_directory2/test
--mkdir $MYSQL_TMP_DIR/new_datadir
--mkdir $MYSQL_TMP_DIR/new_datadir/data
let $MYSQLD_NEW_DATADIR = $MYSQL_TMP_DIR/new_datadir/data;
--mkdir $MYSQLD_NEW_DATADIR/test
--mkdir $MYSQLD_NEW_DATADIR/mysql
--mkdir $MYSQLD_NEW_DATADIR/sys
--mkdir $MYSQLD_NEW_DATADIR/performance_schema
--mkdir $MYSQLD_NEW_DATADIR/mtr

--echo ## create tables and tablespaces without absolute paths
CREATE TABLESPACE ts1 ADD DATAFILE 'ts1.ibd' Engine=InnoDB;

CREATE TABLE tab1(c1 int, c2 varchar(10)) TABLESPACE=ts1;

INSERT INTO tab1 VALUES(1, 'VISH');

CREATE TABLE tab2(c1 int, c2 varchar(10)) Engine=InnoDB;

INSERT INTO tab2 VALUES(2, 'VISH');

CREATE INDEX ix1 ON tab1(c2) USING BTREE;

CREATE INDEX ix1 ON tab2(c2) ;

--echo ## create tables and tablespaces with absolute paths
--replace_result $MYSQL_TMP_DIR data_directory1
eval CREATE TABLE tab3(
	empno INT, ename VARCHAR(30),sal NUMERIC(3))
	ENGINE=InnoDB ROW_FORMAT=COMPRESSED
	PARTITION by hash(empno) (
		PARTITION P0 DATA DIRECTORY '$MYSQL_TMP_DIR/data_directory1',
		PARTITION P1 DATA DIRECTORY '$MYSQL_TMP_DIR/data_directory1');

CREATE INDEX ix1 ON tab3(ename) USING BTREE;

INSERT INTO tab3 VALUES (100,'VISWANATH',100);

INSERT INTO tab3 VALUES (300,'VISWANATH',100);

SHOW CREATE TABLE tab1;

SHOW CREATE TABLE tab2;

--replace_result $MYSQL_TMP_DIR data_directory1
SHOW CREATE TABLE tab3;

--echo ## Stop DB server
--source include/shutdown_mysqld.inc

--echo # Copy whole --datadir files into new location
--copy_file $MYSQLD_OLD_DATADIR/auto.cnf $MYSQLD_NEW_DATADIR/auto.cnf
--copy_file $MYSQLD_OLD_DATADIR/ib_buffer_pool $MYSQLD_NEW_DATADIR/ib_buffer_pool
--copy_file $MYSQLD_OLD_DATADIR/ibdata1 $MYSQLD_NEW_DATADIR/ibdata1
--copy_files_wildcard $MYSQLD_OLD_DATADIR  $MYSQLD_NEW_DATADIR *.ibd
--copy_files_wildcard $MYSQLD_OLD_DATADIR  $MYSQLD_NEW_DATADIR undo*
--copy_files_wildcard $MYSQLD_OLD_DATADIR  $MYSQLD_NEW_DATADIR ib_logfile*

--copy_files_wildcard $MYSQLD_OLD_DATADIR/test/  $MYSQLD_NEW_DATADIR/test/ *.*
--copy_files_wildcard $MYSQLD_OLD_DATADIR/sys/  $MYSQLD_NEW_DATADIR/sys/ *.*
--copy_files_wildcard $MYSQLD_OLD_DATADIR/performance_schema/  $MYSQLD_NEW_DATADIR/performance_schema/ *.*
--copy_files_wildcard $MYSQLD_OLD_DATADIR/mysql/  $MYSQLD_NEW_DATADIR/mysql/ *.*
--copy_files_wildcard $MYSQLD_OLD_DATADIR/mtr/  $MYSQLD_NEW_DATADIR/mtr/ *.*

--echo ## Copy absolute path *.ibd files into new location
--copy_files_wildcard $MYSQL_TMP_DIR/data_directory1/test/ $MYSQL_TMP_DIR/data_directory2/test  *.ibd

--echo ## Remove the old absolute path *.ibd files
--remove_files_wildcard $MYSQL_TMP_DIR/data_directory1/test/ *.ibd

--echo ## Start with new --datadir and --innodb-directories options
let $innodb_dirs='$MYSQLD_NEW_DATADIR;$MYSQL_TMP_DIR/data_directory2/test';
--let $restart_parameters="restart: --datadir=$MYSQLD_NEW_DATADIR --innodb-directories=$innodb_dirs"
--source include/start_mysqld_no_echo.inc

--echo ## Check while passing new datadir and new absolute path
--replace_result $MYSQLD_NEW_DATADIR NEW_DATADIR
SELECT @@datadir;

--replace_result $MYSQL_TMP_DIR data_directory2
SHOW CREATE TABLE tab3;

--echo ## Stop DB server
--source include/shutdown_mysqld.inc

--echo ## Start with new --datadir and without --innodb-directories option
--replace_result $MYSQLD_NEW_DATADIR NEW_DATADIR
--let $restart_parameters="restart: --datadir=$MYSQLD_NEW_DATADIR"
--source include/start_mysqld.inc

--echo ## Check with new --datadir only
--replace_result $MYSQLD_NEW_DATADIR NEW_DATADIR
SELECT @@datadir;

--echo ## Check the tables with SHOW
SHOW CREATE TABLE tab1;

SHOW CREATE TABLE tab2;

--replace_result $MYSQL_TMP_DIR data_directory2
SHOW CREATE TABLE tab3;

--echo ## Check with DML & DDL operations
SELECT * FROM tab1;

SELECT * FROM tab2;

SELECT * FROM tab3;

DELETE FROM tab1;

DELETE FROM tab2;

DELETE FROM tab3;

INSERT INTO tab1 VALUES(1, 'VISH');

INSERT INTO tab2 VALUES(2, 'VISH');

INSERT INTO tab3 VALUES (100,'VISWANATH',100);

INSERT INTO tab3 VALUES (300,'VISWANATH',100);

SELECT * FROM tab1;

SELECT * FROM tab2;

SELECT * FROM tab3;

# Clean up new datadir
DROP TABLE tab1;
DROP TABLE tab2;
DROP TABLESPACE ts1;

--echo # Stop DB server with new datadir
--source include/shutdown_mysqld.inc

--echo ## Test with relative paths of --datadir and absolute path
--replace_result $MYSQLD_NEW_DATADIR data_directory2
--replace_result $MYSQL_TMP_DIR NEW_DATADIR
--let $restart_parameters="restart: --datadir=$MYSQL_TMP_DIR/data_directory2/test/../../new_datadir/data --innodb-directories=$MYSQLD_NEW_DATADIR/../../data_directory2/test"
--source include/start_mysqld.inc

--echo ## Check relative path while passing as new datadir and new absolute path
--replace_result $MYSQL_TMP_DIR NEW_DATADIR
SELECT @@datadir;

--replace_result $MYSQL_TMP_DIR NEW_DATADIR
SHOW CREATE TABLE tab3;

--echo # Stop DB server with new datadir
--source include/shutdown_mysqld.inc

--echo ## Test with relative path of --datadir
--replace_result $MYSQL_TMP_DIR NEW_DATADIR
--let $restart_parameters="restart: --datadir=$MYSQL_TMP_DIR/data_directory2/test/../../new_datadir/data"
--source include/start_mysqld.inc

--echo ## Check relative path of --datadir
--replace_result $MYSQL_TMP_DIR NEW_DATADIR
SELECT @@datadir;

--replace_result $MYSQL_TMP_DIR NEW_DATADIR
SHOW CREATE TABLE tab3;

--echo # Stop DB server with new datadir
--source include/shutdown_mysqld.inc

--echo ## Copy absolute path *.ibd files back to old location
--copy_files_wildcard $MYSQL_TMP_DIR/data_directory2/test/ $MYSQL_TMP_DIR/data_directory1/test *.ibd

--echo ## Remove the new DATA DIRECTORY *.ibd files
--remove_files_wildcard $MYSQL_TMP_DIR/data_directory2/test/ *.ibd
--rmdir  $MYSQL_TMP_DIR/data_directory2/test/
--rmdir  $MYSQL_TMP_DIR/data_directory2

--echo # Re-start with old --datadir
--replace_result $MYSQLD_OLD_DATADIR OLD_DATADIR
--let $restart_parameters="restart: --datadir=$MYSQLD_OLD_DATADIR"
--source include/start_mysqld.inc

--echo # Check --datadir started with old
--replace_result $MYSQLD_OLD_DATADIR OLD_DATADIR
SELECT @@datadir;

# Clean up old datadir
DROP TABLE tab1;
DROP TABLE tab2;
DROP TABLE tab3;

# Clean up new datadir while server is OFF
--remove_files_wildcard $MYSQLD_NEW_DATADIR/test/ *.*
--remove_files_wildcard $MYSQLD_NEW_DATADIR/sys/ *.*
--remove_files_wildcard $MYSQLD_NEW_DATADIR/mysql/ *.*
--remove_files_wildcard $MYSQLD_NEW_DATADIR/mtr/ *.*
--remove_files_wildcard $MYSQLD_NEW_DATADIR/performance_schema/ *
--rmdir  $MYSQL_TMP_DIR/data_directory1/test/
--rmdir  $MYSQL_TMP_DIR/data_directory1
--rmdir $MYSQLD_NEW_DATADIR/mtr
--rmdir $MYSQLD_NEW_DATADIR/mysql
--rmdir $MYSQLD_NEW_DATADIR/sys
--rmdir $MYSQLD_NEW_DATADIR/test
--rmdir $MYSQLD_NEW_DATADIR/performance_schema
--remove_files_wildcard $MYSQLD_NEW_DATADIR/ *
--rmdir $MYSQLD_NEW_DATADIR
--rmdir $MYSQL_TMP_DIR/new_datadir
