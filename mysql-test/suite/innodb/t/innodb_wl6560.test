--source include/have_innodb.inc
--source include/have_debug.inc

# Valgrind would complain about memory leaks when we crash on purpose.
--source include/not_valgrind.inc
# Embedded server does not support crashing
--source include/not_embedded.inc
# Avoid CrashReporter popup on Mac
--source include/not_crashrep.inc

#
# Will test following scenarios:
# 1. creation of shared temp-tablespace.
# 2. ddl + dml operation involving temp-tablespace.
#    insert/delete/update/select
#    create/drop/alter/truncate/import-discard (though blocked).
# 3. ddl + dml operation on compressed table.
#    (table doesn't reside in shared temp-tablespace).
# 4. Test bulk-loading that result in auto-extension of temp-tablespace.
# 5. re-creation of temp-tablespace on re-start.
#    also to ensure non-existence of existing temp-table.
# 6. hit a crash point during tablespace creation to ensure temp-table
#    is recovered correctly.
# 7. restart server in innodb-read-only mode. this will also
#    block creation of temp-tables.

#-----------------------------------------------------------------------------
#
# create test-bed
#
set @global_innodb_file_per_table_orig = @@global.innodb_file_per_table;
set @global_innodb_file_format_orig= @@global.innodb_file_format;
set global innodb_file_per_table = off;
let $MYSQL_DATA_DIR = `select @@datadir`;
let $MYSQL_TMP_DIR = `select @@tmpdir`;
let SEARCH_FILE=$MYSQLTEST_VARDIR/log/my_restart.err;
let $args=--loose-console > $SEARCH_FILE 2>&1;
let crash=$args --innodb-force-recovery-crash;
let readonly=$args --innodb_read_only;

#-----------------------------------------------------------------------------
#
# 1. creation of shared temp-tablespace.
#
--echo # files in MYSQL_DATA_DIR
--list_files $MYSQL_DATA_DIR/ ib*tmp*


#-----------------------------------------------------------------------------
#
# 2. ddl + dml operation involving temp-tablespace.
#    insert/delete/update/select
#    create/drop/alter/truncate/import-discard (though blocked).
#
--disable_warnings
drop table if exists t1;
--enable_warnings
select @@global.innodb_file_per_table;
create temporary table t1 (i int, f float, c char(100)) engine=innodb;
#
--source suite/innodb/include/innodb_temp_table_dml.inc
#
# alter table
--error ER_TABLE_IN_SYSTEM_TABLESPACE
alter table t1 import tablespace;
#
# drop table
drop table t1;

#-----------------------------------------------------------------------------
#
# 3. ddl + dml operation on compressed table.
#    (table doesn't reside in shared temp-tablespace).
#
--echo #files in MYSQL_TMP_DIR
--list_files $MYSQL_TMP_DIR/ *.ibd
set global innodb_file_per_table = on;
set global innodb_file_format = 'Barracuda';
select @@global.innodb_file_per_table;
create temporary table t1 (i int, f float, c char(100))
engine=innodb key_block_size=4;
show create table t1;
--echo #files in MYSQL_TMP_DIR
--replace_regex /#sql[0-9a-f_]*/#sql<temporary>/
--list_files $MYSQL_TMP_DIR/ *.ibd
#
--source suite/innodb/include/innodb_temp_table_dml.inc
#
# alter table
alter table t1 discard tablespace;
#--error ER_NO_SUCH_TABLE
#alter table t1 import tablespace;
#
# drop table
drop table t1;
set global innodb_file_per_table = off;
set global innodb_file_format = @global_innodb_file_format_orig;


#-----------------------------------------------------------------------------
#
# 4. Test bulk-loading that result in auto-extension of temp-tablespace.
#
create temporary table t1 (keyc int, c1 char(100), c2 char(100),
primary key(keyc)) engine=innodb;
delimiter |;
CREATE PROCEDURE populate_t1()
BEGIN
        DECLARE i INT DEFAULT 1;
        while (i <= 20000) DO
		insert into t1 values (i, 'a', 'b');
                SET i = i + 1;
        END WHILE;
END|
delimiter ;|
set autocommit=0;
select count(*) from t1;
CALL populate_t1();
select count(*) from t1;
select * from t1 limit 10;
set autocommit=1;
truncate table t1;
select count(*) from t1;
#
drop procedure populate_t1;
drop table t1;


#-----------------------------------------------------------------------------
#
# 5. re-creation of temp-tablespace on re-start.
#    also to ensure non-existence of existing temp-table.
#
create temporary table t1 (keyc int, c1 char(100), c2 char(100)) engine=innodb;
insert into t1 values (1, 'c', 'b');
select * from t1;
--source include/restart_mysqld.inc
--echo # files in MYSQL_DATA_DIR
--list_files $MYSQL_DATA_DIR/ ib*tmp*
use test;
--error ER_NO_SUCH_TABLE
select * from t1;


#-----------------------------------------------------------------------------
#
# 6. hit a crash point during tablespace creation to ensure temp-table
#    is recovered correctly.
#
--source include/shutdown_mysqld.inc
--echo --innodb-force-recovery-crash=100
--error 3
--exec $MYSQLD_CMD $crash=100
--exec grep "InnoDB: Creating shared tablespace for temporary tables" $SEARCH_FILE | wc -l
--exec grep "innodb_force_recovery_crash=" $SEARCH_FILE | wc -l
--remove_file $SEARCH_FILE
#
--source include/start_mysqld.inc
--echo # files in MYSQL_DATA_DIR
--list_files $MYSQL_DATA_DIR/ ib*tmp*
use test;
create temporary table t1 (keyc int, c1 char(100), c2 char(100)) engine=innodb;
insert into t1 values (1, 'c', 'b');
select * from t1;

#-----------------------------------------------------------------------------
#
# 7. restart server in innodb-read-only mode. this will also
#    block creation of temp-tables.
#
#
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--shutdown_server 10
--source include/wait_until_disconnected.inc
# Do something while server is down
--enable_reconnect
# Write file to make mysql-test-run.pl start up the server again
--exec echo "restart: --innodb-read-only " > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect
#
use test;
show tables;
--error ER_OPEN_AS_READONLY
create temporary table t1 (keyc int, c1 char(100), c2 char(100)) engine=innodb;

#-----------------------------------------------------------------------------
#
# remove test-bed
#

