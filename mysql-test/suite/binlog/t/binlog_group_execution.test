--source include/have_gtid.inc
--source include/have_log_bin.inc

--let $ida= aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa
--let $idb= bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb
--let $idc= cccccccc-cccc-cccc-cccc-cccccccccccc
--let $idd= dddddddd-dddd-dddd-dddd-dddddddddddd
--let $ide= eeeeeeee-eeee-eeee-eeee-eeeeeeeeeeee
--let $idf= ffffffff-ffff-ffff-ffff-ffffffffffff
--let $tab= `SELECT '\t'`

--echo ==== Valid and invalid values for gtid_next ====

SELECT @@SESSION.GTID_NEXT;
SELECT @@SESSION.GTID_NEXT_LIST;

SET @@SESSION.GTID_NEXT= 'ANONYMOUS';
SELECT @@SESSION.GTID_NEXT;

SET @@SESSION.GTID_NEXT= 'AUTOMATIC';
SELECT @@SESSION.GTID_NEXT;

eval SET @@SESSION.GTID_NEXT= '$ida:10';
SELECT @@SESSION.GTID_NEXT;

eval SET @@SESSION.GTID_NEXT= '$ida:0x10';
SELECT @@SESSION.GTID_NEXT;

eval SET @@SESSION.GTID_NEXT= '$ida:010';
SELECT @@SESSION.GTID_NEXT;

--error ER_WRONG_VALUE_FOR_VAR
eval SET @@SESSION.GTID_NEXT= '$ida:10#';
SELECT @@SESSION.GTID_NEXT;

--error ER_WRONG_VALUE_FOR_VAR
eval SET @@SESSION.GTID_NEXT= '$ida:1-10';
SELECT @@SESSION.GTID_NEXT;

--error ER_WRONG_VALUE_FOR_VAR
eval SET @@SESSION.GTID_NEXT= '$ida:1:3';
SELECT @@SESSION.GTID_NEXT;

--error ER_WRONG_VALUE_FOR_VAR
eval SET @@SESSION.GTID_NEXT= '$ida:1,$ida:3';
SELECT @@SESSION.GTID_NEXT;

--error ER_WRONG_VALUE_FOR_VAR
SET @@SESSION.GTID_NEXT= NULL;
SELECT @@SESSION.GTID_NEXT;

--error ER_WRONG_TYPE_FOR_VAR
SET @@SESSION.GTID_NEXT= 10;
SELECT @@SESSION.GTID_NEXT;

--error ER_WRONG_VALUE_FOR_VAR
SET @@SESSION.GTID_NEXT= '10';
SELECT @@SESSION.GTID_NEXT;

--error ER_WRONG_VALUE_FOR_VAR
eval SET @@SESSION.GTID_NEXT= '$ida:';
SELECT @@SESSION.GTID_NEXT;

--error ER_WRONG_VALUE_FOR_VAR
eval SET @@SESSION.GTID_NEXT= '$ida:0';
SELECT @@SESSION.GTID_NEXT;

--error ER_WRONG_VALUE_FOR_VAR
eval SET @@SESSION.GTID_NEXT= '$ida:0x8000000000000000';
SELECT @@SESSION.GTID_NEXT;

--echo ==== Valid and invalid values for gtid_next_list ====

if (0) {
SELECT @@SESSION.GTID_NEXT_LIST;

SET @@SESSION.GTID_NEXT_LIST= '';
SELECT @@SESSION.GTID_NEXT_LIST;

--error ER_WRONG_VALUE_FOR_VAR
SET @@SESSION.GTID_NEXT_LIST= '#';
SELECT @@SESSION.GTID_NEXT_LIST;

--error ER_WRONG_VALUE_FOR_VAR
eval SET @@SESSION.GTID_NEXT_LIST= '$ida:1:$ida:1';
SELECT @@SESSION.GTID_NEXT_LIST;

eval SET @@SESSION.GTID_NEXT_LIST= NULL;
SELECT @@SESSION.GTID_NEXT_LIST;

eval SET @@SESSION.GTID_NEXT_LIST= '$ida:1';
SELECT @@SESSION.GTID_NEXT_LIST;

eval SET @@SESSION.GTID_NEXT_LIST= '$idb:1-10';
SELECT @@SESSION.GTID_NEXT_LIST;

eval SET @@SESSION.GTID_NEXT_LIST= '$idc:1-10:2-20';
SELECT @@SESSION.GTID_NEXT_LIST;

eval SET @@SESSION.GTID_NEXT_LIST= '$idd :1-10:11-20';
SELECT @@SESSION.GTID_NEXT_LIST;

eval SET @@SESSION.GTID_NEXT_LIST= '$ide: 1-10:14-20';
SELECT @@SESSION.GTID_NEXT_LIST;

eval SET @@SESSION.GTID_NEXT_LIST= '$idf:4 -10:1-20';
SELECT @@SESSION.GTID_NEXT_LIST;

eval SET @@SESSION.GTID_NEXT_LIST= '$ida:4- 10:8-20';
SELECT @@SESSION.GTID_NEXT_LIST;

eval SET @@SESSION.GTID_NEXT_LIST= '$idb:4-10 :4-20';
SELECT @@SESSION.GTID_NEXT_LIST;

eval SET @@SESSION.GTID_NEXT_LIST= '$idc:4-10:15-20:11-14 ';
SELECT @@SESSION.GTID_NEXT_LIST;

eval SET @@SESSION.GTID_NEXT_LIST= '$idd
: 1 - 10,
$ide$tab:$tab 11 -$tab 20$tab';
SELECT @@SESSION.GTID_NEXT_LIST;

eval SET @@SESSION.GTID_NEXT_LIST= '$ida:1,$idb:2,$idc:3';
SELECT @@SESSION.GTID_NEXT_LIST;

eval SET @@SESSION.GTID_NEXT_LIST= '$idc:1,$idb:2,$ida:3';
SELECT @@SESSION.GTID_NEXT_LIST;
}

--echo ==== Conditions when all variables are settable / readonly ====

# GTID_HAS_ONGOING_SUPER_GROUP is read-only
SELECT @@SESSION.GTID_HAS_ONGOING_SUPER_GROUP;
# Read-only.
--error ER_INCORRECT_GLOBAL_LOCAL_VAR
SET GTID_HAS_ONGOING_SUPER_GROUP= 1;
--error ER_INCORRECT_GLOBAL_LOCAL_VAR
SELECT @@GLOBAL.GTID_HAS_ONGOING_SUPER_GROUP;

SET GTID_NEXT_LIST = NULL, GTID_NEXT = 'AUTOMATIC', GTID_END = 0, GTID_COMMIT = 0;

--eval CREATE FUNCTION f() RETURNS INT BEGIN RETURN 1; END
CREATE TABLE t1 (a INT);
CREATE USER nonsuper@localhost;
GRANT SELECT ON *.* TO nonsuper@localhost;
--connect (nonsuper,localhost,nonsuper,,)
--connection default

# is session-only
--error ER_INCORRECT_GLOBAL_LOCAL_VAR
eval SELECT @@GLOBAL.GTID_NEXT;
--error ER_LOCAL_VARIABLE
eval SET @@GLOBAL.GTID_NEXT= '$ida:1';

--error ER_INCORRECT_GLOBAL_LOCAL_VAR
eval SELECT @@GLOBAL.GTID_NEXT_LIST;
--error ER_LOCAL_VARIABLE
eval SET @@GLOBAL.GTID_NEXT_LIST= '$ida:1';

# can't set value from stored function
--eval CREATE FUNCTION set_var() RETURNS INT BEGIN SET @@SESSION.GTID_NEXT = '$ida:1'; RETURN 1; END
--error ER_VARIABLE_NOT_SETTABLE_IN_SF_OR_TRIGGER
SELECT set_var();
DROP FUNCTION set_var;

--eval CREATE FUNCTION set_var() RETURNS INT BEGIN SET @@SESSION.GTID_NEXT_LIST = '$ida:1'; RETURN 1; END
--error ER_VARIABLE_NOT_SETTABLE_IN_SF_OR_TRIGGER
SELECT set_var();
DROP FUNCTION set_var;

# can't set value from trigger
eval CREATE TRIGGER t BEFORE INSERT ON t1 FOR EACH ROW SET @@SESSION.GTID_NEXT = '$ida:1';
--error ER_VARIABLE_NOT_SETTABLE_IN_SF_OR_TRIGGER
INSERT INTO t1 VALUES (1);
DROP TRIGGER t;

# can't set value from trigger
eval CREATE TRIGGER t BEFORE INSERT ON t1 FOR EACH ROW SET @@SESSION.GTID_NEXT_LIST = '$ida:1';
--error ER_VARIABLE_NOT_SETTABLE_IN_SF_OR_TRIGGER
INSERT INTO t1 VALUES (1);
DROP TRIGGER t;

# can't set value when invoking SF
--error ER_SET_STATEMENT_CANNOT_INVOKE_FUNCTION
SET @@SESSION.GTID_NEXT = f()

--error ER_SET_STATEMENT_CANNOT_INVOKE_FUNCTION
SET @@SESSION.GTID_NEXT_LIST = f()

# must be SUPER
--connection nonsuper

--error ER_SPECIFIC_ACCESS_DENIED_ERROR
eval SET @@SESSION.GTID_NEXT = '$ida:1';

--error ER_SPECIFIC_ACCESS_DENIED_ERROR
eval SET @@SESSION.GTID_NEXT_LIST = '$ida:1';

# can read even if non-SUPER
SELECT @@SESSION.GTID_NEXT;
SELECT @@SESSION.GTID_NEXT_LIST;

DROP TABLE t1, variables;
DROP FUNCTION f;
DROP USER nonsuper@localhost;

SET GTID_NEXT_LIST = NULL;

# It is (unfortunately) possible to set the value from a stored
# procedure.  No user should do this, it's just weird, but was hard
# to prevent so instead we allow it.  Although this is unsupported, we
# have to check that at least there is no crash.
SET GTID_NEXT_LIST = NULL, GTID_NEXT = 'AUTOMATIC', GTID_END = 0, GTID_COMMIT = 0;
--delimiter |
eval CREATE PROCEDURE p ()
BEGIN
  SET @@SESSION.GTID_NEXT_LIST = '$ida:1-10';
  SET @@SESSION.GTID_NEXT = '$ida:50';
  SET @@SESSION.GTID_NEXT = '$ida:5';
  SET @@SESSION.GTID_NEXT_LIST = NULL;
  SET @@SESSION.GTID_NEXT = 'AUTOMATIC';
END|
--delimiter ;
CALL p();
DROP PROCEDURE p;

--echo ==== Conditions for combinations of GTID_NEXT and GTID_NEXT_LIST ====

# Cannot set gtid_next outside master-super-group, inside a transaction
SET GTID_NEXT_LIST = NULL;
BEGIN;
  --error ER_VARIABLE_NOT_SETTABLE_IN_TRANSACTION
  eval SET GTID_NEXT_LIST = '$ida:1';
  --error ER_VARIABLE_NOT_SETTABLE_IN_TRANSACTION
  eval SET GTID_NEXT = '$ida:1';
COMMIT;

# Cannot start master-super-group when gtid_next and gtid_next_list
# are incompatible.
eval SET @@SESSION.GTID_NEXT_LIST = '$ida:1', @@SESSION.GTID_NEXT = '$ida:2';
--error ER_GTID_NEXT_IS_NOT_IN_GTID_NEXT_LIST
BEGIN;

# In a master-super-group where gtid_next_list != NULL, gtid_next can
# be set to values specified in gtid_next_list or to ANONYMOUS, but
# not to AUTOMATIC or to values outside gtid_next_list.
# gtid_next_list cannot be changed.
eval SET @@SESSION.GTID_NEXT_LIST = '$ida:1-2', @@SESSION.GTID_NEXT = '$ida:1';
COMMIT; # start master-super-group

eval SET @@SESSION.GTID_NEXT = '$ida:3';
--error ER_GTID_NEXT_IS_NOT_IN_GTID_NEXT_LIST
COMMIT;
eval SET @@SESSION.GTID_NEXT = 'AUTOMATIC';
--error ER_GTID_NEXT_CANT_BE_AUTOMATIC_IF_GTID_NEXT_LIST_IS_NON_NULL
COMMIT;

eval SET @@SESSION.GTID_NEXT = '$ida:1';
COMMIT;
eval SET @@SESSION.GTID_NEXT = '$ida:2';
COMMIT;
eval SET @@SESSION.GTID_NEXT = 'ANONYMOUS';
COMMIT;

--error ER_CANT_CHANGE_GTID_NEXT_LIST_IN_SUPER_GROUP
eval SET @@SESSION.GTID_NEXT_LIST = '$ida:1-2';
--error ER_CANT_CHANGE_GTID_NEXT_LIST_IN_SUPER_GROUP
eval SET @@SESSION.GTID_NEXT_LIST = '$ida:2';
--error ER_CANT_CHANGE_GTID_NEXT_LIST_IN_SUPER_GROUP
eval SET @@SESSION.GTID_NEXT_LIST = NULL;

SET @@SESSION.GTID_COMMIT = 1;
COMMIT; # end master-super-group

# It is allowed to set gtid_next_list to an empty string.
#eval SET @@SESSION.GTID_COMMIT = 0, @@SESSION.GTID_NEXT_LIST = '', @@SESSION.GTID_NEXT = '$ida:1';
#--error ER_GTID_NEXT_IS_NOT_IN_GTID_NEXT_LIST
#COMMIT;
eval SET @@SESSION.GTID_NEXT = 'ANONYMOUS', @@SESSION.GTID_COMMIT = 1;
COMMIT; # end master-super-group

# In a master-super-group where gtid_next_list == NULL, neither
# gtid_next nor gtid_next_list is settable.

#eval SET @@SESSION.GTID_NEXT_LIST = NULL, @@SESSION.GTID_NEXT = '$ida:1', @@SESSION.GTID_COMMIT = 0;
#COMMIT; # start master-super-group
#SELECT @@SESSION.GTID_NEXT_LIST;
#--error ER_CANT_CHANGE_GTID_NEXT_IN_SUPER_GROUP_WHEN_GTID_NEXT_LIST_IS_NULL
#eval SET @@SESSION.GTID_NEXT = '$ida:1';
--error ER_CANT_CHANGE_GTID_NEXT_LIST_IN_SUPER_GROUP
eval SET @@SESSION.GTID_NEXT_LIST = NULL;
--error ER_CANT_CHANGE_GTID_NEXT_LIST_IN_SUPER_GROUP
eval SET @@SESSION.GTID_NEXT_LIST = '$ida:1';
SET @@SESSION.GTID_COMMIT = 1;
COMMIT; # end master-super-group

# If GTID_NEXT_LIST == NULL and GTID_NEXT == SID:GNO, then it is not
# allowed to have GTID_END = 1 unless GTID_COMMIT = 1.
#eval SET @@SESSION.GTID_NEXT_LIST = NULL, @@SESSION.GTID_NEXT = '$ida:1', @@SESSION.GTID_END = 1, @@SESSION.GTID_COMMIT = 0;
#--error 1757
#COMMIT;

#SET @@SESSION.GTID_COMMIT = 0, @@SESSION.GTID_NEXT = AUTOMATIC, @@SESSION.GTID_NEXT_LIST = NULL;

--echo ==== Conditions for executing transactions ====

# one group split over two super-groups
eval SET GTID_NEXT = '$ida:1', GTID_END = 0, GTID_COMMIT = 1;
COMMIT;
SET GTID_END = 1;
COMMIT;

# if you try to re-execute the group after it has been ended, it
# should be skipped and a warning should be generated
COMMIT;
