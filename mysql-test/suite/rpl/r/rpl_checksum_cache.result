stop slave;
drop table if exists t1,t2,t3,t4,t5,t6,t7,t8,t9;
reset master;
reset slave;
drop table if exists t1,t2,t3,t4,t5,t6,t7,t8,t9;
start slave;
call mtr.add_suppression('Unsafe statement binlogged in statement format since BINLOG_FORMAT = STATEMENT. Reason for unsafeness: Statement uses a system function');
set @@global.binlog_cache_size=4096;
set @@global.binlog_checksum=1;
flush status;
show status like "binlog_cache_use";
Variable_name	Value
Binlog_cache_use	0
show status like "binlog_cache_disk_use";
Variable_name	Value
Binlog_cache_disk_use	0
drop table if exists t1;
create table t1 (a int, b CHAR(32)) engine=innodb;
show status like "binlog_cache_use";
Variable_name	Value
Binlog_cache_use	2
*** binlog_cache_disk_use must be non-zero ***
show status like "binlog_cache_disk_use";
Variable_name	Value
Binlog_cache_disk_use	1
Comparing tables master:test.t1 and slave:test.t1
begin;
delete from t1;
commit;
flush status;
create table t2(a int auto_increment primary key, data VARCHAR(12288)) ENGINE=Innodb;
show status like "binlog_cache_use";
Variable_name	Value
Binlog_cache_use	2
*** binlog_cache_disk_use must be non-zero ***
show status like "binlog_cache_disk_use";
Variable_name	Value
Binlog_cache_disk_use	1
Comparing tables master:test.t2 and slave:test.t2
begin;
delete from t2;
commit;
flush status;
create table t3(a int auto_increment primary key, data VARCHAR(8192)) engine=innodb;
show status like "binlog_cache_use";
Variable_name	Value
Binlog_cache_use	2
*** binlog_cache_disk_use must be non-zero ***
show status like "binlog_cache_disk_use";
Variable_name	Value
Binlog_cache_disk_use	1
Comparing tables master:test.t3 and slave:test.t3
begin;
delete from t3;
commit;
flush status;
create procedure test.p1 (n int) 
begin
while n > 0 do
case (select (round(rand()*100) % 3) + 1)
when 1 then
select round(RAND() * 32) into @act_size;
set @data = repeat('a', @act_size);
insert into t1 values(n, @data);
when 2 then
begin
select round(8192 + RAND() * 4096) into @act_size;
insert into t2 set data=repeat('a', @act_size);
end;
when 3 then
begin
select round(3686.4000 + RAND() * 819.2000) into @act_size;
insert into t3 set data= repeat('a', @act_size);
end;
end case;
set n= n-1;
end while;
end|
set autocommit= 0;
call test.p1(1000);
commit;
show status like "binlog_cache_use";
Variable_name	Value
Binlog_cache_use	2
*** binlog_cache_disk_use must be non-zero ***
show status like "binlog_cache_disk_use";
Variable_name	Value
Binlog_cache_disk_use	1
Comparing tables master:test.t1 and slave:test.t1
Comparing tables master:test.t2 and slave:test.t2
Comparing tables master:test.t3 and slave:test.t3
begin;
delete from t1;
delete from t2;
delete from t3;
commit;
drop table t1, t2, t3;
End of tests
