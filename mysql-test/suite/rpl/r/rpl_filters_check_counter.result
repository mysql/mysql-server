include/master-slave.inc
Warnings:
Note	####	Sending passwords in plain text without SSL/TLS is extremely insecure.
Note	####	Storing MySQL user name or password information in the connection metadata repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START REPLICA; see the 'START REPLICA Syntax' in the MySQL Manual for more information.
[connection master]
#
# Setup filters on the Slave.
#
[connection slave]
CHANGE REPLICATION FILTER REPLICATE_REWRITE_DB=        ((db1, db2));
CHANGE REPLICATION FILTER REPLICATE_IGNORE_TABLE=      (test.itable);
CHANGE REPLICATION FILTER REPLICATE_DO_TABLE=          (test.t1, db2.t1);
CHANGE REPLICATION FILTER REPLICATE_WILD_DO_TABLE=     ('test.t%');
CHANGE REPLICATION FILTER REPLICATE_WILD_IGNORE_TABLE= ('test.i%');
CHANGE REPLICATION FILTER REPLICATE_IGNORE_DB=         (nodb);
CHANGE REPLICATION FILTER REPLICATE_DO_DB=             (test, db1, db2);

SELECT FILTER_NAME, FILTER_RULE, CONFIGURED_BY FROM performance_schema.replication_applier_global_filters ORDER BY FILTER_NAME;
FILTER_NAME	FILTER_RULE	CONFIGURED_BY
REPLICATE_DO_DB	test,db1,db2	CHANGE_REPLICATION_FILTER
REPLICATE_DO_TABLE	test.t1,db2.t1	CHANGE_REPLICATION_FILTER
REPLICATE_IGNORE_DB	nodb	CHANGE_REPLICATION_FILTER
REPLICATE_IGNORE_TABLE	test.itable	CHANGE_REPLICATION_FILTER
REPLICATE_REWRITE_DB	(db1,db2)	CHANGE_REPLICATION_FILTER
REPLICATE_WILD_DO_TABLE	test.t%	CHANGE_REPLICATION_FILTER
REPLICATE_WILD_IGNORE_TABLE	test.i%	CHANGE_REPLICATION_FILTER
SELECT FILTER_NAME, FILTER_RULE, CONFIGURED_BY, COUNTER FROM performance_schema.replication_applier_filters ORDER BY FILTER_NAME;
FILTER_NAME	FILTER_RULE	CONFIGURED_BY	COUNTER
REPLICATE_DO_DB	test,db1,db2	CHANGE_REPLICATION_FILTER	0
REPLICATE_DO_TABLE	test.t1,db2.t1	CHANGE_REPLICATION_FILTER	0
REPLICATE_IGNORE_DB	nodb	CHANGE_REPLICATION_FILTER	0
REPLICATE_IGNORE_TABLE	test.itable	CHANGE_REPLICATION_FILTER	0
REPLICATE_REWRITE_DB	(db1,db2)	CHANGE_REPLICATION_FILTER	0
REPLICATE_WILD_DO_TABLE	test.t%	CHANGE_REPLICATION_FILTER	0
REPLICATE_WILD_IGNORE_TABLE	test.i%	CHANGE_REPLICATION_FILTER	0
include/start_slave.inc
#
# Execute transactions on the Master.
#
[connection master]
CREATE TABLE test.t1 (a INT);
CREATE TABLE test.t2 (a INT);
CREATE TABLE test.itable (a INT);
CREATE TABLE test.itable2 (a INT);
CREATE DATABASE db1;
CREATE DATABASE db2;
CREATE DATABASE nodb;
USE nodb;
CREATE TABLE t1 (a INT);
USE db1;
CREATE TABLE t1 (a INT);
USE test;
BEGIN;
USE test;
INSERT INTO test.t1 VALUES (1);
USE test;
UPDATE test.t1 SET a=2 WHERE a=1;
USE test;
DELETE FROM test.t1;
USE db1;
INSERT INTO db1.t1 VALUES (1);
USE db1;
UPDATE db1.t1 SET a=2 WHERE a=1;
USE db1;
DELETE FROM db1.t1;
USE nodb;
INSERT INTO nodb.t1 VALUES (1);
USE test;
INSERT INTO test.t2 VALUES (1);
USE test;
INSERT INTO test.itable VALUES (1);
USE test;
INSERT INTO test.itable2 SELECT * FROM nodb.t1;
COMMIT;
XA START 'xa1';
INSERT INTO t1 VALUES (2);
INSERT INTO t1 VALUES (3);
XA END 'xa1';
XA PREPARE 'xa1';
XA COMMIT 'xa1';
XA START 'xa2';
INSERT INTO t1 VALUES (4);
XA END 'xa2';
XA PREPARE 'xa2';
XA ROLLBACK 'xa2';
DROP TABLE IF EXISTS test.t1, test.t2, test.itable, test.itable2;
DROP DATABASE db1;
DROP DATABASE db2;
DROP DATABASE nodb;
include/sync_slave_sql_with_master.inc
#
# Verify the filter couter on the Slave.
# REPLICATE_DO_DB=22,       REPLICATE_IGNORE_DB=0,     REPLICATE_DO_TABLE=12,
# REPLICATE_IGNORE_TABLE=2, REPLICATE_WILD_DO_TABLE=2,
# REPLICATE_WILD_IGNORE_TABLE=2, REPLICATE_REWRITE_DB=4.
#
SELECT FILTER_NAME, FILTER_RULE, CONFIGURED_BY FROM performance_schema.replication_applier_global_filters ORDER BY FILTER_NAME;
FILTER_NAME	FILTER_RULE	CONFIGURED_BY
REPLICATE_DO_DB	test,db1,db2	CHANGE_REPLICATION_FILTER
REPLICATE_DO_TABLE	test.t1,db2.t1	CHANGE_REPLICATION_FILTER
REPLICATE_IGNORE_DB	nodb	CHANGE_REPLICATION_FILTER
REPLICATE_IGNORE_TABLE	test.itable	CHANGE_REPLICATION_FILTER
REPLICATE_REWRITE_DB	(db1,db2)	CHANGE_REPLICATION_FILTER
REPLICATE_WILD_DO_TABLE	test.t%	CHANGE_REPLICATION_FILTER
REPLICATE_WILD_IGNORE_TABLE	test.i%	CHANGE_REPLICATION_FILTER
SELECT FILTER_NAME, FILTER_RULE, CONFIGURED_BY, COUNTER FROM performance_schema.replication_applier_filters ORDER BY FILTER_NAME;
FILTER_NAME	FILTER_RULE	CONFIGURED_BY	COUNTER
REPLICATE_DO_DB	test,db1,db2	CHANGE_REPLICATION_FILTER	22
REPLICATE_DO_TABLE	test.t1,db2.t1	CHANGE_REPLICATION_FILTER	12
REPLICATE_IGNORE_DB	nodb	CHANGE_REPLICATION_FILTER	0
REPLICATE_IGNORE_TABLE	test.itable	CHANGE_REPLICATION_FILTER	2
REPLICATE_REWRITE_DB	(db1,db2)	CHANGE_REPLICATION_FILTER	4
REPLICATE_WILD_DO_TABLE	test.t%	CHANGE_REPLICATION_FILTER	2
REPLICATE_WILD_IGNORE_TABLE	test.i%	CHANGE_REPLICATION_FILTER	2
#
# Clean up and Verify filter couter after unsetting the rules. Expect 0 count.
#
include/stop_slave.inc
CHANGE REPLICATION FILTER REPLICATE_REWRITE_DB=        ();
CHANGE REPLICATION FILTER REPLICATE_IGNORE_TABLE=      ();
CHANGE REPLICATION FILTER REPLICATE_DO_TABLE=          ();
CHANGE REPLICATION FILTER REPLICATE_WILD_DO_TABLE=     ();
CHANGE REPLICATION FILTER REPLICATE_WILD_IGNORE_TABLE= ();
CHANGE REPLICATION FILTER REPLICATE_IGNORE_DB=         ();
CHANGE REPLICATION FILTER REPLICATE_DO_DB=             ();

SELECT FILTER_NAME, FILTER_RULE, CONFIGURED_BY FROM performance_schema.replication_applier_global_filters ORDER BY FILTER_NAME;
FILTER_NAME	FILTER_RULE	CONFIGURED_BY
REPLICATE_DO_DB		CHANGE_REPLICATION_FILTER
REPLICATE_DO_TABLE		CHANGE_REPLICATION_FILTER
REPLICATE_IGNORE_DB		CHANGE_REPLICATION_FILTER
REPLICATE_IGNORE_TABLE		CHANGE_REPLICATION_FILTER
REPLICATE_REWRITE_DB		CHANGE_REPLICATION_FILTER
REPLICATE_WILD_DO_TABLE		CHANGE_REPLICATION_FILTER
REPLICATE_WILD_IGNORE_TABLE		CHANGE_REPLICATION_FILTER
SELECT FILTER_NAME, FILTER_RULE, CONFIGURED_BY, COUNTER FROM performance_schema.replication_applier_filters ORDER BY FILTER_NAME;
FILTER_NAME	FILTER_RULE	CONFIGURED_BY	COUNTER
REPLICATE_DO_DB		CHANGE_REPLICATION_FILTER	0
REPLICATE_DO_TABLE		CHANGE_REPLICATION_FILTER	0
REPLICATE_IGNORE_DB		CHANGE_REPLICATION_FILTER	0
REPLICATE_IGNORE_TABLE		CHANGE_REPLICATION_FILTER	0
REPLICATE_REWRITE_DB		CHANGE_REPLICATION_FILTER	0
REPLICATE_WILD_DO_TABLE		CHANGE_REPLICATION_FILTER	0
REPLICATE_WILD_IGNORE_TABLE		CHANGE_REPLICATION_FILTER	0
include/start_slave.inc
include/rpl_end.inc
