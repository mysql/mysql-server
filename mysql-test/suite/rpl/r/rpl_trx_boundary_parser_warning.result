include/master-slave.inc
Warnings:
Note	####	Sending passwords in plain text without SSL/TLS is extremely insecure.
Note	####	Storing MySQL user name or password information in the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START SLAVE; see the 'START SLAVE Syntax' in the MySQL Manual for more information.
[connection master]
[connection slave]
call mtr.add_suppression("An unexpected event sequence was detected by the IO thread");
call mtr.add_suppression("GTID_LOG_EVENT is not expected");
call mtr.add_suppression("QUERY.* is not expected in an event stream");
include/stop_slave.inc
CHANGE MASTER TO MASTER_AUTO_POSITION= 0;
[connection master]
SET @var= 10;
CREATE EVENT ev1 ON SCHEDULE EVERY @var HOUR DO INSERT INTO t1 VALUES (0);
CREATE TABLE t1 (c1 INT) ENGINE= InnoDB;
INSERT INTO t1 VALUES (1);
CREATE TABLE t2 (c1 INT) ENGINE= MyISAM;
INSERT INTO t2 VALUES (1);
include/show_binlog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
master-bin.000001	#	Previous_gtids	#	#	
master-bin.000001	#	Gtid	#	#	SET @@SESSION.GTID_NEXT= 'Gtid_set'
master-bin.000001	#	User var	#	#	@`var`=10
master-bin.000001	#	Query	#	#	use `test`; CREATE DEFINER=`root`@`localhost` EVENT ev1 ON SCHEDULE EVERY @var HOUR DO INSERT INTO t1 VALUES (0)
master-bin.000001	#	Gtid	#	#	SET @@SESSION.GTID_NEXT= 'Gtid_set'
master-bin.000001	#	Query	#	#	use `test`; CREATE TABLE t1 (c1 INT) ENGINE= InnoDB
master-bin.000001	#	Gtid	#	#	SET @@SESSION.GTID_NEXT= 'Gtid_set'
master-bin.000001	#	Query	#	#	BEGIN
master-bin.000001	#	Query	#	#	use `test`; INSERT INTO t1 VALUES (1)
master-bin.000001	#	Xid	#	#	COMMIT /* XID */
master-bin.000001	#	Gtid	#	#	SET @@SESSION.GTID_NEXT= 'Gtid_set'
master-bin.000001	#	Query	#	#	use `test`; CREATE TABLE t2 (c1 INT) ENGINE= MyISAM
master-bin.000001	#	Gtid	#	#	SET @@SESSION.GTID_NEXT= 'Gtid_set'
master-bin.000001	#	Query	#	#	BEGIN
master-bin.000001	#	Query	#	#	use `test`; INSERT INTO t2 VALUES (1)
master-bin.000001	#	Query	#	#	COMMIT
[connection slave]
# Adding debug point 'pause_on_queuing_event' to @@GLOBAL.debug
START SLAVE IO_THREAD;
# This is the event #3 of current slave relay log file
include/show_relaylog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
slave-relay-bin.000002	#	Rotate	#	#	master-bin.000001;pos=POS
# This is the event #4 of current slave relay log file
include/show_relaylog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
slave-relay-bin.000002	#	Format_desc	#	#	SERVER_VERSION, BINLOG_VERSION
# This is the event #5 of current slave relay log file
include/show_relaylog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
slave-relay-bin.000002	#	Gtid	#	#	SET @@SESSION.GTID_NEXT= 'Gtid_set'
# This is the event #6 of current slave relay log file
include/show_relaylog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
slave-relay-bin.000002	#	User var	#	#	@`var`=10
# This is the event #7 of current slave relay log file
include/show_relaylog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
slave-relay-bin.000002	#	Query	#	#	use `test`; CREATE DEFINER=`root`@`localhost` EVENT ev1 ON SCHEDULE EVERY @var HOUR DO INSERT INTO t1 VALUES (0)
# This is the event #8 of current slave relay log file
include/show_relaylog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
slave-relay-bin.000002	#	Gtid	#	#	SET @@SESSION.GTID_NEXT= 'Gtid_set'
# This is the event #9 of current slave relay log file
include/show_relaylog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
slave-relay-bin.000002	#	Query	#	#	use `test`; CREATE TABLE t1 (c1 INT) ENGINE= InnoDB
# This is the event #10 of current slave relay log file
include/show_relaylog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
slave-relay-bin.000002	#	Gtid	#	#	SET @@SESSION.GTID_NEXT= 'Gtid_set'
# This is the event #11 of current slave relay log file
include/show_relaylog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
slave-relay-bin.000002	#	Query	#	#	BEGIN
# This is the event #12 of current slave relay log file
include/show_relaylog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
slave-relay-bin.000002	#	Query	#	#	use `test`; INSERT INTO t1 VALUES (1)
# This is the event #13 of current slave relay log file
include/show_relaylog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
slave-relay-bin.000002	#	Xid	#	#	COMMIT /* XID */
# This is the event #14 of current slave relay log file
include/show_relaylog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
slave-relay-bin.000002	#	Gtid	#	#	SET @@SESSION.GTID_NEXT= 'Gtid_set'
# This is the event #15 of current slave relay log file
include/show_relaylog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
slave-relay-bin.000002	#	Query	#	#	use `test`; CREATE TABLE t2 (c1 INT) ENGINE= MyISAM
# This is the event #16 of current slave relay log file
include/show_relaylog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
slave-relay-bin.000002	#	Gtid	#	#	SET @@SESSION.GTID_NEXT= 'Gtid_set'
# This is the event #17 of current slave relay log file
include/show_relaylog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
slave-relay-bin.000002	#	Query	#	#	BEGIN
# This is the event #18 of current slave relay log file
include/show_relaylog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
slave-relay-bin.000002	#	Query	#	#	use `test`; INSERT INTO t2 VALUES (1)
# Removing debug point 'pause_on_queuing_event' from @@GLOBAL.debug
[connection master]
include/sync_slave_io_with_master.inc
# This is the event #19 of current slave relay log file
include/show_relaylog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
slave-relay-bin.000002	#	Query	#	#	COMMIT

#
# Case 1: GTID_LOG_EVENT is not expected in an event stream after a GTID_LOG_EVENT.
#
# Cleaning up and reseting the slave
include/sync_slave_io_with_master.inc
include/stop_slave.inc
# Adding debug point 'pause_on_queuing_event' to @@GLOBAL.debug
START SLAVE IO_THREAD;
# Removing debug point 'pause_on_queuing_event' from @@GLOBAL.debug
# Adding debug point 'stop_io_after_queuing_event' to @@GLOBAL.debug
include/wait_for_slave_io_to_stop.inc
# Stopped IO thread after queuing the following event (#8):
include/show_relaylog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
slave-relay-bin.000003	#	Gtid	#	#	SET @@SESSION.GTID_NEXT= 'Gtid_set'
include/rpl_stop_server.inc [server_number=2]
# Restoring a master.info.backup to start asking events at event #8
include/rpl_start_server.inc [server_number=2]
include/start_slave_io.inc
include/sync_slave_io_with_master.inc
# Restarted queuing the following event (#8):
include/show_relaylog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
slave-relay-bin.000005	#	Gtid	#	#	SET @@SESSION.GTID_NEXT= 'Gtid_set'
Found the expected warning log line: GTID_LOG_EVENT is not expected in an event stream after a GTID_LOG_EVENT.

#
# Case 2: GTID_LOG_EVENT is not expected in an event stream in the middle of a DDL.
#
# Cleaning up and reseting the slave
include/sync_slave_io_with_master.inc
include/stop_slave.inc
# Adding debug point 'pause_on_queuing_event' to @@GLOBAL.debug
START SLAVE IO_THREAD;
# Removing debug point 'pause_on_queuing_event' from @@GLOBAL.debug
# Adding debug point 'stop_io_after_queuing_event' to @@GLOBAL.debug
include/wait_for_slave_io_to_stop.inc
# Stopped IO thread after queuing the following event (#6):
include/show_relaylog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
slave-relay-bin.000003	#	User var	#	#	@`var`=10
include/rpl_stop_server.inc [server_number=2]
# Restoring a master.info.backup to start asking events at event #8
include/rpl_start_server.inc [server_number=2]
include/start_slave_io.inc
include/sync_slave_io_with_master.inc
# Restarted queuing the following event (#8):
include/show_relaylog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
slave-relay-bin.000005	#	Gtid	#	#	SET @@SESSION.GTID_NEXT= 'Gtid_set'
Found the expected warning log line: GTID_LOG_EVENT is not expected in an event stream in the middle of a DDL.

#
# Case 3: GTID_LOG_EVENT is not expected in an event stream in the middle of a DML.
#
# Cleaning up and reseting the slave
include/sync_slave_io_with_master.inc
include/stop_slave.inc
# Adding debug point 'pause_on_queuing_event' to @@GLOBAL.debug
START SLAVE IO_THREAD;
# Removing debug point 'pause_on_queuing_event' from @@GLOBAL.debug
# Adding debug point 'stop_io_after_queuing_event' to @@GLOBAL.debug
include/wait_for_slave_io_to_stop.inc
# Stopped IO thread after queuing the following event (#11):
include/show_relaylog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
slave-relay-bin.000003	#	Query	#	#	BEGIN
include/rpl_stop_server.inc [server_number=2]
# Restoring a master.info.backup to start asking events at event #10
include/rpl_start_server.inc [server_number=2]
include/start_slave_io.inc
include/sync_slave_io_with_master.inc
# Restarted queuing the following event (#10):
include/show_relaylog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
slave-relay-bin.000005	#	Gtid	#	#	SET @@SESSION.GTID_NEXT= 'Gtid_set'
Found the expected warning log line: GTID_LOG_EVENT is not expected in an event stream in the middle of a DML.

#
# Case 4: QUERY(BEGIN) is not expected in an event stream in the middle of a DDL.
#
# Cleaning up and reseting the slave
include/sync_slave_io_with_master.inc
include/stop_slave.inc
# Adding debug point 'pause_on_queuing_event' to @@GLOBAL.debug
START SLAVE IO_THREAD;
# Removing debug point 'pause_on_queuing_event' from @@GLOBAL.debug
# Adding debug point 'stop_io_after_queuing_event' to @@GLOBAL.debug
include/wait_for_slave_io_to_stop.inc
# Stopped IO thread after queuing the following event (#6):
include/show_relaylog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
slave-relay-bin.000003	#	User var	#	#	@`var`=10
include/rpl_stop_server.inc [server_number=2]
# Restoring a master.info.backup to start asking events at event #11
include/rpl_start_server.inc [server_number=2]
include/start_slave_io.inc
include/sync_slave_io_with_master.inc
# Restarted queuing the following event (#11):
include/show_relaylog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
slave-relay-bin.000005	#	Query	#	#	BEGIN
Found the expected warning log line: QUERY(BEGIN) is not expected in an event stream in the middle of a DDL.

#
# Case 5: QUERY(BEGIN) is not expected in an event stream in the middle of a DML.
#
# Cleaning up and reseting the slave
include/sync_slave_io_with_master.inc
include/stop_slave.inc
# Adding debug point 'pause_on_queuing_event' to @@GLOBAL.debug
START SLAVE IO_THREAD;
# Removing debug point 'pause_on_queuing_event' from @@GLOBAL.debug
# Adding debug point 'stop_io_after_queuing_event' to @@GLOBAL.debug
include/wait_for_slave_io_to_stop.inc
# Stopped IO thread after queuing the following event (#11):
include/show_relaylog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
slave-relay-bin.000003	#	Query	#	#	BEGIN
include/rpl_stop_server.inc [server_number=2]
# Restoring a master.info.backup to start asking events at event #11
include/rpl_start_server.inc [server_number=2]
include/start_slave_io.inc
include/sync_slave_io_with_master.inc
# Restarted queuing the following event (#11):
include/show_relaylog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
slave-relay-bin.000005	#	Query	#	#	BEGIN
Found the expected warning log line: QUERY(BEGIN) is not expected in an event stream in the middle of a DML.

#
# Case 6.a: QUERY(COMMIT or ROLLBACK) or XID_LOG_EVENT is not expected in an event stream outside a transaction.
#
# Cleaning up and reseting the slave
include/sync_slave_io_with_master.inc
include/stop_slave.inc
# Adding debug point 'pause_on_queuing_event' to @@GLOBAL.debug
START SLAVE IO_THREAD;
# Removing debug point 'pause_on_queuing_event' from @@GLOBAL.debug
# Adding debug point 'stop_io_after_queuing_event' to @@GLOBAL.debug
include/wait_for_slave_io_to_stop.inc
# Stopped IO thread after queuing the following event (#9):
include/show_relaylog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
slave-relay-bin.000003	#	Query	#	#	use `test`; CREATE TABLE t1 (c1 INT) ENGINE= InnoDB
include/rpl_stop_server.inc [server_number=2]
# Restoring a master.info.backup to start asking events at event #13
include/rpl_start_server.inc [server_number=2]
include/start_slave_io.inc
include/sync_slave_io_with_master.inc
# Restarted queuing the following event (#13):
include/show_relaylog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
slave-relay-bin.000005	#	Xid	#	#	COMMIT /* XID */
Found the expected warning log line: QUERY(COMMIT or ROLLBACK) or XID_LOG_EVENT is not expected in an event stream outside a transaction.

#
# Case 6.b: QUERY(COMMIT or ROLLBACK) or XID_LOG_EVENT is not expected in an event stream outside a transaction.
#
# Cleaning up and reseting the slave
include/sync_slave_io_with_master.inc
include/stop_slave.inc
# Adding debug point 'pause_on_queuing_event' to @@GLOBAL.debug
START SLAVE IO_THREAD;
# Removing debug point 'pause_on_queuing_event' from @@GLOBAL.debug
# Adding debug point 'stop_io_after_queuing_event' to @@GLOBAL.debug
include/wait_for_slave_io_to_stop.inc
# Stopped IO thread after queuing the following event (#9):
include/show_relaylog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
slave-relay-bin.000003	#	Query	#	#	use `test`; CREATE TABLE t1 (c1 INT) ENGINE= InnoDB
include/rpl_stop_server.inc [server_number=2]
# Restoring a master.info.backup to start asking events at event #19
include/rpl_start_server.inc [server_number=2]
include/start_slave_io.inc
include/sync_slave_io_with_master.inc
# Restarted queuing the following event (#19):
include/show_relaylog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
slave-relay-bin.000005	#	Query	#	#	COMMIT
Found the expected warning log line: QUERY(COMMIT or ROLLBACK) or XID_LOG_EVENT is not expected in an event stream outside a transaction.

#
# Case 7.a: QUERY(COMMIT or ROLLBACK) or XID_LOG_EVENT is not expected in an event stream after a GTID_LOG_EVENT.
#
# Cleaning up and reseting the slave
include/sync_slave_io_with_master.inc
include/stop_slave.inc
# Adding debug point 'pause_on_queuing_event' to @@GLOBAL.debug
START SLAVE IO_THREAD;
# Removing debug point 'pause_on_queuing_event' from @@GLOBAL.debug
# Adding debug point 'stop_io_after_queuing_event' to @@GLOBAL.debug
include/wait_for_slave_io_to_stop.inc
# Stopped IO thread after queuing the following event (#8):
include/show_relaylog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
slave-relay-bin.000003	#	Gtid	#	#	SET @@SESSION.GTID_NEXT= 'Gtid_set'
include/rpl_stop_server.inc [server_number=2]
# Restoring a master.info.backup to start asking events at event #13
include/rpl_start_server.inc [server_number=2]
include/start_slave_io.inc
include/sync_slave_io_with_master.inc
# Restarted queuing the following event (#13):
include/show_relaylog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
slave-relay-bin.000005	#	Xid	#	#	COMMIT /* XID */
Found the expected warning log line: QUERY(COMMIT or ROLLBACK) or XID_LOG_EVENT is not expected in an event stream after a GTID_LOG_EVENT.

#
# Case 7.b: QUERY(COMMIT or ROLLBACK) or XID_LOG_EVENT is not expected in an event stream after a GTID_LOG_EVENT.
#
# Cleaning up and reseting the slave
include/sync_slave_io_with_master.inc
include/stop_slave.inc
# Adding debug point 'pause_on_queuing_event' to @@GLOBAL.debug
START SLAVE IO_THREAD;
# Removing debug point 'pause_on_queuing_event' from @@GLOBAL.debug
# Adding debug point 'stop_io_after_queuing_event' to @@GLOBAL.debug
include/wait_for_slave_io_to_stop.inc
# Stopped IO thread after queuing the following event (#8):
include/show_relaylog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
slave-relay-bin.000003	#	Gtid	#	#	SET @@SESSION.GTID_NEXT= 'Gtid_set'
include/rpl_stop_server.inc [server_number=2]
# Restoring a master.info.backup to start asking events at event #19
include/rpl_start_server.inc [server_number=2]
include/start_slave_io.inc
include/sync_slave_io_with_master.inc
# Restarted queuing the following event (#19):
include/show_relaylog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
slave-relay-bin.000005	#	Query	#	#	COMMIT
Found the expected warning log line: QUERY(COMMIT or ROLLBACK) or XID_LOG_EVENT is not expected in an event stream after a GTID_LOG_EVENT.

#
# Case 8.a: QUERY(COMMIT or ROLLBACK) or XID_LOG_EVENT is not expected in an event stream in the middle of a DDL.
#
# Cleaning up and reseting the slave
include/sync_slave_io_with_master.inc
include/stop_slave.inc
# Adding debug point 'pause_on_queuing_event' to @@GLOBAL.debug
START SLAVE IO_THREAD;
# Removing debug point 'pause_on_queuing_event' from @@GLOBAL.debug
# Adding debug point 'stop_io_after_queuing_event' to @@GLOBAL.debug
include/wait_for_slave_io_to_stop.inc
# Stopped IO thread after queuing the following event (#6):
include/show_relaylog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
slave-relay-bin.000003	#	User var	#	#	@`var`=10
include/rpl_stop_server.inc [server_number=2]
# Restoring a master.info.backup to start asking events at event #13
include/rpl_start_server.inc [server_number=2]
include/start_slave_io.inc
include/sync_slave_io_with_master.inc
# Restarted queuing the following event (#13):
include/show_relaylog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
slave-relay-bin.000005	#	Xid	#	#	COMMIT /* XID */
Found the expected warning log line: QUERY(COMMIT or ROLLBACK) or XID_LOG_EVENT is not expected in an event stream in the middle of a DDL.

#
# Case 8.b: QUERY(COMMIT or ROLLBACK) or XID_LOG_EVENT is not expected in an event stream in the middle of a DDL.
#
# Cleaning up and reseting the slave
include/sync_slave_io_with_master.inc
include/stop_slave.inc
# Adding debug point 'pause_on_queuing_event' to @@GLOBAL.debug
START SLAVE IO_THREAD;
# Removing debug point 'pause_on_queuing_event' from @@GLOBAL.debug
# Adding debug point 'stop_io_after_queuing_event' to @@GLOBAL.debug
include/wait_for_slave_io_to_stop.inc
# Stopped IO thread after queuing the following event (#6):
include/show_relaylog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
slave-relay-bin.000003	#	User var	#	#	@`var`=10
include/rpl_stop_server.inc [server_number=2]
# Restoring a master.info.backup to start asking events at event #19
include/rpl_start_server.inc [server_number=2]
include/start_slave_io.inc
include/sync_slave_io_with_master.inc
# Restarted queuing the following event (#19):
include/show_relaylog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
slave-relay-bin.000005	#	Query	#	#	COMMIT
Found the expected warning log line: QUERY(COMMIT or ROLLBACK) or XID_LOG_EVENT is not expected in an event stream in the middle of a DDL.

#
# Prepare the slave to correctly replicate again after the test case
#
include/rpl_stop_server.inc [server_number=2]
include/rpl_start_server.inc [server_number=2]
[connection slave]
include/stop_slave.inc
Warnings:
Note	1970	Replication thread(s) for channel '' are already stopped.
DROP TABLE IF EXISTS t1, t2;
RESET MASTER;
RESET SLAVE;
CHANGE MASTER TO MASTER_AUTO_POSITION= 1;
include/start_slave.inc
[connection master]
DROP TABLE t1, t2;
DROP EVENT ev1;
include/rpl_end.inc
