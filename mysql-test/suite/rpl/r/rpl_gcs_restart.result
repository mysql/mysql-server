############################################################
# 1. Start servers, on which server2 has applier stopped so
# that all remote transactions are only queued on relay log.
# Execute some transactions on server1.
include/start_gcs_replication.inc
SET @@GLOBAL.DEBUG= '+d,gcs_applier_do_not_start_sql_thread';
include/start_gcs_replication.inc
include/rpl_gcs_wait_for_number_of_nodes.inc
CREATE TABLE t1 (c1 INT NOT NULL PRIMARY KEY) ENGINE=InnoDB;
INSERT INTO t1 VALUES (1);

############################################################
# 2. Restart server2 and verify that certifier sequence
# number is set from relay log certified transactions.
# restart
SET @@GLOBAL.DEBUG= '+d,gcs_assert_next_seqno_equal_3';
include/start_gcs_replication.inc
############################################################
# 3. Insert must fail with duplicate entry.
INSERT INTO t1 VALUES (1);
ERROR 23000: Duplicate entry '1' for key 'PRIMARY'
INSERT INTO t1 VALUES (2);

############################################################
# 4. Restart server2 again and verify that certifier sequence
# number is set from GTID_EXECUTED.
# restart
SET @debug_saved= @@GLOBAL.DEBUG;
SET @@GLOBAL.DEBUG= '+d,gcs_assert_next_seqno_equal_4';
include/start_gcs_replication.inc

############################################################
# 5. Shutdown.
include/rpl_gcs_wait_for_number_of_nodes.inc
DROP TABLE t1;
include/sync_slave_sql_with_master.inc
include/stop_gcs_replication.inc
RESET MASTER;
SET @@GLOBAL.DEBUG= @debug_saved;
include/stop_gcs_replication.inc
RESET MASTER;
