# ==== Purpose ====
#
# Verify that --show-replica-auth-info works as expected
#
# ==== Requiremets ====
#
# R1. When source server is started without --show-replica-auth-info or
#     --show-slave-auth-info:
#     R1.1. Server should not write deprecation warning to the error log.
#     R1.2. SHOW REPLICAS should not include USER and PASSWORD columns.
#     R1.3. SHOW REPLICAS should not include USER and PASSWORD columns.
#
# R2. When source server is started with --show-replica-auth-info:
#     R2.1. Server should not write deprecation warning to the error log.
#     R2.2. SHOW REPLICAS should include USER and PASSWORD columns.
#     R2.3. SHOW REPLICAS should include USER and PASSWORD columns.
#
# R3. When source server is started with --show-slave-auth-info:
#     R3.1. Server should write deprecation warning to the error log.
#     R3.2. SHOW REPLICAS should include USER and PASSWORD columns.
#     R3.3. SHOW REPLICAS should include USER and PASSWORD columns.

# Test is debug_binlog_format agnostic
--source include/have_binlog_format_row.inc
--source include/rpl/init_source_replica.inc

--echo ==== Init ====

# Un-suppress this message
--let $suppress_mode = IGNORE_GLOBAL_SUPPRESSIONS
--let $messages = The syntax.*show-.*-auth-info.*is deprecated
--source include/suppress_messages.inc

--let $restart = $MYSQL_TMP_DIR/restart.inc
--write_file $restart END_OF_PROCEDURE
  --source include/rpl/connection_replica.inc
  --source include/rpl/stop_replica.inc
  --let $rpl_server_number = 1
  --source include/rpl/restart_server.inc
  --source include/rpl/connection_replica.inc
  --source include/rpl/start_replica.inc
  --source include/rpl/connection_source.inc
END_OF_PROCEDURE

--source include/save_error_log_position.inc

--echo ==== R2: show-replica-auth-info ====

--let $rpl_server_parameters = --show-replica-auth-info
--source $restart

--echo * R2.1: No deprecation warning
--let $error_pattern = NONE
--source include/assert_error_log.inc

--echo * R2.1, R2.2: Have columns
--replace_result $server_2_uuid REPLICA_UUID $SLAVE_MYPORT REPLICA_PORT
SHOW REPLICAS;
--replace_result $server_2_uuid REPLICA_UUID $SLAVE_MYPORT REPLICA_PORT
SHOW REPLICAS;

--echo ==== R3: show-slave-auth-info ====

# Make sure that the following warnings were generated by the restart
# and not at some other point in time.
--let $error_pattern = NONE
--source include/assert_error_log.inc

--let $rpl_server_parameters = --show-slave-auth-info
--source $restart

--echo * R3.1: Deprecation warning
--let $error_pattern = The syntax 'show-slave-auth-info' is deprecated and will be removed in a future release. Please use show-replica-auth-info instead.
--source include/assert_error_log.inc

--echo * R3.2, R3.3: Have columns
--replace_result $server_2_uuid REPLICA_UUID $SLAVE_MYPORT REPLICA_PORT
SHOW REPLICAS;
--replace_result $server_2_uuid REPLICA_UUID $SLAVE_MYPORT REPLICA_PORT
SHOW REPLICAS;

--echo ==== R1: no command-line options ====

--let $rpl_server_parameters =
--source $restart

--echo * R1.1: No deprecation warning
--let $error_pattern = NONE
--source include/assert_error_log.inc

--echo * R1.2, R1.3: No columns
--replace_result $server_2_uuid REPLICA_UUID $SLAVE_MYPORT REPLICA_PORT
SHOW REPLICAS;
--replace_result $server_2_uuid REPLICA_UUID $SLAVE_MYPORT REPLICA_PORT
SHOW REPLICAS;

--echo ==== Clean up ====

--remove_file $restart
--source include/rpl/deinit.inc
