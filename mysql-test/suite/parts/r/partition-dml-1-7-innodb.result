SET @auto= @@global.autocommit;
SET @@global.autocommit= off;
SET @iso= @@global.transaction_isolation;
SET @@global.transaction_isolation= 'repeatable-read';
SET @completion= @@global.completion_type;
SET @@global.completion_type= 'no_chain';
SET @lock_timeout= @@global.lock_wait_timeout;
SET @@global.lock_wait_timeout= 1;
SELECT @@global.lock_wait_timeout;
@@global.lock_wait_timeout
1
SET @innodb_lock_timeout= @@global.innodb_lock_wait_timeout;
SET @@global.innodb_lock_wait_timeout= 1;
# Additional tests for WL#5217 by QA, testplan 1.1
CREATE TABLE t1 
(a INT NOT NULL,
b varchar (64),
INDEX ind_t1 (b,a),
PRIMARY KEY (a))
ENGINE = InnoDB
PARTITION BY RANGE (a)
SUBPARTITION BY HASH (a) SUBPARTITIONS 3
(PARTITION pNeg VALUES LESS THAN (0)
(SUBPARTITION subp0  ,
SUBPARTITION subp1  ,
SUBPARTITION subp2  ),
PARTITION `p0-29` VALUES LESS THAN (30)
(SUBPARTITION subp3  ,
SUBPARTITION subp4  ,
SUBPARTITION subp5  ),
PARTITION `p30-299` VALUES LESS THAN (300)
(SUBPARTITION subp6  ,
SUBPARTITION subp7  ,
SUBPARTITION subp8  ),
PARTITION `p300-2999` VALUES LESS THAN (3000)
(SUBPARTITION subp9  ,
SUBPARTITION subp10  ,
SUBPARTITION subp11  ),
PARTITION `p3000-299999` VALUES LESS THAN (300000)
(SUBPARTITION subp12  ,
SUBPARTITION subp13  ,
SUBPARTITION subp14  ));
DROP INDEX ind_t1 ON t1;
INSERT INTO t1 PARTITION (pNeg, subp0) VALUES (-4, '(pNeg-)subp0');
INSERT INTO t1 PARTITION (pNeg, subp0) VALUES (-3, '(pNeg-)subp0');
INSERT INTO t1 PARTITION (pNeg, subp0) VALUES (-2, '(pNeg-)subp0');
INSERT INTO t1 PARTITION (pNeg, subp0) VALUES (-1, '(pNeg-)subp0');
INSERT INTO t1 PARTITION (`p0-29`, subp3) VALUES (4, '(p0-29-)subp3');
INSERT INTO t1 PARTITION (`p0-29`, subp3) VALUES (3, '(p0-29-)subp3');
INSERT INTO t1 PARTITION (`p0-29`, subp3) VALUES (2, '(p0-29-)subp3');
INSERT INTO t1 PARTITION (`p0-29`, subp3) VALUES (1, '(p0-29-)subp3');
INSERT INTO t1 PARTITION (`p0-29`, subp5) VALUES (24, '(p0-29-)subp5');
INSERT INTO t1 PARTITION (`p0-29`, subp5) VALUES (23, '(p0-29-)subp5');
INSERT INTO t1 PARTITION (`p0-29`, subp5) VALUES (22, '(p0-29-)subp5');
INSERT INTO t1 PARTITION (`p0-29`, subp5) VALUES (21, '(p0-29-)subp5');
INSERT INTO t1 PARTITION (`p30-299`, subp9) VALUES (34, '(p30-299-)subp6');
INSERT INTO t1 PARTITION (`p30-299`, subp9) VALUES (33, '(p30-299-)subp6');
INSERT INTO t1 PARTITION (`p30-299`, subp9) VALUES (32, '(p30-299-)subp6');
INSERT INTO t1 PARTITION (`p30-299`, subp9) VALUES (31, '(p30-299-)subp6');
INSERT INTO t1 PARTITION (`p30-299`, subp8) VALUES (234, '(p30-299-)subp8');
INSERT INTO t1 PARTITION (`p30-299`, subp8) VALUES (233, '(p30-299-)subp8');
INSERT INTO t1 PARTITION (`p30-299`, subp8) VALUES (232, '(p30-299-)subp8');
INSERT INTO t1 PARTITION (`p30-299`, subp8) VALUES (231, '(p30-299-)subp8');
INSERT INTO t1 PARTITION (`p300-2999`, subp8) VALUES (304, '(p300-2999-)subp8');
INSERT INTO t1 PARTITION (`p300-2999`, subp8) VALUES (303, '(p300-2999-)subp8');
INSERT INTO t1 PARTITION (`p300-2999`, subp8) VALUES (302, '(p300-2999-)subp8');
INSERT INTO t1 PARTITION (`p300-2999`, subp8) VALUES (301, '(p300-2999-)subp8');
INSERT INTO t1 PARTITION (`p3000-299999`, subp12) VALUES (3004, '(p3000-299999-)subp12');
INSERT INTO t1 PARTITION (`p3000-299999`, subp12) VALUES (3003, '(p3000-299999-)subp12');
INSERT INTO t1 PARTITION (`p3000-299999`, subp12) VALUES (3002, '(p3000-299999-)subp12');
INSERT INTO t1 PARTITION (`p3000-299999`, subp12) VALUES (3001, '(p3000-299999-)subp12');
INSERT INTO t1 PARTITION (`p3000-299999`, subp14) VALUES (299996, '(p3000-299999-)subp14');
INSERT INTO t1 PARTITION (`p3000-299999`, subp14) VALUES (299997, '(p3000-299999-)subp14');
INSERT INTO t1 PARTITION (`p3000-299999`, subp14) VALUES (299998, '(p3000-299999-)subp14');
INSERT INTO t1 PARTITION (`p3000-299999`, subp14) VALUES (299999, '(p3000-299999-)subp14');
CREATE USER test_user_1 IDENTIFIED BY 'testpw';
CREATE USER test_user_2 IDENTIFIED BY 'testpw';
CREATE USER test_user_3 IDENTIFIED BY 'testpw';
GRANT ALL PRIVILEGES ON test.* TO test_user_1;
GRANT ALL PRIVILEGES ON test.* TO test_user_2;
GRANT ALL PRIVILEGES ON test.* TO test_user_3;
connect  session1, localhost, test_user_1,'testpw',test;
SELECT * FROM t1 PARTITION (`p0-29`) WHERE a BETWEEN 0 AND 9 LOCK IN SHARE MODE;
a	b
1	(p0-29-)subp3
2	(p0-29-)subp3
3	(p0-29-)subp3
4	(p0-29-)subp3
UPDATE t1 PARTITION (`p0-29`) SET b='p0-29-upd-1' WHERE a BETWEEN 0 AND 9 ;
connect  session2, localhost, test_user_2,'testpw',test;
####### expect p0-29 has not been updated
SELECT * FROM t1 PARTITION (`p0-29`);
a	b
3	(p0-29-)subp3
21	(p0-29-)subp5
24	(p0-29-)subp5
1	(p0-29-)subp3
4	(p0-29-)subp3
22	(p0-29-)subp5
2	(p0-29-)subp3
23	(p0-29-)subp5
SELECT * FROM t1 PARTITION (`p0-29`) WHERE a BETWEEN 0 AND 9 LOCK IN SHARE MODE;
ERROR HY000: Lock wait timeout exceeded; try restarting transaction
SELECT * FROM t1 PARTITION (`p0-29`) WHERE a BETWEEN 20 AND 29 FOR UPDATE;
ERROR HY000: Lock wait timeout exceeded; try restarting transaction
connection session1;
COMMIT WORK;
####### expect p0-29 (0-9) has been updated
SELECT * FROM t1 PARTITION (`p0-29`);
a	b
1	p0-29-upd-1
2	p0-29-upd-1
21	(p0-29-)subp5
22	(p0-29-)subp5
23	(p0-29-)subp5
24	(p0-29-)subp5
3	p0-29-upd-1
4	p0-29-upd-1
connection session2;
####### expect p0-29 has not been updated
SELECT * FROM t1 PARTITION (`p0-29`);
a	b
1	(p0-29-)subp3
2	(p0-29-)subp3
21	(p0-29-)subp5
22	(p0-29-)subp5
23	(p0-29-)subp5
24	(p0-29-)subp5
3	(p0-29-)subp3
4	(p0-29-)subp3
SELECT * FROM t1 PARTITION (`p0-29`) WHERE a BETWEEN 20 AND 29 FOR UPDATE;
a	b
21	(p0-29-)subp5
22	(p0-29-)subp5
23	(p0-29-)subp5
24	(p0-29-)subp5
UPDATE t1 PARTITION (`p0-29`) SET b='p0-29-upd-2' WHERE a BETWEEN 20 AND 29 ;
connection session1;
####### expect only p0-29 (0-9) has been updated
SELECT * FROM t1 PARTITION (`p0-29`);
a	b
1	p0-29-upd-1
2	p0-29-upd-1
21	(p0-29-)subp5
22	(p0-29-)subp5
23	(p0-29-)subp5
24	(p0-29-)subp5
3	p0-29-upd-1
4	p0-29-upd-1
SELECT * FROM t1 PARTITION (`p0-29`) WHERE a BETWEEN 0 AND 9 LOCK IN SHARE MODE;
ERROR HY000: Lock wait timeout exceeded; try restarting transaction
SELECT * FROM t1 PARTITION (`p0-29`) WHERE a BETWEEN 20 AND 29 FOR UPDATE;
ERROR HY000: Lock wait timeout exceeded; try restarting transaction
connection session2;
COMMIT WORK;
####### expect p0-29 is completely updated
SELECT * FROM t1 PARTITION (`p0-29`);
a	b
1	p0-29-upd-1
2	p0-29-upd-1
21	p0-29-upd-2
22	p0-29-upd-2
23	p0-29-upd-2
24	p0-29-upd-2
3	p0-29-upd-1
4	p0-29-upd-1
connection session1;
####### expect only p0-29 (0-9) has been updated
SELECT * FROM t1 PARTITION (`p0-29`);
a	b
1	p0-29-upd-1
2	p0-29-upd-1
21	(p0-29-)subp5
22	(p0-29-)subp5
23	(p0-29-)subp5
24	(p0-29-)subp5
3	p0-29-upd-1
4	p0-29-upd-1
COMMIT WORK;
####### expect p0-29 is completely updated
SELECT * FROM t1 PARTITION (`p0-29`);
a	b
1	p0-29-upd-1
2	p0-29-upd-1
21	p0-29-upd-2
22	p0-29-upd-2
23	p0-29-upd-2
24	p0-29-upd-2
3	p0-29-upd-1
4	p0-29-upd-1
disconnect session1;
disconnect session2;
connection default;
DROP TABLE t1;
DROP USER test_user_1;
DROP USER test_user_2;
DROP USER test_user_3;
SET @@global.autocommit= @auto;
SET @@global.transaction_isolation= @iso;
SET @@global.completion_type= @completion;
SET @@global.lock_wait_timeout= @lock_timeout;
SET @@global.innodb_lock_wait_timeout= @innodb_lock_timeout;
