-- source include/have_multi_ndb.inc
-- source include/have_binlog_format_mixed_or_row.inc
<<<<<<< HEAD
# Test is using some debug-only features
--source include/have_debug.inc
# Test terminates mysqld which causes valgrind warnings
--source include/not_valgrind.inc
# Ignore any mysqld failure reporting
--source include/not_crashrep.inc

--connection server1
=======
# We are using some debug-only features in this test
--source include/have_debug.inc
# Test terminates mysqld which causes valgrind warnings
--source include/not_valgrind.inc

connection server1;
# Find NodeId of the mysqld we are connected to:
--let $node_id= `SHOW STATUS LIKE 'Ndb_cluster_node_id'`
--let $node_id= `SELECT SUBSTRING('$node_id', 20)+0`
>>>>>>> pr/231
--disable_query_log
call mtr.add_suppression("cluster disconnect An incident event");
--enable_query_log

<<<<<<< HEAD
--connection server2
# Ignore server shutdown/startup errors in log
--disable_query_log
call mtr.add_suppression("Failed to setup binlog");
call mtr.add_suppression("Distribution of CREATE TABLE");
call mtr.add_suppression("Server shutdown in progress");
call mtr.add_suppression("cluster disconnect An incident event");
call mtr.add_suppression("mysqld startup an incident event");
# Reported when the --ndb-log-fail-terminate logic kicks in
call mtr.add_suppression("Requesting server shutdown");
--enable_query_log

--echo # First test, check behaviour with --ndb-log-fail-terminate=1
--echo # during metadata synchronization
--echo # - Create table
--echo # - Setup mysqld2 with DBUG error to force "binlog setup" failure
--echo # - Setup mtr.pl to expect mysqld2 to shutdown
--echo # - Use DUMP 900 to disconnect both mysqld's (node 16 and 49)
--echo # - The mysqld2 will disconnect and then shut itself down when
--echo #   hitting the DBUG error during metadata sync
--echo # - Start mysqld2 again and check things work

--connection server1
create table t1 (a int primary key) engine=ndb;
insert into t1 values (0),(1),(2),(3),(4),(5),(6),(7),(8),(9);

--connection server2
--echo # Setup mysqld2 DBUG
--echo # NOTE! since the process will restart there is no need to save value
set global debug='+d,ndb_binlog_fail_setup';

--echo # Write file to make mtr.pl expect mysqld2 shutdown, but don't start
--echo # until it's told to
--write_file $MYSQLTEST_VARDIR/tmp/mysqld.2.1.expect
wait
EOF

--echo # Disconnect both mysqld's with DUMP 900
let $out_file = $MYSQLTEST_VARDIR/tmp/mgm_dump.out;
--exec $NDB_MGM -e "ALL DUMP 900 16" > $out_file 2>&1
--exec $NDB_MGM -e "ALL DUMP 900 49" >> $out_file 2>&1
--remove_file $out_file

--echo # Wait for mysqld2 binlog rotate to indicate disconnect
--let $wait_binlog_event= binlog.000002
--source include/wait_for_binlog_event.inc

--connection server1
--echo # Wait for mysqld1 to reconnect and insert data to check it's alive
--source include/ndb_not_readonly.inc
insert into t1 values (11);

--connection server2
--echo # Wait for mysqld2 to disconnect
--source include/wait_until_disconnected.inc
--echo # mysqld2 disconnected

--echo # Write file to make mtr.pl start up mysqld2 again
--append_file $MYSQLTEST_VARDIR/tmp/mysqld.2.1.expect
restart
EOF

--echo # Wait for mysqld2 to reconnect and insert data to check it's alive
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

insert into t1 values (10);
drop table t1;

--echo # Second test, check behaviour with --ndb-log-fail-terminate=1
--echo # during CREATE TABLE
--echo # - Setup mysqld2 with DBUG error to force "binlog setup" failure
--echo # - Setup mtr.pl to expect mysqld2 to shutdown
--echo # - Create table on mysqld1
--echo # - mysqld2 will fail during schema distribution and shut itself down
--echo # - Start mysqld2 again and check things work

--connection server2
--echo # Setup mysqld2 DBUG
--echo # NOTE! since the process will restart there is no need to save value
set global debug='+d,ndb_binlog_fail_setup';

--echo # Write file to make mtr.pl expect mysqld2 shutdown, but don't start
--echo # until it's told to
--write_file $MYSQLTEST_VARDIR/tmp/mysqld.2.1.expect
wait
EOF

--connection server1
--echo # Create table from mysqld1
create table t1 (a int primary key) engine=ndb;
insert into t1 values (0),(1),(2),(3),(4),(5),(6),(7),(8),(9);

--connection server2
--echo # Wait for mysqld2 diconnect
--source include/wait_until_disconnected.inc
--echo # mysqld2 disconnected

--echo # Write file to make mtr.pl start up mysqld2 again
--append_file $MYSQLTEST_VARDIR/tmp/mysqld.2.1.expect
restart
EOF

--echo # Wait for mysqld2 to reconnect and insert data to check it's alive
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect

--source include/ndb_not_readonly.inc
insert into t1 values (10);

--connection server1
--source include/ndb_not_readonly.inc
insert into t1 values (11);
drop table t1;

#
# Check if binlog prints error message to mysql log
# When it losses connection to NDB during binlog setup
#

set GLOBAL debug="+d,ndb_binlog_fail_setup_util_table";

# Restart cluster nodes
let $out_file = $MYSQLTEST_VARDIR/tmp/mgm_dump.out;
--exec $NDB_MGM -e "all restart" >> $out_file
# Wait for all nodes to enter "started"
--exec $NDB_WAITER >> $out_file
--remove_file $out_file

#
# Wait until the connection to the
# cluster has been restored
#
--source include/ndb_not_readonly.inc

#check if there are any error message in the server log
--let $assert_file=$MYSQLTEST_VARDIR/log/mysqld.1.1.err
--let $assert_text=No error log printed when binlog setup fails
--let $assert_select=Failed to setup binlogging for table
--let $assert_count=0
--source include/assert_grep.inc
set GLOBAL debug="-d,ndb_binlog_fail_setup_util_table";
=======
connection server2;
# Find NodeId2 of 'server2' we are connected to:
--let $node_id2= `SHOW STATUS LIKE 'Ndb_cluster_node_id'`
--let $node_id2= `SELECT SUBSTRING('$node_id2', 20)+0`

# Ignore server shutdown/startup failure
--disable_query_log
call mtr.add_suppression("NDB Binlog: FAILED");
call mtr.add_suppression("NDB Binlog: ndbcluster_handle_incomplete_binlog_setup");
call mtr.add_suppression("Plugin 'ndbcluster' will be forced to shutdown");
call mtr.add_suppression("NDB Binlog: Failed setting up binlogging");
call mtr.add_suppression("TIMESTAMP");
call mtr.add_suppression("Insecure");
call mtr.add_suppression("ndbcluster_end");
call mtr.add_suppression("Attempting backtrace");
call mtr.add_suppression("An incident event has been written");
--enable_query_log

#
# 1 create a table
# 2 Setup error insert on MySQLD2
# 3 Disconnect MySQLD2 using DUMP code, causing Binlog re-init
# 4 Observe MySQLD2 fail, then restart (and succeed)
#

connection server1;
use test;

create table t1 (a int primary key) engine=ndb;
insert into t1 values (0),(1),(2),(3),(4),(5),(6),(7),(8),(9);

connection server2;
disable_query_log;
let $debug_saved = `select @@global.debug`;
set global debug='-d'; # Switch DEBUG/TRACING OFF
set global debug='+d,ndb_binlog_fail_setup';
enable_query_log;

--echo Prepare for Server2 to fail
connection server2;
# Find NodeId2 of 'server2' we are connected to:
--let $node_id2= `SHOW STATUS LIKE 'Ndb_cluster_node_id'`
--let $node_id2= `SELECT SUBSTRING('$node_id2', 20)+0`

#
# Some magic for MTR to allow failure, taken from include/restart_mysqld.inc
#
--let $_server_id= `SELECT @@server_id`
--let $_expect_file_name= $MYSQLTEST_VARDIR/tmp/mysqld.$_server_id.1.expect

--exec echo "wait" > $_expect_file_name
#
# /end magic part 1
#

#
# Cause data nodes to disconnect all API nodes
# Each API will setup binlog again
# MySQLD2 will get stuck and restart
#

--exec $NDB_MGM --no-defaults -e "ALL DUMP 900 $node_id" > $NDB_TOOLS_OUTPUT
--exec $NDB_MGM --no-defaults -e "ALL DUMP 900 $node_id2" > $NDB_TOOLS_OUTPUT

#connection server1;
#--echo Wait for 'server1' binlog rotate to indicate disconnect
#--let $wait_binlog_event= mysqld-bin.000002
#--source include/wait_for_binlog_event.inc

connection server2;
--echo Wait for 'server2' binlog rotate to indicate disconnect
--let $wait_binlog_event= mysqld-bin.000002
--source include/wait_for_binlog_event.inc

connection server1;
--source include/ndb_not_readonly.inc
insert into t1 values (11);

--echo Give 'server2' some time to start, and fail, a binlog_setup
sleep 2;

--echo Wait for Server2 to fail
connection server2;
--source include/wait_until_disconnected.inc

--echo Server2 failed as expected

#
# More magic from include/restart_mysqld.inc
#
--exec echo "restart" > $_expect_file_name

--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect
#
# /end magic part 2
#

connection server1;
insert into t1 values (10);
drop table test.t1;

connection server2;
--echo Wait for 'server2' to complete setup and get out of read-only mode
--source include/ndb_not_readonly.inc
--remove_file $NDB_TOOLS_OUTPUT

disable_query_log;
set global debug='+d'; # Switch DEBUG/TRACING ON
eval set global debug= '$debug_saved';
enable_query_log;
>>>>>>> pr/231
