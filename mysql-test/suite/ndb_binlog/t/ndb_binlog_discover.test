-- source include/have_ndb.inc
-- source include/have_binlog_format_mixed_or_row.inc

#
# Bug #14516 Restart of cluster can cause NDB API replication failure
#
create table t2 (a int key) engine=ndb;
#
# Unreported bug, online altered table causes system restart to fail
#
alter table t2 rename t1;
reset master;
--exec $NDB_MGM --no-defaults -e "all restart -n" > /dev/null
--exec $NDB_WAITER --no-defaults --not-started > /dev/null
--exec $NDB_MGM --no-defaults -e "all start" > /dev/null
--exec $NDB_WAITER --no-defaults > /dev/null

--disable_query_log
let $mysql_errno= 1;
while ($mysql_errno)
{
  # Table t1 is readonly until the mysqld has reconnected properly
  --error 0,1036,1296
  insert into t1 values(1);
  if ($mysql_errno)
  {
    --sleep 0.1
  }
}
--enable_query_log

# wait for stats thread to re-initialize
source include/ndb_index_stat_wait.inc;

# check that data went in ok
select * from t1;

--source include/show_binlog_events.inc
PURGE MASTER LOGS TO 'binlog.000002';

--source include/wait_for_ndb_committed_to_binlog.inc
--source include/show_binlog_events.inc
drop table t1;

# Ignore the warning generated by ndbcluster's binlog thread
# when cluster is restarted
--disable_query_log ONCE
call mtr.add_suppression("cluster disconnect An incident event has been written");

# Ignore the warning generated by ndbcluster's binlog thread
# when cluster is restarted - also on the second mysqld
connect(mysqld2,127.0.0.1,root,,test,$MASTER_MYPORT1);
connection mysqld2;
--disable_query_log ONCE
call mtr.add_suppression("cluster disconnect An incident event has been written");
