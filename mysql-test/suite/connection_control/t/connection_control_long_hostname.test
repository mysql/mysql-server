--source include/have_debug.inc
--source include/mysql_have_debug.inc

# Make sure that connection_control plugin can be loaded
--source ../inc/have_connection_control_plugin.inc

# Save the initial number of concurrent sessions
--source include/count_sessions.inc

--echo # Setup
--echo # Install connection_control plugin
--source ../inc/install_connection_control_plugin.inc

# We don't need to use client side authentication plugin for this test.
let $USE_AUTH_PLUGIN= 0;

--echo # Create user accounts for testing
CREATE USER u1@host_1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890 IDENTIFIED BY 'abcd';
CREATE USER u2@host_1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890 IDENTIFIED BY 'abcd';
CREATE USER u3@host_1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890 IDENTIFIED BY 'abcd';

SET GLOBAL DEBUG='+d,vio_peer_addr_fake_hostname1';
--replace_result $MASTER_MYSOCK SOURCE_SOCKET $MASTER_MYPORT SOURCE_PORT
--error 1
--exec $MYSQL --user=u1 --host=host_1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890 --password='haha' -#d,vio_client_use_localhost -v test  -e "SELECT CURRENT_USER();"

--replace_result $MASTER_MYSOCK SOURCE_SOCKET $MASTER_MYPORT SOURCE_PORT
--error 1
--exec $MYSQL --user=u1 --host=host_1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890 --password='ijkl' -#d,vio_client_use_localhost -v test  -e "SELECT CURRENT_USER();"

--replace_result $MASTER_MYSOCK SOURCE_SOCKET $MASTER_MYPORT SOURCE_PORT
--error 1
--exec $MYSQL --user=u1 --host=host_1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890 --password='mnop' -#d,vio_client_use_localhost -v test  -e "SELECT CURRENT_USER();"
SET GLOBAL DEBUG='-d,vio_peer_addr_fake_hostname1';

-- echo # Try various queries

--sorted_result
SELECT * FROM INFORMATION_SCHEMA.connection_control_failed_login_attempts
  WHERE USERHOST LIKE '\'u1\'@\'host_%';
  
-- echo # Cleanup.
DROP USER u1@host_1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890;
DROP USER u2@host_1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890;
DROP USER u3@host_1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890abcdefghij1234567890;

--echo # Uninstall connection_control plugin
--source ../inc/uninstall_connection_control_plugin.inc

# Wait till all disconnects are completed.
--source include/wait_until_count_sessions.inc
