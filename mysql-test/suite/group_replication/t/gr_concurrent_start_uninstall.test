################################################################################
<<<<<<< HEAD:mysql-test/suite/group_replication/t/gr_concurrent_start_uninstall.test
# This test resolves Deadlock. GR deadlocks when START GR and
# UNINSTALL happens at same time.
=======
# This test confirms that when START GR and UNINSTALL PLUGIN GR commands are
# executed concurrently, no deadlock happens.
>>>>>>> upstream/cluster-7.6:rapid/plugin/group_replication/tests/mtr/t/gr_concurrent_start_uninstall.test
#
# Test:
# 0. The test requires one server.
# 1. Setup GR environment and execute START GR.
# 2. Block start, so we can execute UNINSTALL.
<<<<<<< HEAD:mysql-test/suite/group_replication/t/gr_concurrent_start_uninstall.test
# 3. Execute UNINSTALL PLUGIN GR.
# 4. SIGNAL START GR to resume processing.
# 5. Confirm plugin is UNINSTALLED
=======
# 3. Execute UNINSTALL PLUGIN GR should fail with error
#    ER_PLUGIN_CANNOT_BE_UNINSTALLED as START GR is already running.
# 4. SIGNAL START GR to resume processing.
# 5. Confirm GR is started
>>>>>>> upstream/cluster-7.6:rapid/plugin/group_replication/tests/mtr/t/gr_concurrent_start_uninstall.test
# 6. Cleanup
#
################################################################################
--source include/have_debug.inc
<<<<<<< HEAD:mysql-test/suite/group_replication/t/gr_concurrent_start_uninstall.test
--source include/have_group_replication_plugin.inc
--let $rpl_skip_group_replication_start= 1
--source include/group_replication.inc
=======
--source include/have_debug_sync.inc
--source ../inc/have_group_replication_plugin.inc
--let $rpl_skip_group_replication_start= 1
--source ../inc/group_replication.inc
>>>>>>> upstream/cluster-7.6:rapid/plugin/group_replication/tests/mtr/t/gr_concurrent_start_uninstall.test

--echo
--echo # 1. Setup GR environment and execute START GR.
--echo

--let $rpl_connection_name= server1
--source include/rpl_connection.inc

SET GLOBAL group_replication_bootstrap_group=ON;
<<<<<<< HEAD:mysql-test/suite/group_replication/t/gr_concurrent_start_uninstall.test
SET GLOBAL group_replication_group_name = '8a94f357-bbbb-22aa-33bb-cccaaa420000';
=======
--replace_result $group_replication_group_name GROUP_REPLICATION_GROUP_NAME
--eval SET GLOBAL group_replication_group_name= "$group_replication_group_name"
>>>>>>> upstream/cluster-7.6:rapid/plugin/group_replication/tests/mtr/t/gr_concurrent_start_uninstall.test

--echo
--echo # 2. Block start, so we can execute UNINSTALL.
--echo

## If START GR gets lock and UNINSTALL blocks SQL Query execution,
## GR used to deadlock.

SET @debug_save= @@GLOBAL.DEBUG;
<<<<<<< HEAD:mysql-test/suite/group_replication/t/gr_concurrent_start_uninstall.test
SET @@GLOBAL.DEBUG= 'd,group_replication_wait_on_start';
=======
SET @@GLOBAL.DEBUG= '+d,group_replication_wait_on_start';
>>>>>>> upstream/cluster-7.6:rapid/plugin/group_replication/tests/mtr/t/gr_concurrent_start_uninstall.test

--send START GROUP_REPLICATION

--echo
<<<<<<< HEAD:mysql-test/suite/group_replication/t/gr_concurrent_start_uninstall.test
--echo # 3. Execute UNINSTALL PLUGIN GR from second connection.
--echo
=======
--echo # 3. Execute UNINSTALL PLUGIN GR should fail with error
--echo #    ER_PLUGIN_CANNOT_BE_UNINSTALLED as START GR is already running.
--echo

>>>>>>> upstream/cluster-7.6:rapid/plugin/group_replication/tests/mtr/t/gr_concurrent_start_uninstall.test
--let $rpl_connection_name= server_1
--source include/rpl_connection.inc
# Wait for the debug sync to be reached.
SET DEBUG_SYNC= "now WAIT_FOR signal.start_waiting";

<<<<<<< HEAD:mysql-test/suite/group_replication/t/gr_concurrent_start_uninstall.test
UNINSTALL PLUGIN group_replication;

--echo Wait for group replication plugin to be deleted.
--let $wait_condition= SELECT COUNT(*)=1 from information_schema.plugins where PLUGIN_NAME like 'group_replication' and PLUGIN_STATUS like 'DELETED';
--source include/wait_condition.inc
=======
--error ER_PLUGIN_CANNOT_BE_UNINSTALLED
UNINSTALL PLUGIN group_replication;

>>>>>>> upstream/cluster-7.6:rapid/plugin/group_replication/tests/mtr/t/gr_concurrent_start_uninstall.test

--echo
--echo # 4. SIGNAL START GR to resume processing.
--echo
SET DEBUG_SYNC= 'now SIGNAL signal.start_continue';

--let $rpl_connection_name= server1
--source include/rpl_connection.inc
--reap

--echo
<<<<<<< HEAD:mysql-test/suite/group_replication/t/gr_concurrent_start_uninstall.test
--echo # 5. Confirm plugin is UNINSTALLED.
--echo

--echo Wait for group replication plugin to be removed.
--let $wait_condition= SELECT COUNT(*)=0 from information_schema.plugins where PLUGIN_NAME like 'group_replication';
--source include/wait_condition.inc
=======
--echo # 5. Confirm GR is started
--echo

--let $group_replication_member_state= ONLINE
--source ../inc/gr_wait_for_member_state.inc

>>>>>>> upstream/cluster-7.6:rapid/plugin/group_replication/tests/mtr/t/gr_concurrent_start_uninstall.test

--echo
--echo # 6. Cleanup
--echo

<<<<<<< HEAD:mysql-test/suite/group_replication/t/gr_concurrent_start_uninstall.test
#Some test executions may uninstall the plugin before the member is ONLINE and writable
SET GLOBAL read_only = 0;

--source include/install_group_replication_plugin.inc

SET @@GLOBAL.DEBUG= @debug_save;
--source include/group_replication_end.inc
=======
SET @@GLOBAL.DEBUG= @debug_save;
--source ../inc/group_replication_end.inc
>>>>>>> upstream/cluster-7.6:rapid/plugin/group_replication/tests/mtr/t/gr_concurrent_start_uninstall.test
