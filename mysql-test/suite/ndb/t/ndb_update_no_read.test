-- source include/have_ndb.inc

# bug#36341
-- source include/not_embedded.inc

--disable_warnings
DROP TABLE IF EXISTS t1;
--enable_warnings

#
# New test case for WL 3686 (which is not until CGE-6.3)
# but test is committed in 5.1 to verify consistant results.
#
# When only constant expressions in update statements and
# only PK or UK in WHERE clause. No extra WHERE parts are
# allowed. WL #3687 takes of more advanced variants of
# avoiding the read before the update/delete

create table t1 (a int not null primary key, b int not null, c int,
                 unique index_b (b) using hash)
engine ndb;
# to see rows found and changed
--enable_info

insert into t1 values (1,10,1),(2,9,1),(3,8,1),(4,7,1),(5,6,1),(6,5,2),(7,4,2),(8,3,2),
            (9,2,2),(10,1,2);

# These ones should use optimisation

--echo
--echo # expected result 2 roundtrips
--echo # 0 - info call
--echo # 1 - read the row
--echo # 0 - update the row (deferred to commit)
--echo # 1 - update + commit the transaction
--echo
--source include/ndb_init_execute_count.inc
update t1 set c = 111, b = 20 where a = 1;
--source include/ndb_execute_count.inc

select * from t1 where a = 1 order by a;

--echo
--echo # expected result 1 roundtrips
--echo # 0 - info call
--echo # 0 - read the rows (1 with read before)
--echo # 0 - delete the row (deferred to commit)
--echo # 1 - delete + commit the transaction
--echo
--source include/ndb_init_execute_count.inc
delete from t1 where a = 1;
--source include/ndb_execute_count.inc

select * from t1 where a = 1 order by a;

--echo
--echo # expected result 2 roundtrips
--echo # 0 - info call
--echo # 1 - read the rows
--echo # 0 - update the row (deferred to commit)
--echo # 1 - update + commit the transaction
--echo
--source include/ndb_init_execute_count.inc
update t1 set c = 12, b = 19 where b = 2;
--source include/ndb_execute_count.inc

select * from t1 where b = 2 order by a;

--echo
--echo # expected result 1 roundtrips
--echo # 0 - info call
--echo # 0 - read the rows (1 with read before)
--echo # 0 - delete the row (deferred to commit)
--echo # 1 - delete and commit the transaction
--echo
--source include/ndb_init_execute_count.inc
delete from t1 where b = 19;
--source include/ndb_execute_count.inc

select * from t1 where b = 19 order by a;

--echo
--echo # expected result 3 roundtrips
--echo # 0 - info call
--echo # 2 - read the rows
--echo # 0 - update the rows (deferred to commit)
--echo # 1 - update + commit the transaction
--echo
--source include/ndb_init_execute_count.inc
update t1 set c = 22 where a = 10 or a >= 10;
--source include/ndb_execute_count.inc

select * from t1 order by a;

--echo
--echo # expected result 1 roundtrips
--echo # 0 - info call
--echo # 0 - read the rows (1 with read before)
--echo # 0 - update the rows (2 if no bulk update + 1 deferred to commit)
--echo # 1 - update + commit the transaction
--echo
--source include/ndb_init_execute_count.inc
update t1 set c = 23 where a in (8,10);
--source include/ndb_execute_count.inc

select * from t1 order by a;

--echo
--echo # expected result 4 roundtrips
--echo # 0 - info call
--echo # 3 - read the rows
--echo # 0 - update the rows (executed during read)
--echo # 1 - commit the transaction
--echo
--source include/ndb_init_execute_count.inc
update t1 set c = 23 where a in (7,8) or a >= 10;
--source include/ndb_execute_count.inc

select * from t1 order by a;

# These ones should not use optimisation

--echo
--echo # expected result 5 roundtrips
--echo # 0 - info call
--echo # 2 - read the rows
--echo # 2 - pk read in rnd_pos
--echo # 0 - update the rows (deferred to commit)
--echo # 1 - update + commit the transaction
--echo
--source include/ndb_init_execute_count.inc
update t1 set c = 11 where a = 3 or b = 7;
### Disable this test, as it's unpredictable...
### cause scan can get one or two batches...
#--source include/ndb_execute_count.inc

select * from t1 where a = 3 or b = 7 order by a;

--echo
--echo # expected result 5 roundtrips
--echo # 0 - info call
--echo # 1 - read the rows
--echo # 1 - read the row _again_ in complemented read
--echo # 1 - delete the row (pk update)
--echo # 1 - insert the row (pk update)
--echo # 1 - commit the transaction
--echo
--source include/ndb_init_execute_count.inc
update t1 set a = 13, b = 20 where a = 3;
--source include/ndb_execute_count.inc

select * from t1 where a = 13 order by a;

--echo
--echo # expected result 5 roundtrips
--echo # 0 - info call
--echo # 1 - read the rows
--echo # 1 - read the row _again_ in complemented read
--echo # 1 - delete the row (pk update)
--echo # 1 - insert the row (pk update)
--echo # 1 - commit the transaction
--echo
--source include/ndb_init_execute_count.inc
update t1 set a = 12, b = 19 where b = 7;
--source include/ndb_execute_count.inc

select * from t1 where b = 19 order by a;

select * from t1 where b = 7 order by a;

--echo
--echo # expected result 3 roundtrips
--echo # 1 - info call
--echo # 1 - read the rows
--echo # 0 - update the rows (deferred to commit)
--echo # 1 - update + commit the transaction
--echo
--source include/ndb_init_execute_count.inc
update t1 set c = 12, b = 29 where a = 5 and b = 6;
--source include/ndb_execute_count.inc

select * from t1 where b = 19 order by a;

--echo
--echo # expected result 2 roundtrips
--echo # 0 - info call
--echo # 1 - read the rows
--echo # 0 - delete the rows (no row found)
--echo # 1 - commit the transaction
--echo
--source include/ndb_init_execute_count.inc
delete from t1 where b = 6 and c = 12;
--source include/ndb_execute_count.inc

select * from t1 where b = 6 order by a;

drop table t1;

#Bug 37153 Ndb cluster reports affected rows incorrectly
create table t1 (a int primary key,
                 b varchar(4))
engine=ndb;
# Show warning and count info
--enable_info 

insert into t1 values (1, '1'), (2, '2'), (3, '3');

# Autocommit, successful update
--echo
--echo # expected result 1 roundtrip
--echo # 0 - info call
--echo # 0 - read the row
--echo # 0 - update the row
--echo # 1 - update+commit the row
--echo # Rows matched=changed=affected=1
--echo 
--source include/ndb_init_execute_count.inc
update t1 set b='two' where a=2;
--source include/ndb_execute_count.inc


# Autocommit, unsuccessful update
--echo
--echo # expected result 1 roundtrip
--echo # 0 - info call
--echo # 0 - read the row
--echo # 0 - update the row
--echo # 1 - update+commit the row
--echo # Rows matched=changed=affected=0
--echo 
--source include/ndb_init_execute_count.inc
update t1 set b='lots' where a=2000;
--source include/ndb_execute_count.inc

# Autocommit, successful update + warning
--echo
--echo # expected result 1 roundtrip
--echo # 0 - info call
--echo # 0 - read the row
--echo # 0 - update the row
--echo # 1 - update+commit the row
--echo # Rows matched=changed=affected=1
--echo # 1 warning
--echo 
--source include/ndb_init_execute_count.inc
update t1 set b='one plus one' where a=2;
--source include/ndb_execute_count.inc


# Autocommit, unsuccessful update + warning
--echo
--echo # expected result 1 roundtrip
--echo # 0 - info call
--echo # 0 - read the row
--echo # 0 - update the row
--echo # 1 - update+commit the row
--echo # Rows matched=changed=affected=0
--echo # 1 warning
--echo 
--disable_warnings # Workaround to bug#39663
--source include/ndb_init_execute_count.inc
update t1 set b='two thousand' where a=2000;
show warnings; # Workaround to bug#39663
--source include/ndb_execute_count.inc
--enable_warnings # Workaround to bug#39663


# No autocommit, successful update
--echo
--echo # expected result 2 roundtrips
--echo # 0 - info call
--echo # 0 - read the row
--echo # 1 - update the row
--echo # 1 - commit
--echo # Rows matched=changed=affected=1
--echo 
--source include/ndb_init_execute_count.inc
begin;
update t1 set b='two' where a=2;
commit;
--source include/ndb_execute_count.inc


# No autocommit, unsuccessful update
--echo
--echo # expected result 2 roundtrips
--echo # 0 - info call
--echo # 0 - read the row
--echo # 1 - update the row
--echo # 1 - commit
--echo # Rows matched=changed=affected=0
--echo 
--source include/ndb_init_execute_count.inc
begin;
update t1 set b='lots' where a=2000;
commit;
--source include/ndb_execute_count.inc


# No autocommit, successful update + warning
--echo
--echo # expected result 2 roundtrips
--echo # 0 - info call
--echo # 0 - read the row
--echo # 1 - update the row
--echo # 1 - commit
--echo # Rows matched=changed=affected=1
--echo 1 warning
--echo 
--source include/ndb_init_execute_count.inc
begin;
update t1 set b='one plus one' where a=2;
commit;
--source include/ndb_execute_count.inc


# No autocommit, unsuccessful update + warning
--echo
--echo # expected result 2 roundtrips
--echo # 0 - info call
--echo # 0 - read the row
--echo # 1 - update the row
--echo # 1 - commit
--echo # Rows matched=changed=affected=0
--echo # 1 warning
--echo 
--disable_warnings # Workaround to bug#39663
--source include/ndb_init_execute_count.inc
begin;
update t1 set b='two thousand' where a=2000;
commit;
show warnings; # Workaround to bug#39663
--source include/ndb_execute_count.inc
--enable_warnings # Workaround to bug#39663

drop table t1;
