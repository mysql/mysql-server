--source include/have_ndb.inc

--disable_query_log
set @old_ecpd = @@session.optimizer_switch;
set @@optimizer_switch = 'engine_condition_pushdown=off';
--enable_query_log

#
# Bug#30183466 	MEMORY CORRUPTION ON QUERY
# Adapted test case from bug, added BLOB to get more complex scan
#

CREATE TABLE t1 (
  a varchar(23) DEFAULT NULL,
  b date DEFAULT NULL,
  c varchar(45) DEFAULT NULL,
  d varchar(1) DEFAULT NULL,
  e varchar(4) DEFAULT NULL,
  f varchar(2) DEFAULT NULL,
  g varchar(6) DEFAULT NULL,
  h varchar(1) DEFAULT NULL,
  i varchar(5) DEFAULT NULL,
  j varchar(5) DEFAULT NULL,
  k varchar(5) DEFAULT NULL,
  l datetime DEFAULT NULL,
  m decimal(14,2) DEFAULT NULL,
  n varchar(3) DEFAULT NULL,
  o varchar(2) DEFAULT NULL,
  p varchar(2) DEFAULT NULL,
  q varchar(45) DEFAULT NULL,
  r double DEFAULT NULL,
  s varchar(3) DEFAULT NULL,
  t varchar(2) DEFAULT NULL,
  u varchar(1) DEFAULT NULL,
  v varchar(1) DEFAULT NULL,
  w varchar(1) DEFAULT NULL,
  x varchar(45) DEFAULT NULL,
  y varchar(1) DEFAULT 'n',
  z varchar(1) DEFAULT 'n',
  aa text DEFAULT NULL
) ENGINE=ndbcluster DEFAULT CHARSET=latin1;

INSERT INTO t1 VALUES ('1576682624',NULL,'1605487520','1','1552','16','158982','1','15387','15886','16188','2018-09-26 18:51:39',999999999999.99,'162','15','16','1634444551',999999999999.99,'163','15','1','1','1','1634408207','1','1','1609381753');
INSERT INTO t1 VALUES ('1588012034',NULL,'1631681072','1','1592','15','161613','1','15712','15925','15876','2020-06-04 09:59:53',999999999999.99,'159','16','16','1613000167',999999999999.99,'157','15','1','1','1','1578495351','1','1','1632299098');
INSERT INTO t1 VALUES ('1545050436',NULL,'1555775455','1','1636','15','157774','1','15629','15637','15761','2019-05-17 06:40:54',999999999999.99,'155','16','16','1624240510',999999999999.99,'159','16','1','1','1','1634504635','1','1','1620621098');
INSERT INTO t1 VALUES ('1623391295',NULL,'1605809461','1','1551','15','160075','1','15712','16122','16077','2019-07-12 16:56:23',999999999999.99,'158','16','15','1549448828',999999999999.99,'162','16','1','1','1','1547226527','1','1','1570671920');
INSERT INTO t1 VALUES ('1572358159',NULL,'1624820345','1','1591','15','160227','1','15629','16287','16211','2021-01-14 05:37:15',999999999999.99,'160','15','16','1566580028',999999999999.99,'154','15','1','1','1','1561251913','1','1','1607139174');
INSERT INTO t1 VALUES ('1626748560',NULL,'1591348995','1','1545','16','157676','1','15512','16023','16240','2019-02-12 17:00:49',999999999999.99,'159','16','15','1546032718',999999999999.99,'157','16','1','1','1','1595606221','1','1','1580319284');
INSERT INTO t1 VALUES ('1541916013',NULL,'1551562744','1','1583','15','158162','1','15771','16250','16359','2019-10-01 02:29:25',999999999999.99,'162','15','15','1633290825',999999999999.99,'157','15','1','1','1','1544366994','1','1','1602585185');
INSERT INTO t1 VALUES ('1608664255',NULL,'1629728295','1','1579','16','159590','1','16033','16060','15553','2019-05-04 05:24:28',999999999999.99,'155','16','15','1630993560',999999999999.99,'153','15','1','1','1','1597099327','1','1','1562961424');
INSERT INTO t1 VALUES ('1627753795',NULL,'1568465944','1','1626','15','161294','1','16271','16056','16214','2019-09-11 08:32:47',999999999999.99,'162','16','15','1545705098',999999999999.99,'155','15','1','1','1','1616701391','1','1','1616121442');
INSERT INTO t1 VALUES ('1591858288',NULL,'1600675688','1','1553','15','157144','1','15583','16068','15374','2020-08-11 21:28:03',999999999999.99,'157','16','16','1543201335',999999999999.99,'159','15','1','1','1','1589080452','1','1','1551860650');
INSERT INTO t1 VALUES ('1552164153',NULL,'1587168936','1','1560','16','157789','1','15527','15888','15921','2020-02-10 19:13:04',999999999999.99,'159','15','15','1636976369',999999999999.99,'158','15','1','1','1','1605677653','1','1','1604766328');
INSERT INTO t1 VALUES ('1591853616',NULL,'1556868887','1','1567','15','155055','1','15524','15529','15689','2020-07-25 14:21:13',999999999999.99,'163','16','16','1546080344',999999999999.99,'154','15','1','1','1','1560717904','1','1','1545381424');
INSERT INTO t1 VALUES ('1572490568',NULL,'1579492363','1','1616','15','158941','1','15675','15931','15835','2020-04-01 05:17:20',999999999999.99,'156','15','16','1571718239',999999999999.99,'161','15','1','1','1','1611355319','1','1','1619853886');
INSERT INTO t1 VALUES ('1549477484',NULL,'1576023563','1','1583','15','155636','1','15881','15783','15475','2020-10-25 13:06:17',999999999999.99,'157','15','16','1615556384',999999999999.99,'162','16','1','1','1','1573332458','1','1','1604352720');
INSERT INTO t1 VALUES ('1595085244',NULL,'1609431821','1','1573','16','160661','1','15969','16322','16101','2021-06-11 01:52:17',999999999999.99,'161','15','15','1552042114',999999999999.99,'163','15','1','1','1','1617207540','1','1','1619360186');
INSERT INTO t1 VALUES ('1604261310',NULL,'1583169318','1','1575','15','163669','1','16106','15571','15855','2020-01-21 23:21:25',999999999999.99,'163','16','15','1588320762',999999999999.99,'160','16','1','1','1','1597178009','1','1','1571268082');
INSERT INTO t1 VALUES ('1597960364',NULL,'1583334202','1','1550','15','162010','1','15692','16233','16332','2021-06-07 14:43:45',999999999999.99,'161','15','15','1550352495',999999999999.99,'159','15','1','1','1','1604285562','1','1','1555230368');
INSERT INTO t1 VALUES ('1558773294',NULL,'1614709883','1','1618','16','160929','1','15601','16099','16240','2019-07-15 05:00:30',999999999999.99,'154','16','15','1537264477',999999999999.99,'157','15','1','1','1','1626591137','1','1','1633834789');
INSERT INTO t1 VALUES ('1572661330',NULL,'1586569823','1','1615','15','161263','1','15960','15599','15511','2019-04-30 11:10:24',999999999999.99,'158','15','15','1611959856',999999999999.99,'159','15','1','1','1','1539710903','1','1','1620553626');
INSERT INTO t1 VALUES ('1546435566',NULL,'1573679027','1','1543','15','158902','1','16319','16127','16197','2018-10-18 04:25:08',999999999999.99,'156','16','16','1603877285',999999999999.99,'161','16','1','1','1','1598859595','1','1','1603584514');
INSERT INTO t1 VALUES ('1540713372',NULL,'1588309694','1','1546','15','155283','1','15918','15556','15869','2021-08-29 06:16:01',999999999999.99,'159','15','15','1561483774',999999999999.99,'162','15','1','1','1','1596180641','1','1','1596408561');
INSERT INTO t1 VALUES ('1573877545',NULL,'1587934623','1','1541','15','162172','1','15387','16021','15432','2019-01-03 12:15:24',999999999999.99,'155','15','15','1571522789',999999999999.99,'153','15','1','1','1','1620494484','1','1','1634413006');
INSERT INTO t1 VALUES ('1597153106',NULL,'1630690660','1','1611','16','159254','1','16167','16170','15858','2020-07-16 09:26:36',999999999999.99,'155','16','16','1613613803',999999999999.99,'157','15','1','1','1','1577390762','1','1','1555115269');
INSERT INTO t1 VALUES ('1628340742',NULL,'1614893277','1','1595','16','156242','1','15842','16147','15708','2020-05-11 04:28:23',999999999999.99,'160','15','16','1621142854',999999999999.99,'161','15','1','1','1','1615281274','1','1','1607840229');
INSERT INTO t1 VALUES ('1556140176',NULL,'1630081457','1','1611','15','158566','1','15951','16172','15928','2019-04-01 14:06:58',999999999999.99,'158','15','15','1619392668',999999999999.99,'161','15','1','1','1','1606374836','1','1','1613351423');
INSERT INTO t1 VALUES ('1590237501',NULL,'1546813874','1','1543','15','157180','1','15404','16291','15528','2020-02-13 19:10:17',999999999999.99,'160','15','15','1621077446',999999999999.99,'160','15','1','1','1','1602884630','1','1','1617235512');
INSERT INTO t1 VALUES ('1607766930',NULL,'1590988272','1','1542','15','154103','1','16245','16238','16198','2019-08-01 07:46:05',999999999999.99,'163','15','15','1599527504',999999999999.99,'161','16','1','1','1','1606293708','1','1','1601264461');
INSERT INTO t1 VALUES ('1598165454',NULL,'1627779458','1','1580','15','155911','1','16289','16006','16028','2020-11-16 14:14:21',999999999999.99,'156','15','16','1627994462',999999999999.99,'153','16','1','1','1','1597165928','1','1','1557398062');
INSERT INTO t1 VALUES ('1635496169',NULL,'1592716572','1','1569','15','153752','1','16073','16248','15589','2020-08-15 03:35:46',999999999999.99,'157','16','16','1546570219',999999999999.99,'156','15','1','1','1','1565016108','1','1','1549190519');
INSERT INTO t1 VALUES ('1567919142',NULL,'1599996110','1','1576','15','155621','1','15528','15382','16052','2021-05-30 14:23:28',999999999999.99,'160','15','15','1546922458',999999999999.99,'163','15','1','1','1','1543188940','1','1','1556527832');
INSERT INTO t1 VALUES ('1633302311',NULL,'1622840287','1','1545','15','155307','1','15889','15620','16360','2021-04-25 06:00:28',999999999999.99,'159','15','16','1611035057',999999999999.99,'155','16','1','1','1','1612914215','1','1','1584028179');
INSERT INTO t1 VALUES ('1623732159',NULL,'1581493955','1','1621','16','161581','1','16248','16030','16064','2019-07-04 07:01:37',999999999999.99,'163','15','15','1596719195',999999999999.99,'155','15','1','1','1','1617233025','1','1','1580509356');

# Add row to fulfill nonsensical query from bug test case
INSERT INTO t1 VALUES ('1623732159','2019-08-12 00:00:00','1581493955','1','1621','16','161581','1',NULL,'16030','16064','2019-07-04 07:01:37',999999999999.99,'163','15','cr','1596719195',999999999999.99,'155','15','1','1','1','1617233025','1','1','158050935600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000');

# Fill table enough to use whole scan batch
INSERT INTO t1 SELECT * FROM t1;
INSERT INTO t1 SELECT * FROM t1;
INSERT INTO t1 SELECT * FROM t1;
INSERT INTO t1 SELECT * FROM t1;
INSERT INTO t1 SELECT * FROM t1;
INSERT INTO t1 SELECT * FROM t1;

select i,r,s,b,p from t1 order by a,p;

select  trxitems0_.i  as  col_0_0_,  sum(trxitems0_.r)  as  col_1_0_,  trxitems0_.s  as  col_2_0_  
 from  t1  trxitems0_  
 where  (trxitems0_.b  between  '2019-08-12  00:00:00'  and  '2019-08-12  00:00:00'  
 or  '2019-08-12  00:00:00'  is  null  
 or  '2019-08-12  00:00:00'  is  null
 )  and  trim(upper(trxitems0_.p))='cr'  
 and  (trim(upper(trxitems0_.i))=null  or  null  is  null)  
 group  by  trxitems0_.i  ,  trxitems0_.s  
 limit  1000;

drop table t1;

--disable_query_log
set @@session.optimizer_switch = @old_ecpd;
--enable_query_log
