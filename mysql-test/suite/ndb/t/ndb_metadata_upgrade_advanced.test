--source include/have_multi_ndb.inc
-- source suite/ndb/include/backup_restore_setup.inc

# Directory containing the saved backup files
let $backup_data_dir=$MYSQL_TEST_DIR/suite/ndb/backups;

#
# The table structures are as follows:
# CREATE TABLE t1 (
#   c1 INT PRIMARY KEY AUTO_INCREMENT,
#   c2 INT UNSIGNED NOT NULL,
#   c3 FLOAT,
#   c4 VARCHAR(255),
#   c5 TIME,
#   c6 DATE,
#   c7 DATETIME,
#   c8 BLOB,
#   c9 CHAR(30),
#   c10 VARBINARY(255),
#   UNIQUE KEY xc2(c2)
# ) ENGINE NDB;
#
# INSERT INTO t1 VALUES(1,1,2.5,'a','23:59:59','2018-01-30','2018-01-30 13:46:00','b','c','d');
#
# CREATE TABLE t2 (
#   c1 int PRIMARY KEY,
#   c2 int GENERATED ALWAYS AS (c1*c1)
# ) ENGINE NDB;
#
# INSERT INTO t2(c1) VALUES(2);
#
# CREATE TABLE t3 (
#   c1 int NOT NULL AUTO_INCREMENT PRIMARY KEY,
#   c2 varchar(100),
#   c3 varchar(100)
# ) ENGINE NDB
#   COMMENT="NDB_TABLE=READ_BACKUP=0,PARTITION_BALANCE=FOR_RP_BY_NODE";
#
# INSERT INTO t3 VALUES(1,'a','a');
#

--exec $NDB_RESTORE -b 1 -n 1 -m -r --disable-indexes $backup_data_dir/metadata_upgrade_advanced_backup >> $NDB_TOOLS_OUTPUT
--exec $NDB_RESTORE -b 1 -n 2 -r $backup_data_dir/metadata_upgrade_advanced_backup >> $NDB_TOOLS_OUTPUT
--exec $NDB_RESTORE -b 1 -n 1 --rebuild-indexes $backup_data_dir/metadata_upgrade_advanced_backup >> $NDB_TOOLS_OUTPUT

--echo Backup from 7.5 restored

# Ignore the warning generated by ndbcluster's binlog thread
# when mysqld is restarted
--disable_query_log ONCE
call mtr.add_suppression("mysqld startup An incident event has been written");

--echo Restart server 1 to trigger schema distribution synchronization
let $mysqld_name=mysqld.1.1;
--source include/restart_mysqld.inc

connection server2;
--echo Restart server 2 to trigger schema distribution synchronization
let $mysqld_name=mysqld.2.1;
--source include/restart_mysqld.inc

connection server1;

# Check schema and then perform DML and DDL on the tables
SHOW CREATE TABLE t1;
--sorted_result
SELECT * FROM t1;

ALTER TABLE t1 DROP COLUMN c9;
INSERT INTO t1 VALUES (2,2,2.5,'a','23:59:59','2018-01-30','2018-01-30 13:46:00','b','d');
--sorted_result
SELECT * FROM t1;

DROP TABLE t1;

SHOW CREATE TABLE t2;
--sorted_result
SELECT * FROM t2;

ALTER TABLE t2 RENAME t4;
INSERT INTO t4(c1) VALUES (3);
--sorted_result
SELECT * FROM t4;

DROP TABLE t4;

SHOW CREATE TABLE t3;
--sorted_result
SELECT * FROM t3;

ALTER TABLE t3 ALGORITHM=COPY, ADD COLUMN c4 int;
INSERT INTO t3 VALUES (2,'b','b',2);
--sorted_result
SELECT * FROM t3;

DROP TABLE t3;
let NDB_RESTORE=;
