-- source include/have_ndb.inc
-- source have_ndb_error_insert.inc

# Ignore the warning generated by ndbcluster's binlog thread
# when cluster is restarted
--disable_query_log ONCE
call mtr.add_suppression("cluster disconnect An incident event has been written");

# Ignore the warning generated by ndbcluster's binlog thread
# when cluster is restarted - also on the second mysqld
connect(mysqld2,127.0.0.1,root,,test,$MASTER_MYPORT1);
connection mysqld2;
--disable_query_log ONCE
call mtr.add_suppression("cluster disconnect An incident event has been written");

connection default;

--exec $NDB_CONFIG -q NodeId,StopOnError

CREATE DATABASE mysqltest;
USE mysqltest;
CREATE TABLE t1 (
  pk INT NOT NULL PRIMARY KEY,
  attr1 INT NOT NULL,
  attr2 INT,
  attr3 VARCHAR(10)
) ENGINE=ndbcluster;

INSERT INTO t1 VALUES
(0,0,NULL,'0'),
(1,1,1,'1'),
(2,2,2,'2'),
(3,3,3,'3'),
(4,4,4,'4'),
(5,5,5,'5'),
(6,6,6,'6'),
(7,7,7,'7'),
(8,8,8,'8'),
(9,9,9,'9'),
(10,10,NULL,'10'),
(11,11,11,'11'),
(12,12,12,'12'),
(13,13,13,'13'),
(14,14,14,'14'),
(15,15,15,'15'),
(16,16,16,'16'),
(17,17,17,'17'),
(18,18,18,'18'),
(19,19,19,'19'),
(20,20,NULL,'20'),
(21,21,21,'21'),
(22,22,22,'22'),
(23,23,23,'23'),
(24,24,24,'24'),
(25,25,25,'25'),
(26,26,26,'26'),
(27,27,27,'27'),
(28,28,28,'28'),
(29,29,29,'29'),
(30,30,NULL,'30'),
(31,31,31,'31'),
(32,32,32,'32'),
(33,33,33,'33'),
(34,34,34,'34'),
(35,35,35,'35'),
(36,36,36,'36'),
(37,37,37,'37'),
(38,38,38,'38'),
(39,39,39,'39'),
(40,40,NULL,'40'),
(41,41,41,'41'),
(42,42,42,'42'),
(43,43,43,'43'),
(44,44,44,'44'),
(45,45,45,'45'),
(46,46,46,'46'),
(47,47,47,'47'),
(48,48,48,'48'),
(49,49,49,'49'),
(50,50,NULL,'50'),
(51,51,51,'51'),
(52,52,52,'52'),
(53,53,53,'53'),
(54,54,54,'54'),
(55,55,55,'55'),
(56,56,56,'56'),
(57,57,57,'57'),
(58,58,58,'58'),
(59,59,59,'59'),
(60,60,NULL,'60'),
(61,61,61,'61'),
(62,62,62,'62'),
(63,63,63,'63'),
(64,64,64,'64'),
(65,65,65,'65'),
(66,66,66,'66'),
(67,67,67,'67'),
(68,68,68,'68'),
(69,69,69,'69'),
(70,70,NULL,'70'),
(71,71,71,'71'),
(72,72,72,'72'),
(73,73,73,'73'),
(74,74,74,'74'),
(75,75,75,'75'),
(76,76,76,'76'),
(77,77,77,'77'),
(78,78,78,'78'),
(79,79,79,'79'),
(80,80,NULL,'80'),
(81,81,81,'81'),
(82,82,82,'82'),
(83,83,83,'83'),
(84,84,84,'84'),
(85,85,85,'85'),
(86,86,86,'86'),
(87,87,87,'87'),
(88,88,88,'88'),
(89,89,89,'89'),
(90,90,NULL,'90'),
(91,91,91,'91'),
(92,92,92,'92'),
(93,93,93,'93'),
(94,94,94,'94'),
(95,95,95,'95'),
(96,96,96,'96'),
(97,97,97,'97'),
(98,98,98,'98'),
(99,99,99,'99');

--echo "Run DUMP commands to start LCP"
--exec $NDB_MGM --no-defaults --ndb-connectstring="$NDB_CONNECTSTRING" -e "all dump 7099" >> $NDB_TOOLS_OUTPUT

--echo "Sleep 10s so that LCP can complete"
sleep 10;

--echo "Insert ERROR command to crash nodes with SEGV"
--exec $NDB_MGM --no-defaults --ndb-connectstring="$NDB_CONNECTSTRING" -e "all error 9006" >> $NDB_TOOLS_OUTPUT

--echo "Wait till nodes started"
--exec $NDB_WAITER --no-defaults --ndb-connectstring="$NDB_CONNECTSTRING" >> $NDB_TOOLS_OUTPUT

--exec $NDB_SELECT_ALL -d mysqltest t1 -o PRIMARY

# Wait for MySQLD to reconnect to cluster...
--source include/ndb_not_readonly.inc

DROP TABLE t1;
DROP DATABASE mysqltest;
--remove_file $NDB_TOOLS_OUTPUT
