# *****************************************************************
# wl#9508 : This MTR testcase is used to check following crash
#  Assertion failure: fsp0fsp.cc:785:space_id == page_get_space_id
# == page_get_space_id(buf_block_get_frame(block))
# *****************************************************************
--source include/have_innodb_16k.inc

let $MYSQLD_BASEDIR= `select @@basedir`;
let $MYSQLD_OLD_DATADIR = `select @@datadir`;

use test;
CREATE table tab1(c1 int);

--mkdir $MYSQL_TMP_DIR/log_encrypt_dir1

let $MYSQLD_DATADIR1 = $MYSQL_TMP_DIR/log_encrypt_dir1;

let BOOTSTRAP_SQL=$MYSQL_TMP_DIR/boot.sql;

--echo # create bootstrap file
write_file $BOOTSTRAP_SQL;
CREATE DATABASE test;
EOF

--echo # Stop the MTR default DB server
--source include/shutdown_mysqld.inc

let NEW_CMD = $MYSQLD --no-defaults --initialize-insecure --basedir=$MYSQLD_BASEDIR --datadir=$MYSQLD_DATADIR1 --init-file=$BOOTSTRAP_SQL --secure-file-priv="" </dev/null>>$MYSQLTEST_VARDIR/tmp/bootstrap1.log 2>&1;

--echo # Run the bootstrap command of datadir1
--exec $NEW_CMD

--let $restart_parameters="restart: --log_error_verbosity=3 --datadir=$MYSQLD_DATADIR1 --early-plugin-load="keyring_file=$KEYRING_PLUGIN" $KEYRING_PLUGIN_OPT --keyring_file_data=$MYSQL_TMP_DIR/my_keyfile --innodb_undo_log_encrypt=1 --innodb_redo_log_encrypt=1"
--source include/start_mysqld_no_echo.inc

--replace_result $MYSQLD_DATADIR1 MYSQLD_DATADIR1
SELECT @@datadir;

--replace_result $MYSQL_TMP_DIR key_file
SHOW VARIABLES LIKE 'keyring_file%';

SELECT @@innodb_undo_log_encrypt;

CREATE UNDO TABLESPACE undo_003 ADD DATAFILE 'undo_003.ibu';
CREATE DATABASE nath;
use nath;
CREATE TABLE tab2(c1 int , c2 varchar(10)) Engine=InnoDB ENCRYPTION='Y';
INSERT INTO tab2 VALUES(2, 'VISH');
CREATE INDEX ix2 ON tab2(c2) ;

--echo Server crashes here 
CREATE UNDO TABLESPACE undo_004 ADD DATAFILE 'undo_004.ibu';

# Check ALTER and DROP with encrypt undo tablespaces
ALTER UNDO TABLESPACE undo_003 SET INACTIVE;
ALTER UNDO TABLESPACE undo_004 SET INACTIVE;

# Wait until implicit undo tablespace become empty
let $wait_condition= SELECT count(*) = 2 FROM INFORMATION_SCHEMA.INNODB_TABLESPACES
                     WHERE NAME LIKE '%undo%' AND STATE = 'empty';
source include/wait_condition.inc;

DELETE FROM tab2;
DROP UNDO TABLESPACE undo_003;
DROP UNDO TABLESPACE undo_004;
DROP TABLE tab2;
DROP DATABASE nath;

--echo # Stop the encrypt server 
--source include/shutdown_mysqld.inc

# Restart with MTR default server
--replace_result $MYSQLD_OLD_DATADIR OLD_DATADIR
--let $restart_parameters="restart: --datadir=$MYSQLD_OLD_DATADIR"
--source include/start_mysqld.inc

--replace_result $MYSQLD_OLD_DATADIR MYSQLD_OLD_DATADIR
SELECT @@datadir;

use test;

# clean up
DROP TABLE tab1;
