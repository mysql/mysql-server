# There are three levels on which the feature is verified:
#
# * on X Protocol layer (without decompression)
# * confirming that resultset flow is correct
# * confirming that resultset contains correct data
#
# This test confirms that compression works on server side, it does verification
# of result-set data (bullet no 3). The validation is done in result file.
#
#
# Following is verified:
#
# server->client: Mysqlx.Connection.Compression
#
# In which X Plugin compresses by default following messages:
#
# * NOTICE - 11, 0x0b
# * RESULTSET_COLUMN_META_DATA - 12, 0x0c
# * RESULTSET_ROW  - 13, 0x0d
# * RESULTSET_FETCH_DONE - 14, 0x0e
#
# followed with uncompressed:
#
# * SQL_STMT_EXECUTE_OK = 17   0x11
#
# The server is going to use following messages to transfer
# compressed payload:
#
# * COMPRESSION = 19;   0x13
#
#

##
## Please take a note that this test (and others) use following terms:
## SINGLE, MULTIPLE, GROUP
##
## Those correspond to concrete setting of compression capabilities:
## server_combine_mixed_messages, server_max_combine_messages and
## describe only compressed messages generated by the server.
##
## * SINGLE - it corresponds to
##            server_combine_mixed_messages=TRUE|FALSE,
##            server_max_combine_messages=1
##            In this configuration exact one X Protocol message is
##            encapsulated in one Mysqlx.Connection.Compression
##
## * MULTIPLE - it corresponds to
##              server_combine_mixed_messages=FALSE,
##              server_max_combine_messages=UNSET|0
##              In this configuration multiple X Protocol messages
##              of the same type are encapsulated in one
##              Mysqlx.Connection.Compression
##
## * GROUP - it corresponds to
##           server_combine_mixed_messages=TRUE,
##           server_max_combine_messages=UNSET|0
##           In this configuration multiple X Protocol messages
##           of different types are encapsulated in one
##           Mysqlx.Connection.Compression
##
## Cases where "server_max_combine_message" has values grater than 1
## are in separate test file: compression_limit_message_count.test
##

--let $xplugin_disable_ssl_for_x_at_client_side=1
--let $xplugin_cache_x_root=1
--source include/xplugin_preamble.inc
--source include/xplugin_create_user.inc

## Test starts here
--write_file $MYSQL_TMP_DIR/resultset.xpl
-->import assert_status_variable.macro

-->echo
-->echo
-->echo ## I. Validate simple resultsets
-->echo #
-->echo # 1. Assert resultset for select with single column
-->echo # 2. Assert resultset for select with multiple columns
-->echo # 3. Assert resultset for select with multiple rows
-->echo
-->echo ## II. Validate simple multi-resultsets
-->echo #
-->echo # 1. Assert two resultsets for select queries
-->echo # 2. Assert three resultsets for select queries
-->echo
-->echo ## III. Assert client side status variables
-->echo #
-->echo


-->echo
-->echo #
-->echo # I.1
SELECT 1;
SELECT 1 as "Value";

-->echo
-->echo #
-->echo # I.2
SELECT 1 as "Column1", 2 as "Column2", 3 as "Column3";
SELECT phrase FROM xtest.xtable;
SELECT phrase, prio FROM xtest.xtable;

-->echo
-->echo #
-->echo # II.1
CALL two_resultsets();

-->echo
-->echo #
-->echo # II.2
CALL three_results_sets();


-->echo
-->echo #
-->echo # III
callmacro Assert_client_message_count	Mysqlx.Connection.Compression	==	%COMP_COUNT%;

EOF

let $STORED_PROC_DB_NAME=xtest;
source ../include/stored_procedures.inc;
source ../include/sample_tables.inc;
CALL recreate_tables();


--echo
--echo ## A. Execute the test using zlib/single
--echo #

exec $MYSQLXTEST
  -ux_root --password=''
  --schema=xtest
  --compression-mode=required --compression-algorithm=deflate_stream
  --compression-combine-mixed-messages=0
  --compression-max-combine-messages=1
  -v%COMP_COUNT%=59
  --file=$MYSQL_TMP_DIR/resultset.xpl 2>&1;


--echo
--echo ## B. Execute the test using lz4/single
--echo #

exec $MYSQLXTEST
  -ux_root --password=''
  --schema=xtest
  --compression-mode=required --compression-algorithm=lz4_message
  --compression-combine-mixed-messages=0
  --compression-max-combine-messages=1
  -v%COMP_COUNT%=59
  -v%MULTIPLE_COUNT%=0
  -v%GROUP_COUNT%=0
  --file=$MYSQL_TMP_DIR/resultset.xpl 2>&1;


--echo
--echo ## C. Execute the test using zlib/multiple
--echo #

exec $MYSQLXTEST
  -ux_root --password=''
  --schema=xtest
  --compression-mode=required --compression-algorithm=deflate_stream
  --compression-combine-mixed-messages=0
  --compression-max-combine-messages=0
  -v%COMP_COUNT%=39
  --file=$MYSQL_TMP_DIR/resultset.xpl 2>&1;


--echo
--echo ## D. Execute the test using lz4/multiple
--echo #

exec $MYSQLXTEST
  -ux_root --password=''
  --schema=xtest
  --compression-mode=required --compression-algorithm=lz4_message
  --compression-combine-mixed-messages=0
  --compression-max-combine-messages=0
  -v%COMP_COUNT%=39
  --file=$MYSQL_TMP_DIR/resultset.xpl 2>&1;


--echo
--echo ## E. Execute the test using zlib/group
--echo #

exec $MYSQLXTEST
  -ux_root --password=''
  --schema=xtest
  --compression-mode=required --compression-algorithm=deflate_stream
  --compression-combine-mixed-messages=1
  --compression-max-combine-messages=0
  -v%COMP_COUNT%=7
  --file=$MYSQL_TMP_DIR/resultset.xpl 2>&1;


--echo
--echo ## F. Execute the test using lz4/group
--echo #

exec $MYSQLXTEST
  -ux_root --password=''
  --schema=xtest
  --compression-mode=required --compression-algorithm=lz4_message
  --compression-combine-mixed-messages=1
  --compression-max-combine-messages=0
  -v%COMP_COUNT%=7
  --file=$MYSQL_TMP_DIR/resultset.xpl 2>&1;

--echo
--echo ## G. Execute the test using zstd/single
--echo #

exec $MYSQLXTEST
  -ux_root --password=''
  --schema=xtest
  --compression-mode=required
  --compression-algorithm=zstd_stream
  --compression-combine-mixed-messages=0
  --compression-max-combine-messages=1
  -v%COMP_COUNT%=59
  -v%MULTIPLE_COUNT%=0
  -v%GROUP_COUNT%=0
  --file=$MYSQL_TMP_DIR/resultset.xpl 2>&1;

--echo
--echo ## H. Execute the test using zstd/multiple
--echo #

exec $MYSQLXTEST
  -ux_root --password=''
  --schema=xtest
  --compression-mode=required
  --compression-algorithm=zstd_stream
  --compression-combine-mixed-messages=0
  --compression-max-combine-messages=0
  -v%COMP_COUNT%=39
  --file=$MYSQL_TMP_DIR/resultset.xpl 2>&1;

--echo
--echo ## I. Execute the test using zstd/group
--echo #

exec $MYSQLXTEST
  -ux_root --password=''
  --schema=xtest
  --compression-mode=required
  --compression-algorithm=zstd_stream
  --compression-combine-mixed-messages=1
  --compression-max-combine-messages=0
  -v%COMP_COUNT%=7
  --file=$MYSQL_TMP_DIR/resultset.xpl 2>&1;

## Cleanup
--source ../include/xplugin_cleanup.inc
