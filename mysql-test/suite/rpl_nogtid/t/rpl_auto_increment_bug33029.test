# BUG#33029 5.0 to 5.1 replication fails on dup key when inserting
# using a trig in SP

# For all 5.0 up to 5.0.58 exclusive, and 5.1 up to 5.1.12 exclusive,
# if one statement in a SP generated AUTO_INCREMENT value by the top
# statement, all statements after it would be considered generated
# AUTO_INCREMENT value by the top statement, and a erroneous INSERT_ID
# value might be associated with these statement, which could cause
# duplicate entry error and stop the slave.

# Test if the slave can replicate from such a buggy master

# The bug33029-slave-relay-bin.000001 file is the
# slave-replay-bin.000003 file generated by run the
# rpl_auto_increment_bug33029.test with clean up statements at the end
# of the test case removed on a buggy 5.0 server

--source include/not_group_replication_plugin.inc
--let $rpl_skip_start_slave= 1
--source include/not_have_privilege_checks_user.inc
--source include/master-slave.inc

--echo ==== Initialize ====
--connection slave

# The binlog we read does funny things with triggers and causes this warning.
--disable_query_log
CALL mtr.add_suppression('Unsafe statement written to the binary log using statement format since BINLOG_FORMAT = STATEMENT');
CALL mtr.add_suppression("Either event.*is from an old master");
--enable_query_log

# Need to restore this at the end; CHANGE MASTER modifies it (see the
# manual for CHANGE MASTER).
SET @old_relay_log_purge= @@global.relay_log_purge;

# the relay log contains create t1, t2 tables and load data infile
--let $fake_relay_log = $MYSQL_TEST_DIR/std_data/bug33029-slave-relay-bin.000001
--source include/setup_fake_relay_log.inc

--echo ==== Test ====
start slave sql_thread;
--let $slave_param= Exec_Master_Log_Pos
--let $slave_param_value= 3776
--source include/wait_for_slave_param.inc


echo # Result on slave;
SELECT * FROM t1;
SELECT * FROM t2;

--echo ==== Clean up ====

stop slave sql_thread;
--source include/cleanup_fake_relay_log.inc

DROP TABLE t1, t2;
DROP PROCEDURE p1;
DROP PROCEDURE p2;
DROP FUNCTION f1;

SET @@global.relay_log_purge= @old_relay_log_purge;
--let $rpl_only_running_threads= 1
--source include/rpl_end.inc
