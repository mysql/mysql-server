--source include/not_group_replication_plugin.inc
--source include/master-slave.inc

#
# BUG#16621582: REPLICATION FAILS WITH ERROR 1837 WHEN DOING MULTI-TABLE UPDATES WITH SAVEPOINTS
#

--source include/rpl_connection_slave.inc
--source include/gtid_utils.inc
--source include/rpl_connection_master.inc

--source include/rpl_reset.inc

--let $server_uuid= SELECT @@server_uuid

CREATE TABLE t1(c1 int) ENGINE=InnoDB;
CREATE TABLE t2(c1 int) ENGINE=InnoDB;

#
# Test #1: assert that on multi-table updates the tables are
#          marked correctly, even if no table is updated at
#          all
#


--source include/sync_slave_sql_with_master.inc

# needed for the assert below
--let $saved_gtid_executed= `SELECT @@GLOBAL.GTID_EXECUTED`

--source include/rpl_connection_master.inc

START TRANSACTION;
UPDATE t1,t2 SET t1.c1 = 0;
SAVEPOINT sp1;
UPDATE t1,t2 SET t1.c1 = 0;
SAVEPOINT sp2;
COMMIT;

--source include/sync_slave_sql_with_master.inc

# assert that we have 1 more transaction in STMT or MIXED
# or no additional transaction at all in RBR
--let $current_gtid_executed= `SELECT @@GLOBAL.GTID_EXECUTED`
--let $saved_gtid_cnt= `SELECT GTID_COUNT('$saved_gtid_executed')`
--let $current_gtid_cnt= `SELECT GTID_COUNT('$current_gtid_executed')`
if (`SELECT @@binlog_format = 'row'`)
{
  # nothing was logged in RBR
  --let $expected_gtid_cnt= $saved_gtid_cnt
}
if (`SELECT @@binlog_format <> 'row'`)
{
  --let $expected_gtid_cnt= `SELECT $saved_gtid_cnt + 1`
}

--let $assert_cond= $current_gtid_cnt = $expected_gtid_cnt
--let $assert_text= The correct count of transactions is expected on the slave
--source include/assert.inc

--source include/rpl_connection_master.inc

#
# Test #2: assert that on multi-table updates the tables are
#          marked correctly, even if the table is updated on
#          the fly
#

INSERT INTO t1 VALUES (1);
INSERT INTO t2 VALUES (2);

--source include/sync_slave_sql_with_master.inc

# needed for the assert below
--let $saved_gtid_executed= `SELECT @@GLOBAL.GTID_EXECUTED`

--source include/rpl_connection_master.inc

START TRANSACTION;
UPDATE t1,t2 SET t1.c1 = 0;
COMMIT;

--source include/sync_slave_sql_with_master.inc

# assert that we have 1 more transaction in STMT or MIXED
# or no additional transaction at all in RBR
--let $current_gtid_executed= `SELECT @@GLOBAL.GTID_EXECUTED`
--let $saved_gtid_cnt= `SELECT GTID_COUNT('$saved_gtid_executed')`
--let $current_gtid_cnt= `SELECT GTID_COUNT('$current_gtid_executed')`
--let $expected_gtid_cnt= `SELECT $saved_gtid_cnt + 1`

--let $assert_cond= $current_gtid_cnt = $expected_gtid_cnt
--let $assert_text= The correct count of transactions is expected on the slave
--source include/assert.inc

--source include/rpl_connection_master.inc

DROP TABLE t1;
DROP TABLE t2;

--source include/sync_slave_sql_with_master.inc
--source include/gtid_utils_end.inc
--source include/rpl_connection_master.inc

--source include/rpl_end.inc
