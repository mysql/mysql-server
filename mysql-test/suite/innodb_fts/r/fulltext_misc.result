drop table if exists t1;
#
# Bug#56814 Explain + subselect + fulltext crashes server
#
CREATE TABLE t1(f1 VARCHAR(6) NOT NULL,FULLTEXT KEY(f1),UNIQUE(f1)) ENGINE = InnoDB;
INSERT INTO t1 VALUES ('test');
EXPLAIN SELECT 1 FROM t1
WHERE 1 > ALL((SELECT 1 FROM t1 JOIN t1 a ON (MATCH(t1.f1) AGAINST (""))
WHERE t1.f1 GROUP BY t1.f1));
id	select_type	table	partitions	type	possible_keys	key	key_len	ref	rows	filtered	Extra
1	PRIMARY	t1	NULL	index	NULL	f1_2	26	NULL	1	100.00	Using index
2	SUBQUERY	t1	NULL	fulltext	f1	f1	0	const	1	100.00	Using where; Ft_hints: no_ranking
2	SUBQUERY	a	NULL	index	NULL	f1_2	26	NULL	1	100.00	Using index
Warnings:
Note	1003	/* select#1 */ select 1 AS `1` from `test`.`t1` where true
PREPARE stmt FROM
'EXPLAIN SELECT 1 FROM t1
 WHERE 1 > ALL((SELECT 1 FROM t1 RIGHT OUTER JOIN t1 a
 ON (MATCH(t1.f1) AGAINST (""))
 WHERE t1.f1 GROUP BY t1.f1))';
EXECUTE stmt;
id	select_type	table	partitions	type	possible_keys	key	key_len	ref	rows	filtered	Extra
1	PRIMARY	t1	NULL	index	NULL	f1_2	26	NULL	1	100.00	Using index
2	SUBQUERY	a	NULL	index	NULL	f1_2	26	NULL	1	100.00	Using index
2	SUBQUERY	t1	NULL	fulltext	f1	f1	0	const	1	100.00	Using where; Ft_hints: no_ranking
Warnings:
Note	1003	/* select#1 */ select 1 AS `1` from `test`.`t1` where true
EXECUTE stmt;
id	select_type	table	partitions	type	possible_keys	key	key_len	ref	rows	filtered	Extra
1	PRIMARY	t1	NULL	index	NULL	f1_2	26	NULL	1	100.00	Using index
2	SUBQUERY	a	NULL	index	NULL	f1_2	26	NULL	1	100.00	Using index
2	SUBQUERY	t1	NULL	fulltext	f1	f1	0	const	1	100.00	Using where; Ft_hints: no_ranking
Warnings:
Note	1003	/* select#1 */ select 1 AS `1` from `test`.`t1` where true
DEALLOCATE PREPARE stmt;
PREPARE stmt FROM
'EXPLAIN SELECT 1 FROM t1
 WHERE 1 > ALL((SELECT 1 FROM t1 JOIN t1 a
 ON (MATCH(t1.f1) AGAINST (""))
 WHERE t1.f1 GROUP BY t1.f1))';
EXECUTE stmt;
id	select_type	table	partitions	type	possible_keys	key	key_len	ref	rows	filtered	Extra
1	PRIMARY	t1	NULL	index	NULL	f1_2	26	NULL	1	100.00	Using index
2	SUBQUERY	t1	NULL	fulltext	f1	f1	0	const	1	100.00	Using where; Ft_hints: no_ranking
2	SUBQUERY	a	NULL	index	NULL	f1_2	26	NULL	1	100.00	Using index
Warnings:
Note	1003	/* select#1 */ select 1 AS `1` from `test`.`t1` where true
EXECUTE stmt;
id	select_type	table	partitions	type	possible_keys	key	key_len	ref	rows	filtered	Extra
1	PRIMARY	t1	NULL	index	NULL	f1_2	26	NULL	1	100.00	Using index
2	SUBQUERY	t1	NULL	fulltext	f1	f1	0	const	1	100.00	Using where; Ft_hints: no_ranking
2	SUBQUERY	a	NULL	index	NULL	f1_2	26	NULL	1	100.00	Using index
Warnings:
Note	1003	/* select#1 */ select 1 AS `1` from `test`.`t1` where true
DEALLOCATE PREPARE stmt;
DROP TABLE t1;
drop table if exists t1;
CREATE TABLE t1 (
kodoboru varchar(10) default NULL,
obor tinytext,
aobor tinytext,
UNIQUE INDEX kodoboru (kodoboru),
FULLTEXT KEY obor (obor),
FULLTEXT KEY aobor (aobor)
) ENGINE = InnoDB;
drop table t1;
CREATE TABLE t1 (
kodoboru varchar(10) default NULL,
obor tinytext,
aobor tinytext,
UNIQUE INDEX kodoboru (kodoboru),
FULLTEXT KEY obor (obor)
) ENGINE = InnoDB;
INSERT INTO t1 VALUES ('0101000000','aaa','AAA');
INSERT INTO t1 VALUES ('0102000000','bbb','BBB');
INSERT INTO t1 VALUES ('0103000000','ccc','CCC');
INSERT INTO t1 VALUES ('0104000000','xxx','XXX');
select * from t1;
kodoboru	obor	aobor
0101000000	aaa	AAA
0102000000	bbb	BBB
0103000000	ccc	CCC
0104000000	xxx	XXX
drop table t1;
create table t1 (c1 varchar(1), c2 int, c3 int, c4 int, c5 int, c6 int,
c7 int, c8 int, c9 int, fulltext key (`c1`)) ENGINE = InnoDB;
select distinct match (`c1`) against ('z') , c2, c3, c4,c5, c6,c7, c8
from t1 where c9=1 order by c2, c2;
match (`c1`) against ('z')	c2	c3	c4	c5	c6	c7	c8
drop table t1;
CREATE TABLE t1 (c1 int not null auto_increment primary key, c2 varchar(20), fulltext(c2)) ENGINE = InnoDB;
insert into t1 (c2) VALUES ('real Beer'),('Water'),('Kossu'),('Coca-Cola'),('Vodka'),('Wine'),('almost real Beer');
select * from t1 WHERE match (c2) against ('Beer');
c1	c2
1	real Beer
7	almost real Beer
CREATE VIEW v1 AS SELECT  * from t1 WHERE match (c2) against ('Beer');
select * from v1;
c1	c2
1	real Beer
7	almost real Beer
drop view v1;
drop table t1;
create table t1 (mytext text, FULLTEXT (mytext)) ENGINE = InnoDB;
insert t1 values ('aaabbb');
check table t1;
Table	Op	Msg_type	Msg_text
test.t1	check	status	OK
check table t1;
Table	Op	Msg_type	Msg_text
test.t1	check	status	OK
drop table t1;
create table t1 (a varchar(10), fulltext key(a)) ENGINE = InnoDB;
insert into t1 values ('a');
select hex(concat(match (a) against ('a'))) from t1;
hex(concat(match (a) against ('a')))
30
create table t2 ENGINE = InnoDB as select concat(match (a) against ('a')) as a from t1;
show create table t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `a` varchar(22) DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
drop table t1, t2;
CREATE TABLE t1(a TEXT CHARSET ucs2 COLLATE ucs2_unicode_ci) ENGINE = InnoDB;
Warnings:
Warning	1287	'ucs2' is deprecated and will be removed in a future release. Please use utf8mb4 instead
Warning	4079	'ucs2_unicode_ci' is a collation of the deprecated character set ucs2. Please consider using utf8mb4 with an appropriate collation instead.
INSERT INTO t1 VALUES('abcd');
SELECT * FROM t1 WHERE MATCH(a) AGAINST ('+abcd' IN BOOLEAN MODE);
ERROR HY000: Can't find FULLTEXT index matching the column list
DROP TABLE t1;
create table t1 (a varchar(10), key(a), fulltext (a)) ENGINE = InnoDB;
insert into t1 values ("a"),("abc"),("abcd"),("hello"),("test");
ANALYZE TABLE t1;
select * from t1 where a like "abc%";
a
abc
abcd
select * from t1 where a like "test%";
a
test
select * from t1 where a like "te_t";
a
test
select * from t1 where match a against ("te*" in boolean mode)+0;
a
test
drop table t1;
# 
# Bug #49734: Crash on EXPLAIN UNION ... ORDER BY 
#   <any non-const-function>
# 
CREATE TABLE t1 (a VARCHAR(10), FULLTEXT KEY a (a)) ENGINE = InnoDB;
INSERT INTO t1 VALUES (1),(2);
CREATE TABLE t2 (b INT) ENGINE = InnoDB;
INSERT INTO t2 VALUES (1),(2);
# Should not crash
EXPLAIN
SELECT * FROM t1 UNION SELECT * FROM t1 ORDER BY a + 12;
id	select_type	table	partitions	type	possible_keys	key	key_len	ref	rows	filtered	Extra
1	PRIMARY	t1	NULL	ALL	NULL	NULL	NULL	NULL	2	100.00	NULL
2	UNION	t1	NULL	ALL	NULL	NULL	NULL	NULL	2	100.00	NULL
3	UNION RESULT	<union1,2>	NULL	ALL	NULL	NULL	NULL	NULL	NULL	NULL	Using temporary; Using filesort
Warnings:
Note	1003	/* select#1 */ select `test`.`t1`.`a` AS `a` from `test`.`t1` union /* select#2 */ select `test`.`t1`.`a` AS `a` from `test`.`t1` order by (`a` + 12)
# Should not crash
SELECT * FROM t1 UNION SELECT * FROM t1 ORDER BY a + 12;
a
1
2
# Should not crash
EXPLAIN
SELECT * FROM t1 UNION SELECT * FROM t1
ORDER BY MATCH(a) AGAINST ('+abc' IN BOOLEAN MODE);
ERROR HY000: The used table type doesn't support FULLTEXT indexes
# Should not crash
SELECT * FROM t1 UNION SELECT * FROM t1
ORDER BY MATCH(a) AGAINST ('+abc' IN BOOLEAN MODE);
ERROR HY000: The used table type doesn't support FULLTEXT indexes
# Should not crash
EXPLAIN
SELECT * FROM t1 UNION SELECT * FROM t1
ORDER BY (SELECT a FROM t2 WHERE b = 12);
id	select_type	table	partitions	type	possible_keys	key	key_len	ref	rows	filtered	Extra
1	PRIMARY	t1	NULL	ALL	NULL	NULL	NULL	NULL	2	100.00	NULL
2	UNION	t1	NULL	ALL	NULL	NULL	NULL	NULL	2	100.00	NULL
4	UNION RESULT	<union1,2>	NULL	ALL	NULL	NULL	NULL	NULL	NULL	NULL	Using temporary; Using filesort
5	DEPENDENT SUBQUERY	t2	NULL	ALL	NULL	NULL	NULL	NULL	2	50.00	Using where
Warnings:
Note	1276	Field or reference 'a' of SELECT #5 was resolved in SELECT #1
Note	1003	/* select#1 */ select `test`.`t1`.`a` AS `a` from `test`.`t1` union /* select#2 */ select `test`.`t1`.`a` AS `a` from `test`.`t1` order by (/* select#5 */ select `a` from `test`.`t2` where (`test`.`t2`.`b` = 12))
# Should not crash
SELECT * FROM t1 UNION SELECT * FROM t1
ORDER BY (SELECT a FROM t2 WHERE b = 12);
# Should not crash
SELECT * FROM t2 UNION SELECT * FROM t2
ORDER BY (SELECT * FROM t1 WHERE MATCH(a) AGAINST ('+abc' IN BOOLEAN MODE));
b
1
2
DROP TABLE t1,t2;
End of 5.1 tests
#
# Bug#32979815: WL#14422: ASSERTION `!(USED_TABS & (~READ_TABLES & ~FILTER_FOR_TABLE))' FAILED
#
CREATE TABLE t (x VARCHAR(10), FULLTEXT (x));
SELECT 1 FROM t
WHERE x IN
(SELECT MATCH (t2.x) AGAINST ('abc')
FROM t AS t1 JOIN t AS t2
ON t1.x = t2.x
GROUP BY t2.x
HAVING t2.x = '');
1
DROP TABLE t;
#
# Bug#32980875: WL#14422: ASSERTION `FALSE' FAILED|SQL/BASIC_ROW_ITERATORS.H
#
CREATE TABLE t (a VARCHAR(10), FULLTEXT (a));
INSERT INTO t VALUES ('a'), ('b'), ('c');
ANALYZE TABLE t;
Table	Op	Msg_type	Msg_text
test.t	analyze	status	OK
PREPARE prep_stmt FROM '

 SELECT DISTINCT
   MATCH (t1.a) AGAINST(''x''),
   MIN(t2.a),
   t1.a
 FROM t AS t1 JOIN t AS t2 ON t1.a = t2.a
 GROUP BY MATCH (t1.a) AGAINST(''x''), t1.a

';
EXECUTE prep_stmt;
MATCH (t1.a) AGAINST('x')	MIN(t2.a)	a
0	a	a
0	b	b
0	c	c
EXECUTE prep_stmt;
MATCH (t1.a) AGAINST('x')	MIN(t2.a)	a
0	a	a
0	b	b
0	c	c
DEALLOCATE PREPARE prep_stmt;
DROP TABLE t;
#
# Bug#32990422: WL#14422: RESULT MISMATCH WITH FTS FUNCTION
#
CREATE TABLE t (i INTEGER, x VARCHAR(10), FULLTEXT (x));
INSERT INTO t VALUES (0, 'a'), (1, 'b'), (0, 'c');
SELECT i = 0 AS a, MATCH(x) AGAINST('d') AS b FROM t GROUP BY a, b;
a	b
0	0
1	0
DROP TABLE t;
#
# Bug#32996515: WL#14422: RESULT MISMATCH WITH DISTINCT AND GROUP BY ON FTS FUNCTION
#
CREATE TABLE t (a INTEGER, b VARCHAR(10), FULLTEXT(b));
INSERT INTO t VALUES (1, 'a'), (2, 'b');
SELECT DISTINCT MATCH (b) AGAINST ('x'), a
FROM t GROUP BY MATCH (b) AGAINST ('x'), a;
MATCH (b) AGAINST ('x')	a
0	1
0	2
DROP TABLE t;
#
# Bug#34782389: Assertion `item->hidden == hidden' failed.
#
CREATE TABLE t (a VARCHAR(10), FULLTEXT(a));
INSERT INTO t VALUES ('abc'), ('xyz');
SELECT 0 IN (SELECT MATCH (a) AGAINST ('abc') FROM t);
0 IN (SELECT MATCH (a) AGAINST ('abc') FROM t)
1
DROP TABLE t;
