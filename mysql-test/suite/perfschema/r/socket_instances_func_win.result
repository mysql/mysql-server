CREATE TEMPORARY TABLE my_socket_instances AS
SELECT * FROM performance_schema.socket_instances;
SELECT THREAD_ID INTO @thread_id
FROM performance_schema.threads
WHERE PROCESSLIST_ID = CONNECTION_ID();
# Establish local TCP/IP connection (con1,127.0.0.1,root,,test,,)
SELECT THREAD_ID INTO @thread_id
FROM performance_schema.threads
WHERE PROCESSLIST_ID = CONNECTION_ID();
SELECT PORT INTO @port
FROM performance_schema.socket_instances
WHERE THREAD_ID = 19;
# Switch to connection default
# Establish a second local TCP/IP connection (con2,127.0.0.1,root,,test,,)
SELECT THREAD_ID INTO @thread_id
FROM performance_schema.threads
WHERE PROCESSLIST_ID = CONNECTION_ID();
SELECT PORT INTO @port
FROM performance_schema.socket_instances
WHERE THREAD_ID = 20;
# Switch to connection default
# EVENT_NAME is the "wait/io/socket/*" instrument identifier.
SELECT COUNT(*) = 0 AS "Expect 1"
FROM performance_schema.socket_instances
WHERE EVENT_NAME NOT LIKE 'wait/io/socket/%';
Expect 1
1
SELECT DISTINCT EVENT_NAME
FROM performance_schema.socket_instances
ORDER BY EVENT_NAME;
EVENT_NAME
wait/io/socket/com/client_connection
wait/io/socket/com/server_tcpip_socket
# OBJECT_INSTANCE_BEGIN is an arbitrary identifier, guaranteed to be unique.
SELECT COUNT(*) = COUNT(DISTINCT OBJECT_INSTANCE_BEGIN) AS "Expect 1"
FROM performance_schema.socket_instances;
Expect 1
1
# SOCKET_ID is the internal file handle assigned to the socket.
SELECT COUNT(*) = COUNT(DISTINCT SOCKET_ID) AS "Expect 1"
FROM performance_schema.socket_instances;
Expect 1
1
# Characteristics per our thread
#    There must be only one entry with our thread_id
SELECT COUNT(*) = 1 AS 'Expect 1'
FROM performance_schema.socket_instances
WHERE THREAD_ID = @thread_id;
Expect 1
1
# TCP/IP connections should have a unique port number
SELECT COUNT(*) = 1 AS 'Expect 1'
FROM performance_schema.socket_instances
WHERE PORT = <con1_port>;
Expect 1
1
SELECT COUNT(*) = 1 AS 'Expect 1'
FROM performance_schema.socket_instances
WHERE PORT = <con2_port>;
Expect 1
1
#    Check the content for the default connection (tcpip)
SELECT EVENT_NAME = 'wait/io/socket/com/client_connection'
   AND IP = '127.0.0.1' AS 'Expect 1'
FROM performance_schema.socket_instances
WHERE THREAD_ID = @thread_id;
Expect 1
1
# Characteristics of 'server_tcpip_socket' entry
#    Server listening socket, TCP/IP
#    There is only one entry with 'wait/io/socket/com/server_tcpip_socket'.
SELECT COUNT(*) = 1 AS 'Expect 1'
FROM performance_schema.socket_instances
WHERE EVENT_NAME = 'wait/io/socket/com/server_tcpip_socket';
Expect 1
1
# Get the 'server_tcpip_socket' thread id
SELECT THREAD_ID INTO @thread_id
FROM performance_schema.socket_instances
WHERE EVENT_NAME = 'wait/io/socket/com/server_tcpip_socket';
#    Check the content.
SELECT THREAD_ID = 16
AND PORT = <MASTER_MYPORT> AND IP = '0.0.0.0'
     AND STATE = 'ACTIVE' AS 'Expect 1'
FROM performance_schema.socket_instances
WHERE EVENT_NAME = 'wait/io/socket/com/server_tcpip_socket';
Expect 1
1
# Server listening socket (TCP) is handled on one thread
SELECT COUNT(*) = 1 AS 'Expect 1'
FROM performance_schema.socket_instances
WHERE THREAD_ID = 16;
Expect 1
1
#    Check content for client connection 1 (tcpip)
SELECT EVENT_NAME = 'wait/io/socket/com/client_connection'
        AND IP = '127.0.0.1'
        AND PORT = <con1_port>
AS 'Expect 1'
FROM performance_schema.socket_instances
WHERE THREAD_ID = 19;
Expect 1
1
# Characteristics of entries with THREAD_ID of con1
#    There is only one entry with this id.
SELECT COUNT(*) = 1 AS 'Expect 1'
FROM performance_schema.socket_instances
WHERE THREAD_ID = <con1_thread_id>;
Expect 1
1
#    Check content for client connection 2 (tcpip)
SELECT EVENT_NAME = 'wait/io/socket/com/client_connection'
        AND IP = '127.0.0.1'
        AND PORT = <con2_port>
AS 'Expect 1'
FROM performance_schema.socket_instances
WHERE THREAD_ID = 20;
Expect 1
1
# Characteristics of entries with THREAD_ID of con2
#    There is only one entry with this id.
SELECT COUNT(*) = 1 AS 'Expect 1'
FROM performance_schema.socket_instances
WHERE THREAD_ID = <con2_thread_id>;
Expect 1
1
# Show differences to socket_instances before con1 connecting
SELECT EVENT_NAME, IP
FROM performance_schema.socket_instances
WHERE (EVENT_NAME,OBJECT_INSTANCE_BEGIN,THREAD_ID,SOCKET_ID,IP,PORT,STATE)
NOT IN (SELECT EVENT_NAME,OBJECT_INSTANCE_BEGIN,THREAD_ID,SOCKET_ID,IP,PORT,STATE
FROM my_socket_instances)
ORDER BY THREAD_ID;
EVENT_NAME	IP
wait/io/socket/com/client_connection	127.0.0.1
wait/io/socket/com/client_connection	127.0.0.1
# Disconnect con1 and con2
# Show differences to socket_instances before con1 connecting.
# There should be none.
SELECT *
FROM performance_schema.socket_instances
WHERE (EVENT_NAME,OBJECT_INSTANCE_BEGIN,THREAD_ID,SOCKET_ID,IP,PORT,STATE)
NOT IN (SELECT EVENT_NAME,OBJECT_INSTANCE_BEGIN,THREAD_ID,SOCKET_ID,IP,PORT,STATE
FROM my_socket_instances)
ORDER BY THREAD_ID;
EVENT_NAME	OBJECT_INSTANCE_BEGIN	THREAD_ID	SOCKET_ID	IP	PORT	STATE
