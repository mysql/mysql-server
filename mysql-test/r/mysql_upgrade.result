# restart:--upgrade=FORCE --sql-mode=ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION,ANSI_QUOTES --log-error=MYSQLD_LOG
# There should be no errors
Pattern "\[ERROR\]" not found
# mysql_upgrade_info file should be created successfully.
Pattern "Could not open server upgrade info file \'.*\' for writing\. Please make sure the file is writable\." not found
# Restart server with defaults
# restart:
#
# Bug #27549249: MYSQL_UPGRADE FAILED TO CHANGE @@SESSION.SQL_LOG_BIN
#   WHEN AUTOCOMMIT IS OFF
#
# restart:--upgrade=FORCE --autocommit=0
# Restart server with defaults
# restart:
#
# Bug #28392985: SESSION USER DOES NOT HAVE PRIV SESSION_VARIABLES_ADMIN IN UPGRADED DATABASE
#
SHOW GRANTS FOR "mysql.session"@localhost;
Grants for mysql.session@localhost
GRANT SHUTDOWN, SUPER ON *.* TO `mysql.session`@`localhost`
GRANT AUDIT_ABORT_EXEMPT,AUTHENTICATION_POLICY_ADMIN,BACKUP_ADMIN,CLONE_ADMIN,CONNECTION_ADMIN,FIREWALL_EXEMPT,PERSIST_RO_VARIABLES_ADMIN,SESSION_VARIABLES_ADMIN,SYSTEM_USER,SYSTEM_VARIABLES_ADMIN ON *.* TO `mysql.session`@`localhost`
GRANT SELECT ON `performance_schema`.* TO `mysql.session`@`localhost`
GRANT SELECT ON `mysql`.`user` TO `mysql.session`@`localhost`
REVOKE SESSION_VARIABLES_ADMIN ON *.* FROM "mysql.session"@localhost;
# restart:--upgrade=FORCE
# Must have SESSION_VARIABLES_ADMIN;
SHOW GRANTS FOR "mysql.session"@localhost;
Grants for mysql.session@localhost
GRANT SHUTDOWN, SUPER ON *.* TO `mysql.session`@`localhost`
GRANT AUDIT_ABORT_EXEMPT,AUTHENTICATION_POLICY_ADMIN,BACKUP_ADMIN,CLONE_ADMIN,CONNECTION_ADMIN,FIREWALL_EXEMPT,PERSIST_RO_VARIABLES_ADMIN,SESSION_VARIABLES_ADMIN,SYSTEM_USER,SYSTEM_VARIABLES_ADMIN ON *.* TO `mysql.session`@`localhost`
GRANT SELECT ON `performance_schema`.* TO `mysql.session`@`localhost`
GRANT SELECT ON `mysql`.`user` TO `mysql.session`@`localhost`
#
# Bug #28855207: 8.0.13 - MYSQL_UPGRADE FAILS DUE TO PRIMARY KEY ERROR WITHOUT STATING THE TABLE
#
# restart: --sql_require_primary_key=1 --upgrade=FORCE
#
# Bug #29702060: BE MORE ROBUST IF MYSQL_UPGRADE_INFO IS NOT WRITABLE
#
# restart:--upgrade=FORCE --log-error=MYSQLD_LOG

Pattern "Could not open server upgrade info file \'.*\' for writing\. Please make sure the file is writable\." found
# Cleanup
# restart: 
#
# Bug #33165861: WL#14183 new privileges not taken into account for upgrades
#
CREATE USER u1,u2;
GRANT CREATE USER ON *.* TO u1;
GRANT SYSTEM_VARIABLES_ADMIN ON *.* TO u2;
# There should be no PASSWORDLESS_USER_ADMIN privilege
SHOW GRANTS FOR u1;
Grants for u1@%
GRANT CREATE USER ON *.* TO `u1`@`%`
# There should be no AUTHENTICATION_POLICY_ADMIN privilege
SHOW GRANTS FOR u2;
Grants for u2@%
GRANT USAGE ON *.* TO `u2`@`%`
GRANT SYSTEM_VARIABLES_ADMIN ON *.* TO `u2`@`%`
REVOKE PASSWORDLESS_USER_ADMIN, AUTHENTICATION_POLICY_ADMIN ON *.* FROM root@localhost;
# restart:--upgrade=FORCE
# Must have PASSWORDLESS_USER_ADMIN privilege
SHOW GRANTS FOR u1;
Grants for u1@%
GRANT CREATE USER, CREATE ROLE, DROP ROLE ON *.* TO `u1`@`%`
GRANT PASSWORDLESS_USER_ADMIN ON *.* TO `u1`@`%`
# Must have AUTHENTICATION_POLICY_ADMIN privilege
SHOW GRANTS FOR u2;
Grants for u2@%
GRANT USAGE ON *.* TO `u2`@`%`
GRANT SYSTEM_VARIABLES_ADMIN ON *.* TO `u2`@`%`
# Must have AUTHENTICATION_POLICY_ADMIN, PASSWORDLESS_USER_ADMIN privilegea
SHOW GRANTS FOR root@localhost;
Grants for root@localhost
GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, RELOAD, SHUTDOWN, PROCESS, FILE, REFERENCES, INDEX, ALTER, SHOW DATABASES, SUPER, CREATE TEMPORARY TABLES, LOCK TABLES, EXECUTE, REPLICATION SLAVE, REPLICATION CLIENT, CREATE VIEW, SHOW VIEW, CREATE ROUTINE, ALTER ROUTINE, CREATE USER, EVENT, TRIGGER, CREATE TABLESPACE, CREATE ROLE, DROP ROLE ON *.* TO `root`@`localhost` WITH GRANT OPTION
GRANT APPLICATION_PASSWORD_ADMIN,AUDIT_ABORT_EXEMPT,AUDIT_ADMIN,BACKUP_ADMIN,BINLOG_ADMIN,BINLOG_ENCRYPTION_ADMIN,CLONE_ADMIN,CONNECTION_ADMIN,ENCRYPTION_KEY_ADMIN,FIREWALL_EXEMPT,FLUSH_OPTIMIZER_COSTS,FLUSH_STATUS,FLUSH_TABLES,FLUSH_USER_RESOURCES,GROUP_REPLICATION_ADMIN,GROUP_REPLICATION_STREAM,INNODB_REDO_LOG_ARCHIVE,INNODB_REDO_LOG_ENABLE,PASSWORDLESS_USER_ADMIN,PERSIST_RO_VARIABLES_ADMIN,REPLICATION_APPLIER,REPLICATION_SLAVE_ADMIN,RESOURCE_GROUP_ADMIN,RESOURCE_GROUP_USER,ROLE_ADMIN,SENSITIVE_VARIABLES_OBSERVER,SERVICE_CONNECTION_ADMIN,SESSION_VARIABLES_ADMIN,SET_USER_ID,SHOW_ROUTINE,SYSTEM_USER,SYSTEM_VARIABLES_ADMIN,TABLE_ENCRYPTION_ADMIN,XA_RECOVER_ADMIN ON *.* TO `root`@`localhost` WITH GRANT OPTION
GRANT PROXY ON ``@`` TO `root`@`localhost` WITH GRANT OPTION
DROP USER u1,u2;
#
# Bug#34068378: Grant SENSITIVE_VARIABLES_OBSERVER in case of database upgrade
#
CREATE USER u34068378;
GRANT SYSTEM_VARIABLES_ADMIN ON *.* TO u34068378;
# There should be no SENSITIVE_VARIABLES_OBSERVER privilege
SHOW GRANTS for u34068378;
Grants for u34068378@%
GRANT USAGE ON *.* TO `u34068378`@`%`
GRANT SYSTEM_VARIABLES_ADMIN ON *.* TO `u34068378`@`%`
REVOKE SENSITIVE_VARIABLES_OBSERVER ON *.* FROM root@localhost;
# restart:--upgrade=FORCE
# Must have SENSITIVE_VARIABLES_OBSERVER privilege
SHOW GRANTS for u34068378;
Grants for u34068378@%
GRANT USAGE ON *.* TO `u34068378`@`%`
GRANT SENSITIVE_VARIABLES_OBSERVER,SYSTEM_VARIABLES_ADMIN ON *.* TO `u34068378`@`%`
SHOW GRANTS for root@localhost;
Grants for root@localhost
GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, RELOAD, SHUTDOWN, PROCESS, FILE, REFERENCES, INDEX, ALTER, SHOW DATABASES, SUPER, CREATE TEMPORARY TABLES, LOCK TABLES, EXECUTE, REPLICATION SLAVE, REPLICATION CLIENT, CREATE VIEW, SHOW VIEW, CREATE ROUTINE, ALTER ROUTINE, CREATE USER, EVENT, TRIGGER, CREATE TABLESPACE, CREATE ROLE, DROP ROLE ON *.* TO `root`@`localhost` WITH GRANT OPTION
GRANT APPLICATION_PASSWORD_ADMIN,AUDIT_ABORT_EXEMPT,AUDIT_ADMIN,BACKUP_ADMIN,BINLOG_ADMIN,BINLOG_ENCRYPTION_ADMIN,CLONE_ADMIN,CONNECTION_ADMIN,ENCRYPTION_KEY_ADMIN,FIREWALL_EXEMPT,FLUSH_OPTIMIZER_COSTS,FLUSH_STATUS,FLUSH_TABLES,FLUSH_USER_RESOURCES,GROUP_REPLICATION_ADMIN,GROUP_REPLICATION_STREAM,INNODB_REDO_LOG_ARCHIVE,INNODB_REDO_LOG_ENABLE,PASSWORDLESS_USER_ADMIN,PERSIST_RO_VARIABLES_ADMIN,REPLICATION_APPLIER,REPLICATION_SLAVE_ADMIN,RESOURCE_GROUP_ADMIN,RESOURCE_GROUP_USER,ROLE_ADMIN,SENSITIVE_VARIABLES_OBSERVER,SERVICE_CONNECTION_ADMIN,SESSION_VARIABLES_ADMIN,SET_USER_ID,SHOW_ROUTINE,SYSTEM_USER,SYSTEM_VARIABLES_ADMIN,TABLE_ENCRYPTION_ADMIN,XA_RECOVER_ADMIN ON *.* TO `root`@`localhost` WITH GRANT OPTION
GRANT PROXY ON ``@`` TO `root`@`localhost` WITH GRANT OPTION
DROP USER u34068378;

End of tests
