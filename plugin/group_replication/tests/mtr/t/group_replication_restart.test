############################################################
# Verify that when Group Replication is used, on server
# start the certifier's sequence number is loaded from the
# relay log (already certified transactions, if any) and from
# GTID_EXECUTED (applied transactions).
############################################################
--source include/have_debug.inc
--source include/have_group_replication_plugin.inc

--let $use_gtids=1
--let $wait_for_executed_gtid_set=1
--let $group_replication_group_name= 8a94f357-aab4-11df-86ab-c80aa9429576

--echo ############################################################
--echo # 1. Start servers, on which server2 has applier stopped so
--echo # that all remote transactions are only queued on relay log.
--echo # Execute some transactions on server1.
--connection server1
--source include/start_group_replication.inc

--connection server2
# Do not apply certified remote transactions.
SET @@GLOBAL.DEBUG= '+d,group_replication_do_not_start_applier_thread';
--source include/start_group_replication.inc

--connection server1
--let $group_replication_number_of_members= 2
--source ../inc/group_replication_wait_for_number_of_members.inc
CREATE TABLE t1 (c1 INT NOT NULL PRIMARY KEY) ENGINE=InnoDB;
INSERT INTO t1 VALUES (1);

--echo
--echo ############################################################
--echo # 2. Restart server2 and verify that certifier sequence
--echo # number is set from relay log certified transactions.
--connection server2
# Wait until server receives and certify the transactions.
--let $wait_condition= SELECT (Count_transactions_checked - Count_conflicts_detected) = 2 from performance_schema.replication_group_member_stats
--source include/wait_condition.inc

if (!$success)
{
  --die Timeout in wait_condition.inc
}

--source include/restart_mysqld.inc
SET @@GLOBAL.DEBUG= '+d,certifier_assert_next_seqno_equal_3';
--source include/start_group_replication.inc


--echo ############################################################
--echo # 3. Insert must fail with duplicate entry.
--error ER_DUP_ENTRY
INSERT INTO t1 VALUES (1);

INSERT INTO t1 VALUES (2);

--echo
--echo ############################################################
--echo # 4. Restart server2 again and verify that certifier sequence
--echo # number is set from GTID_EXECUTED.
# Retrieved gtids goes back to 0 as the server removes old relay logs. This is
# triggered by STOP log events written to the relay log on restarts. (Step 2.)
--source include/restart_mysqld.inc
SET @debug_saved= @@GLOBAL.DEBUG;
SET @@GLOBAL.DEBUG= '+d,certifier_assert_next_seqno_equal_4';
--source include/start_group_replication.inc

--echo
--echo ############################################################
--echo # 5. Shutdown.

--connection server1
--let $group_replication_number_of_members= 2
--source ../inc/group_replication_wait_for_number_of_members.inc
DROP TABLE t1;

--let $sync_slave_connection= server2
--source include/sync_slave_sql_with_master.inc

--connection server1
--source include/stop_group_replication.inc
RESET SLAVE ALL FOR CHANNEL "group_replication_applier";
RESET MASTER;

--connection server2
SET @@GLOBAL.DEBUG= @debug_saved;
--source include/stop_group_replication.inc
RESET SLAVE ALL FOR CHANNEL "group_replication_applier";
RESET MASTER;
